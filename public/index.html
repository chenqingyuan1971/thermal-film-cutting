<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç»ç’ƒéš”çƒ­è†œè£åˆ‡ä¼˜åŒ–ç³»ç»Ÿ V3.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="/js/app.js"></script>
    <style>
        :root {
            --primary-red: #BA1B25;
            --primary-red-dark: #8B1419;
            --secondary-gray: #373737;
            --aux-light-blue: #f8f9fa;
            --aux-deep-blue: #f8f9fa;
            --aux-light-tan: #f8f9fa;
            --aux-smoke-gray: #6c757d;
            --aux-pale-gray: #e9ecef;
        }
        
        .bg-primary-red { background: var(--primary-red); }
        .bg-primary-gradient { background: linear-gradient(to right, var(--primary-red), var(--primary-red-dark)); }
        .text-primary-red { color: var(--primary-red); }
        .border-primary-red { border-color: var(--primary-red); }
        .bg-light-blue { background: var(--aux-light-blue); }
        .bg-deep-blue { background: var(--aux-deep-blue); }
        .bg-light-tan { background: var(--aux-light-tan); }
        .bg-smoke-gray { background: var(--aux-smoke-gray); }
        .bg-pale-gray { background: var(--aux-pale-gray); }
        .border-light-blue { border-color: var(--aux-light-blue); }
        .border-deep-blue { border-color: var(--aux-deep-blue); }
        .border-light-tan { border-color: var(--aux-light-tan); }
        .text-light-blue-dark { color: #495057; }
        .text-deep-blue-dark { color: #495057; }
        .text-light-tan-dark { color: #495057; }
        .btn-primary:hover { background: var(--primary-red-dark); }
        .btn-secondary:hover { background: var(--aux-smoke-gray); }
        .btn-tan:hover { background: #c9b189; }
        .input-focus:focus { border-color: var(--primary-red); outline: none; }
        .bg-vi-gradient { 
            background: #f5f5f5; 
        }
        
        /* Logoå¡ç‰‡æ ·å¼ */
        .logo-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }
        
        .logo-placeholder {
            width: 120px;
            height: 120px;
            border: none;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            flex-shrink: 0;
        }
        
        .logo-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .company-info {
            text-align: center;
        }
        
        .company-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-red);
            margin-bottom: 0.3rem;
        }
        
        .company-subtitle {
            font-size: 1.5rem;
            color: #999;
            letter-spacing: 0.1em;
        }
        
        /* ç»ç’ƒåˆ—è¡¨æ»šåŠ¨å®¹å™¨æ ·å¼ */
        #glassList {
            display: block !important;
            max-height: 500px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-red) #f1f1f1;
        }
        
        /* Webkitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ - ç«–å‘ */
        #glassList::-webkit-scrollbar {
            width: 12px;
        }
        
        #glassList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        #glassList::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }
        
        #glassList::-webkit-scrollbar-thumb:hover {
            background: var(--primary-red-dark);
        }
        
        /* æ»šåŠ¨å®¹å™¨å†…éƒ¨è¡¨æ ¼çš„æ¨ªå‘æ»šåŠ¨æ¡ */
        #glassList .overflow-x-auto {
            overflow-x: auto !important;
            overflow-y: visible !important;
            scrollbar-width: thin;
            scrollbar-color: #999 #f1f1f1;
            padding-bottom: 4px;
        }
        
        #glassList .overflow-x-auto::-webkit-scrollbar {
            height: 12px;
        }
        
        #glassList .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        #glassList .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }
        
        #glassList .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– - å¢å¼ºç‰ˆ */
        @media (max-width: 768px) {
            /* åŸºç¡€å­—ä½“å’Œé—´è·è°ƒæ•´ */
            body {
                font-size: 14px;
                -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
                -webkit-tap-highlight-color: rgba(186, 27, 37, 0.1); /* è§¦æ‘¸é«˜äº® */
            }
            
            /* å®¹å™¨paddingè°ƒæ•´ */
            .max-w-7xl {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            /* æ ‡é¢˜å°ºå¯¸ */
            h1 {
                font-size: 1.5rem !important;
                line-height: 1.3 !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
                line-height: 1.3 !important;
            }
            
            h3 {
                font-size: 1.1rem !important;
                line-height: 1.3 !important;
            }
            
            /* Logoå¡ç‰‡ç§»åŠ¨ç«¯è°ƒæ•´ */
            .logo-card {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }
            
            .logo-placeholder {
                width: 60px;
                height: 60px;
            }
            
            .company-name {
                font-size: 1.2rem;
            }
            
            .company-subtitle {
                font-size: 1.1rem;
            }
            
            /* è¾“å…¥æ¡†ä¼˜åŒ– - å¢å¤§è§¦æ‘¸åŒºåŸŸå¹¶é˜²æ­¢iOSç¼©æ”¾ */
            input[type="text"],
            input[type="number"],
            input[type="tel"],
            select,
            textarea {
                min-height: 44px !important;
                font-size: 16px !important; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                padding: 0.75rem !important;
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* æ•°å­—è¾“å…¥æ¡†ç‰¹æ®Šå¤„ç† */
            input[type="number"] {
                -moz-appearance: textfield;
            }
            
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            
            /* æŒ‰é’®ä¼˜åŒ– - ç¡®ä¿è¶³å¤Ÿçš„è§¦æ‘¸åŒºåŸŸ */
            button {
                min-height: 44px !important;
                padding: 0.75rem 1rem !important;
                font-size: 14px !important;
                touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸å“åº” */
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* å°æŒ‰é’®ä¹Ÿè¦ä¿è¯æœ€å°è§¦æ‘¸å°ºå¯¸ */
            button.text-xs,
            button.text-sm {
                min-height: 40px !important;
                padding: 0.5rem 0.75rem !important;
            }
            
            /* è¡¨æ ¼å•å…ƒæ ¼ */
            table th, table td {
                padding: 0.5rem 0.25rem !important;
                font-size: 0.75rem !important;
                white-space: nowrap;
            }
            
            /* ç»Ÿè®¡å¡ç‰‡ - 2åˆ—æ˜¾ç¤º */
            #totalStats {
                padding: 1rem !important;
            }
            
            #totalStats .grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }
            
            #totalStats .bg-gray-200 {
                padding: 0.5rem !important;
                min-height: 80px;
            }
            
            #totalStats .font-bold {
                font-size: 1.2rem !important;
            }
            
            /* äº§å“åˆ†ç±»ç»Ÿè®¡ - 2åˆ—æ˜¾ç¤º */
            #productStats {
                padding: 1rem !important;
            }
            
            #productStats .grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }
            
            #productStats .border-4 {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                border-width: 3px !important;
            }
            
            /* LogoåŒºåŸŸ */
            .logo-container {
                flex-direction: column !important;
                gap: 0.5rem !important;
                text-align: center !important;
            }
            
            /* ä¸»æ ‡é¢˜å¡ç‰‡ */
            .bg-primary-gradient {
                padding: 1.5rem 1rem !important;
            }
            
            /* ç»ç’ƒåˆ—è¡¨å®¹å™¨ */
            #glassList {
                max-height: 400px !important;
                -webkit-overflow-scrolling: touch;
            }
            
            /* æ»šåŠ¨æ¡åœ¨ç§»åŠ¨ç«¯å˜ç»† */
            #glassList::-webkit-scrollbar {
                width: 6px;
            }
            
            #glassList .overflow-x-auto::-webkit-scrollbar {
                height: 6px;
            }
            
            /* æ–¹æ¡ˆé€‰æ‹©å¡ç‰‡ */
            #sixPlansDisplay {
                grid-template-columns: repeat(1, 1fr) !important;
            }
            
            /* æ¨¡æ€æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #planModal > div {
                width: 95% !important;
                max-width: 95% !important;
                margin: 0.5rem !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
                padding: 1rem !important;
            }
            
            #planModal .space-y-4 {
                max-height: 60vh !important;
                overflow-y: auto !important;
            }
            
            /* åº•éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸ */
            .flex.gap-2,
            .flex.gap-3,
            .flex.gap-4 {
                flex-wrap: wrap;
                gap: 0.5rem !important;
            }
            
            .flex.gap-3 button {
                flex: 1 1 auto;
                min-width: calc(50% - 0.25rem);
            }
            
            /* éšè—æ‰“å°æŒ‰é’®åœ¨ç§»åŠ¨ç«¯ */
            button[onclick*="printReport"] {
                display: none !important;
            }
            
            /* SVGç¤ºæ„å›¾ */
            svg {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* å¡ç‰‡å†…è¾¹è·ä¼˜åŒ– */
            .rounded-2xl,
            .p-6,
            .p-8 {
                padding: 1rem !important;
            }
            
            /* è¡¨å•ç½‘æ ¼å¸ƒå±€ */
            .grid.gap-4 {
                gap: 0.75rem !important;
            }
            
            /* ç½‘æ ¼å¸ƒå±€è‡ªåŠ¨è°ƒæ•´ */
            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
            }
            
            .md\:grid-cols-3,
            .lg\:grid-cols-6 {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            
            /* é—´è·è°ƒæ•´ */
            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }
            
            .space-y-4 > * + * {
                margin-top: 0.75rem !important;
            }
            
            /* å“åº”å¼æ–‡å­—å¤§å° */
            .text-xl {
                font-size: 1.1rem !important;
            }
            
            .text-2xl {
                font-size: 1.3rem !important;
            }
            
            .text-3xl {
                font-size: 1.5rem !important;
            }
            
            /* å¼ºåˆ¶è¦†ç›–å¡ç‰‡é—´è· */
            .logo-card {
                margin-bottom: 0.25rem !important; /* ä¸ä¸‹æ–¹å¡ç‰‡çš„é—´è· */
            }
            
            .bg-primary-gradient {
                margin-bottom: 0.25rem !important; /* ä¸ä¸‹æ–¹å¡ç‰‡çš„é—´è· */
            }
            
            .bg-white.rounded-2xl {
                margin-bottom: 0.25rem !important; /* æ‰€æœ‰ç™½è‰²å¡ç‰‡ä¸ä¸‹æ–¹çš„é—´è· */
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– (iPhone SEç­‰, <375px) */
        @media (max-width: 375px) {
            body {
                font-size: 13px;
            }
            
            .max-w-7xl {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            h1 {
                font-size: 1.25rem !important;
            }
            
            h2 {
                font-size: 1.1rem !important;
            }
            
            .company-name {
                font-size: 1.1rem;
            }
            
            .company-subtitle {
                font-size: 1rem;
            }
            
            button {
                font-size: 13px !important;
                padding: 0.6rem 0.75rem !important;
            }
            
            .grid > div {
                padding: 0.75rem !important;
            }
            
            #glassList table {
                font-size: 12px;
            }
            
            /* ç»Ÿè®¡å¡ç‰‡æ ‡é¢˜å­—å· */
            #totalStats .text-xs,
            #productStats .font-semibold {
                font-size: 0.65rem !important;
            }
            
            /* ç»Ÿè®¡æ•°å€¼å­—å· */
            #totalStats .font-bold,
            #productStats .font-bold {
                font-size: 1.1rem !important;
            }
            
            /* Logo */
            .logo-icon {
                width: 50px !important;
                height: 50px !important;
            }
            
            /* ä¸»æ ‡é¢˜ */
            .main-title {
                font-size: 1.2rem !important;
            }
            
            /* è¾“å…¥åŒºåŸŸç½‘æ ¼ */
            .grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, 1fr) !important;
            }
            
            /* å¿«æ·æŒ‰é’® */
            .quick-action-buttons {
                flex-wrap: wrap !important;
            }
            
            .quick-action-buttons button {
                flex: 1 1 45% !important;
                min-width: 45% !important;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            #glassList {
                max-height: 300px !important;
            }
            
            #planModal > div {
                max-height: 85vh !important;
            }
            
            .logo-card {
                flex-direction: row !important;
                gap: 1rem;
            }
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– - é’ˆå¯¹è§¦æ‘¸å±è®¾å¤‡ */
        @media (hover: none) and (pointer: coarse) {
            /* å¢å¤§æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ çš„æœ€å°å°ºå¯¸ */
            button, a, input, select {
                min-height: 48px;
            }
            
            /* ç§»é™¤hoveræ•ˆæœï¼ˆè§¦æ‘¸å±ä¸éœ€è¦ï¼‰ */
            button:hover, a:hover {
                transform: none !important;
                opacity: 1 !important;
            }
            
            /* æ·»åŠ è§¦æ‘¸åé¦ˆ - æŒ‰ä¸‹æ—¶çš„è§†è§‰åé¦ˆ */
            button:active, a:active {
                opacity: 0.7;
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            /* è¾“å…¥æ¡†ç„¦ç‚¹ä¼˜åŒ– */
            input:focus,
            select:focus,
            textarea:focus {
                border-color: var(--primary-red);
                box-shadow: 0 0 0 3px rgba(186, 27, 37, 0.1);
            }
        }
        
        /* å…¨å±€å¼ºåˆ¶è¦†ç›–å¡ç‰‡é—´è· - å¯¹æ‰€æœ‰å±å¹•å°ºå¯¸ç”Ÿæ•ˆ */
        .logo-card {
            margin-bottom: 0.5rem !important;
        }
        
        .container > .bg-primary-gradient,
        .container > .bg-white.rounded-2xl {
            margin-bottom: 0.5rem !important;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            /* æ‰“å°æ—¶éšè—æ»šåŠ¨æ¡ */
            #glassList,
            #glassList .overflow-x-auto {
                overflow: visible !important;
                max-height: none !important;
            }
            
            /* æ‰€æœ‰é¡µé¢æ¨ªå‘æ‰“å°ï¼Œå¹¶éšè—é¡µçœ‰é¡µè„š */
            @page {
                size: A4 landscape;
                margin: 10mm;
                /* éšè—é¡µçœ‰é¡µè„š */
                margin-top: 0;
                margin-bottom: 0;
            }
            
            /* é¦–é¡µ */
            @page :first {
                margin-top: 10mm;
            }
            
            /* é‡ç½®body */
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                /* ç¡®ä¿å†…å®¹ä»é¡¶éƒ¨å¼€å§‹ */
                padding-top: 0 !important;
            }
            
            /* éšè—æ‰€æœ‰éæ‰“å°å†…å®¹ */
            body > *:not(.print-section) {
                display: none !important;
            }
            
            /* æ˜¾ç¤ºæ‰“å°åŒºåŸŸ */
            .print-section {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .print-section * {
                visibility: visible !important;
            }
            
            /* è¡¨æ ¼å…ƒç´  */
            .print-section table {
                display: table !important;
                width: 100% !important;
            }
            
            .print-section thead {
                display: table-header-group !important;
            }
            
            .print-section tbody {
                display: table-row-group !important;
            }
            
            .print-section tr {
                display: table-row !important;
            }
            
            .print-section th,
            .print-section td {
                display: table-cell !important;
            }
            
            /* flexå’Œgridå¸ƒå±€ - é‡è¦ï¼ */
            .print-section .print-flex {
                display: flex !important;
            }
            
            .print-section .print-grid {
                display: grid !important;
            }
            
            /* SVG */
            .print-section svg {
                display: inline-block !important;
            }
            
            /* ç¬¬1é¡µï¼šé¡¹ç›®è¯¦æƒ… - ä¸¥æ ¼æ§åˆ¶é«˜åº¦ */
            .print-page-1 {
                page-break-after: always !important;
                page-break-inside: avoid !important;
                max-height: 170mm !important;
                overflow: hidden !important;
            }
            
            /* ç¬¬2é¡µï¼šç»Ÿè®¡ */
            .print-page-stats {
                page-break-before: always !important;
                page-break-after: always !important;
            }
            
            /* äº§å“åˆ†ç±»å¡ç‰‡ - é¿å…åˆ†é¡µæ–­è£‚ */
            .print-product-card {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
                margin-bottom: 8px !important;
                padding: 0.7rem !important;
            }
            
            /* æ‰“å°æ—¶äº§å“åˆ†ç±»ç»Ÿè®¡å¡ç‰‡å†…å®¹ç´§å‡‘åŒ– */
            .print-product-card h3 {
                font-size: 0.9rem !important;
                margin-bottom: 0.4rem !important;
            }
            
            .print-product-card h3 span:first-child {
                padding: 0.3rem 0.6rem !important;
                font-size: 0.85rem !important;
            }
            
            .print-product-card h3 span:last-child {
                font-size: 0.85rem !important;
            }
            
            .print-product-card .grid {
                gap: 0.3rem !important;
            }
            
            .print-product-card .bg-gray-200 {
                padding: 0.4rem !important;
            }
            
            .print-product-card .bg-gray-200 div:first-child {
                font-size: 0.6rem !important;
                margin-bottom: 0.2rem !important;
            }
            
            .print-product-card .bg-gray-200 div:last-child {
                font-size: 1rem !important;
            }
            
            .print-product-card .bg-gray-200 div:last-child span {
                font-size: 0.7rem !important;
            }
            
            /* ç¬¬3é¡µï¼šè¯¦ç»†è¡¨æ ¼ */
            .print-page-details {
                page-break-before: always !important;
            }
            
            .print-page-details table {
                page-break-inside: auto !important;
            }
            
            .print-page-details tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            
            .print-page-details thead {
                display: table-header-group !important;
            }
            
            /* ç¡®ä¿é¢œè‰²æ˜¾ç¤º */
            * {
                color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:0px}.bottom-0{bottom:0px}.top-0{top:0px}.right-3{right:0.75rem}.top-3{top:0.75rem}.z-10{z-index:10}.z-50{z-index:50}.mx-auto{margin-left:auto;margin-right:auto}.my-4{margin-top:1rem;margin-bottom:1rem}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-1{margin-left:0.25rem}.mr-2{margin-right:0.5rem}.mr-3{margin-right:0.75rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-10{height:2.5rem}.h-5{height:1.25rem}.h-8{height:2rem}.h-4{height:1rem}.h-6{height:1.5rem}.max-h-\[95vh\]{max-height:95vh}.min-h-screen{min-height:100vh}.w-10{width:2.5rem}.w-5{width:1.25rem}.w-8{width:2rem}.w-full{width:100%}.w-4{width:1rem}.w-6{width:1.5rem}.min-w-0{min-width:0px}.max-w-7xl{max-width:80rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.border-collapse{border-collapse:collapse}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-wrap{flex-wrap:wrap}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-8{gap:2rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.rounded-2xl{border-radius:1rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded-full{border-radius:9999px}.rounded-t-2xl{border-top-left-radius:1rem;border-top-right-radius:1rem}.border{border-width:1px}.border-2{border-width:2px}.border-4{border-width:4px}.border-l-4{border-left-width:4px}.border-t-2{border-top-width:2px}.border-b{border-bottom-width:1px}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-yellow-500{--tw-border-opacity:1;border-color:rgb(234 179 8 / var(--tw-border-opacity, 1))}.border-red-400{--tw-border-opacity:1;border-color:rgb(248 113 113 / var(--tw-border-opacity, 1))}.border-yellow-400{--tw-border-opacity:1;border-color:rgb(250 204 21 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-orange-100{--tw-bg-opacity:1;background-color:rgb(255 237 213 / var(--tw-bg-opacity, 1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195 / var(--tw-bg-opacity, 1))}.bg-opacity-50{--tw-bg-opacity:0.5}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.px-10{padding-left:2.5rem;padding-right:2.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-8{padding-top:2rem;padding-bottom:2rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-1\.5{padding-top:0.375rem;padding-bottom:0.375rem}.pt-4{padding-top:1rem}.text-left{text-align:left}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-gray-800{display:none;}.text-gray-800{--tw-text-opacity:1;color:rgb(133 77 14 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(194 65 12 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28 / var(--tw-text-opacity, 1))}.text-gray-700{display:none;}.text-gray-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.opacity-90{opacity:0.9}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.hover\:opacity-80:hover{opacity:0.8}.hover\:opacity-90:hover{opacity:0.9}.hover\:shadow-md:hover{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.hover\:shadow-lg:hover{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}@media (min-width: 768px){.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.md\:grid-cols-5{grid-template-columns:repeat(5, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}}@media (min-width: 1024px){.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.lg\:grid-cols-7{grid-template-columns:repeat(7, minmax(0, 1fr))}.lg\:grid-cols-6{grid-template-columns:repeat(6, minmax(0, 1fr))}}</style>
</head>
<body class="bg-vi-gradient min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼šè®¤è¯çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="fixed top-0 right-3 z-50" id="userNav">
        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div id="authNavGuest" class="flex items-center gap-3">
            <button onclick="showAuthModal('login')" class="bg-white text-primary-red font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 transition">
                ç™»å½•
            </button>
            <button onclick="showAuthModal('register')" class="bg-primary-red text-white font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-primary-red-dark transition">
                æ³¨å†Œ
            </button>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€ -->
        <div id="authNavUser" class="hidden flex items-center gap-3">
            <button onclick="showSaveModal()" class="bg-white text-primary-red font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                </svg>
                ä¿å­˜é¡¹ç›®
            </button>
            <button onclick="showHistoryModal()" class="bg-white text-primary-red font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-gray-50 transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                å†å²è®°å½•
            </button>
            <div class="relative group">
                <button class="bg-primary-red text-white font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-primary-red-dark transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span id="userDisplayName">ç”¨æˆ·</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <!-- ä¸‹æ‹‰èœå• -->
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden group-hover:block">
                    <div class="py-1">
                        <button onclick="logoutUser()" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">
                            é€€å‡ºç™»å½•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notificationContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- æ–°å¢ï¼šLogoå’Œå…¬å¸ä¿¡æ¯å¡ç‰‡ -->
        <div class="logo-card mb-4">
            <div class="logo-placeholder">
                <img src="company_logo.png" alt="company_logo">
            </div>
            <div class="company-info">
                <div class="company-name">TECH X å¤ªç§‘æ–¯ç»ç’ƒéš”çƒ­è†œ</div>
                <div class="company-subtitle">æ— è¾¹ç•Œæ–°ææ–™ç§‘æŠ€</div>
            </div>
        </div>
        
        <!-- åŸæœ‰çš„ä¸»æ ‡é¢˜å¡ç‰‡ -->
        <div class="bg-primary-gradient rounded-2xl shadow-2xl p-8 mb-8 text-white">
            <div class="flex items-center justify-center mb-2 logo-container">
                <svg class="w-10 h-10 mr-3 logo-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <h1 class="text-4xl font-bold main-title">ç»ç’ƒéš”çƒ­è†œæ™ºèƒ½è£åˆ‡ä¼˜åŒ–ç³»ç»Ÿ</h1>
            </div>
            <p class="text-center text-lg opacity-90"> æ™ºèƒ½æ’å¸ƒ + ä½™æ–™å¤ç”¨ + å…¨å±€ä¼˜åŒ– </p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: var(--primary-red);">
                <span class="mr-2">ğŸ“‹</span> é¡¹ç›®è¯¦æƒ…
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">é¡¹ç›®åç§°</label>
                    <input type="text" id="projectName" placeholder="å¦é—¨æ¹–æ»¨ä¸­å¿ƒ24301æ ‹èŠ‚èƒ½æ”¹é€ å·¥ç¨‹" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">ä¸šä¸»å§“å</label>
                    <input type="text" id="ownerName" placeholder="é™ˆå¥³å£«" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">è”ç³»æ–¹å¼</label>
                    <input type="text" id="contactPhone" placeholder="13888888888" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">é¡¹ç›®åœ°å€</label>
                    <input type="text" id="projectAddress" placeholder="å¦é—¨æ¹–æ»¨ä¸­å¿ƒ24301æ ‹æ¥¼å†…" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: var(--primary-red);">
                <span class="mr-2">ğŸ”§</span> ç»ç’ƒä¿¡æ¯å½•å…¥
            </h2>
            
            <div class="bg-light-blue border-2 border-light-blue rounded-xl p-4 mb-4">
                <h3 class="text-lg font-bold mb-3 text-light-blue-dark">ğŸ¢ æ¥¼å±‚ä¿¡æ¯</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">æ¥¼å±‚</label>
                        <select id="glassFloor" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                            <option value="">-- é€‰æ‹©æ¥¼å±‚ --</option>
                            <option value="åœ°ä¸‹å®¤">åœ°ä¸‹å®¤</option>
                            <option value="ä¸€æ¥¼">ä¸€æ¥¼</option>
                            <option value="äºŒæ¥¼">äºŒæ¥¼</option>
                            <option value="ä¸‰æ¥¼">ä¸‰æ¥¼</option>
                            <option value="å››æ¥¼">å››æ¥¼</option>
                            <option value="äº”æ¥¼">äº”æ¥¼</option>
                            <option value="é˜³å…‰æˆ¿">é˜³å…‰æˆ¿</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">åœºæ™¯åŒºåŸŸ</label>
                        <select id="glassRoom" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                            <option value="">-- é€‰æ‹©åŒºåŸŸ --</option>
                            <option value="å®¢å…">å®¢å…</option>
                            <option value="é¤å…">é¤å…</option>
                            <option value="å¨æˆ¿">å¨æˆ¿</option>
                            <option value="ä¸»å§">ä¸»å§</option>
                            <option value="å®¢å§">å®¢å§</option>
                            <option value="ä¹¦æˆ¿">ä¹¦æˆ¿</option>
                            <option value="å«ç”Ÿé—´">å«ç”Ÿé—´</option>
                            <option value="é˜³å°">é˜³å°</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="bg-white border-2 border-gray-200 rounded-xl p-4 mb-4">
                <h3 class="text-lg font-bold mb-3 text-deep-blue-dark">ğŸªŸ çª—æˆ·ä¿¡æ¯</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">çª—æˆ·ç¼–å· <span style="color: var(--primary-red);">*</span></label>
                        <input type="text" id="glassWindowId" placeholder="ä¾‹å¦‚:è¥¿çª—1" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">æœå‘</label>
                        <select id="glassDirection" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                            <option value="">-- é€‰æ‹©æœå‘ --</option>
                            <option value="ä¸œ">ä¸œ</option>
                            <option value="å—">å—</option>
                            <option value="è¥¿">è¥¿</option>
                            <option value="åŒ—">åŒ—</option>
                            <option value="ä¸œå—">ä¸œå—</option>
                            <option value="ä¸œåŒ—">ä¸œåŒ—</option>
                            <option value="è¥¿å—">è¥¿å—</option>
                            <option value="è¥¿åŒ—">è¥¿åŒ—</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="bg-white border-2 border-gray-200 rounded-xl p-4 mb-4">
                <h3 class="text-lg font-bold mb-3 text-light-tan-dark">ğŸ“ ç»ç’ƒå°ºå¯¸ä¸äº§å“</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">å®½åº¦(mm) <span style="color: var(--primary-red);">*</span></label>
                        <input type="number" id="glassWidth" placeholder="ç»ç’ƒå®½åº¦" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">é«˜åº¦(mm) <span style="color: var(--primary-red);">*</span></label>
                        <input type="number" id="glassHeight" placeholder="ç»ç’ƒé«˜åº¦" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">æ‹Ÿç”¨äº§å“ <span style="color: var(--primary-red);">*</span></label>
                        <select id="glassProduct" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                            <option value="">-- é€‰æ‹©äº§å“ --</option>
                            <option value="æ™¨æ›¦">æ™¨æ›¦</option>
                            <option value="æš®è¯­">æš®è¯­</option>
                            <option value="æ™ºå¹•Pro30">æ™ºå¹•Pro30</option>
                            <option value="æ™ºå¹•Pro70">æ™ºå¹•Pro70</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">ç‰‡æ•°</label>
                        <input type="number" id="glassQuantity" placeholder="æ•°é‡" value="1" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    
                    <div class="flex items-end gap-2">
                        <button id="addGlassBtn" onclick="addGlass()" class="flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition">â• æ·»åŠ </button>
                        <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-primary-red text-white font-bold py-2 px-6 rounded-lg transition hover:bg-primary-red-dark whitespace-nowrap">
                            âœ–ï¸ å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                <!-- æ•°æ®å¯¼å…¥åŒºåŸŸ -->
                <div class="mb-4">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--secondary-gray);">ğŸ“¥ å¿«é€Ÿå¯¼å…¥æ•°æ®</h4>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="showImportModal()" style="background-color: #16a34a; color: white;" class="px-4 py-2 rounded-lg transition text-sm hover:opacity-90">
                            ğŸ“‹ ç²˜è´´è¡¨æ ¼æ•°æ®
                        </button>
                        <label style="background-color: #2563eb; color: white;" class="px-4 py-2 rounded-lg transition text-sm hover:opacity-90 cursor-pointer inline-flex items-center">
                            ğŸ“ å¯¼å…¥Excel/CSV
                            <input type="file" accept=".xlsx,.xls,.csv" onchange="handleFileImport(event)" class="hidden">
                        </label>
                        <button onclick="downloadTemplate()" style="background-color: #6b7280; color: white;" class="px-4 py-2 rounded-lg transition text-sm hover:opacity-90">
                            ğŸ“„ ä¸‹è½½å¯¼å…¥æ¨¡æ¿
                        </button>
                    </div>
                </div>
                
                <div class="border-t-2 border-gray-300 my-4"></div>
                
                <!-- ç¤ºä¾‹æ•°æ® -->
                <div class="mb-4">
                    <h4 class="text-sm font-bold mb-3" style="color: var(--secondary-gray);">ğŸ“‹ ç¤ºä¾‹æ•°æ®</h4>
                    <div class="flex flex-wrap gap-3 quick-action-buttons">
                        <button onclick="loadExample1()" class="bg-primary-red text-white px-4 py-2 rounded-lg transition text-sm hover:bg-primary-red-dark">
                            ğŸ“‹ æ¡ˆä¾‹1
                        </button>
                        <button onclick="loadExample2()" class="bg-primary-red text-white px-4 py-2 rounded-lg transition text-sm hover:bg-primary-red-dark">
                            ğŸ“‹ æ¡ˆä¾‹2
                        </button>
                        <button onclick="loadExample3()" class="bg-primary-red text-white px-4 py-2 rounded-lg transition text-sm hover:bg-primary-red-dark">
                            ğŸ“‹ æ¡ˆä¾‹3
                        </button>
                        <button onclick="loadTestCase()" class="bg-primary-red text-white px-4 py-2 rounded-lg transition text-sm hover:bg-primary-red-dark">
                            ğŸ§ª æµ‹è¯•æ¡ˆä¾‹
                        </button>
                    </div>
                </div>
                
                <div class="border-t-2 border-gray-300 my-4"></div>

                <div id="glassList" class="border-2 border-gray-200 rounded-lg p-2 mb-6" style="box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);">
                    <div class="text-center text-gray-400 py-8">æš‚æ— ç»ç’ƒæ•°æ®</div>
                </div>

                <div class="flex gap-3">
                    <button onclick="clearAll()" class="bg-primary-red btn-primary text-white font-bold py-3 px-6 rounded-lg transition shadow-lg">
                        ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
                    </button>
                    <button onclick="runOptimization()" class="flex-1 bg-primary-gradient text-white font-bold py-3 px-8 rounded-lg transition shadow-lg hover:opacity-90">
                        ğŸš€ æ‰§è¡Œä¼˜åŒ–ç®—æ³•
                    </button>
                    <button onclick="exportPDF()" class="bg-primary-red text-white font-bold py-3 px-6 rounded-lg transition shadow-lg hover:bg-primary-red-dark">
                        ğŸ“„ å¯¼å‡ºPDFæŠ¥å‘Š
                    </button>
                    <button onclick="printReport()" class="bg-primary-red text-white font-bold py-3 px-6 rounded-lg transition shadow-lg hover:bg-primary-red-dark">
                        ğŸ–¨ï¸ æ‰“å°æŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>

        <div id="planSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-[95vh] overflow-y-auto">
                <div class="sticky top-0 bg-primary-red text-white p-6 rounded-t-2xl z-10">
                    <h2 class="text-2xl font-bold text-center">è†œæå¸ƒå±€æ–¹æ¡ˆé€‰æ‹©</h2>
                </div>
                
                <div class="p-6">
                    <div class="bg-gray-50 border-l-4 border-gray-400 p-5 mb-6 rounded-lg">
                        <h3 class="text-xl font-bold text-center" style="color: var(--secondary-gray);">è¶…è§„ç»ç’ƒè†œæå¸ƒå±€æ–¹æ¡ˆ</h3>
                        <div class="text-center">
                            <p id="currentGlassInfo" class="font-medium mb-1" style="color: var(--secondary-gray);">ç»ç’ƒè§„æ ¼:2200Ã—3200mm | çª—æˆ·:A5 | äº§å“:æš®è¯­</p>
                            <p class="text-sm" style="color: var(--aux-smoke-gray);">è†œå¹…å®½:1520mm | å½“å‰å·²é€‰æ–¹æ¡ˆ,å¯é‡æ–°é€‰æ‹©</p>
                        </div>
                    </div>
                    
                    <div id="sixPlansDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    </div>
                    
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-bold mb-3" style="color: var(--secondary-gray);">å›¾ä¾‹è¯´æ˜:</h4>
                        <div class="flex gap-8 text-sm items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded" style="background: #e8f5e9; border: 2px solid #27ae60;"></div>
                                <span class="font-medium" style="color: var(--secondary-gray);">ç»ç’ƒåŒºåŸŸ(å¤–æ¡†)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg width="40" height="20">
                                    <line x1="0" y1="10" x2="40" y2="10" stroke="#e74c3c" stroke-width="2" stroke-dasharray="4,3"/>
                                </svg>
                                <span class="font-medium" style="color: var(--secondary-gray);">æ‹¼æ¥ç¼ä½ç½®</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg width="40" height="20">
                                    <line x1="10" y1="10" x2="30" y2="10" stroke="#27ae60" stroke-width="2"/>
                                    <path d="M 10 10 L 16 7 M 10 10 L 16 13" stroke="#27ae60" stroke-width="2"/>
                                    <path d="M 30 10 L 24 7 M 30 10 L 24 13" stroke="#27ae60" stroke-width="2"/>
                                </svg>
                                <span class="font-medium" style="color: var(--secondary-gray);">è†œææ–¹å‘</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 border-l-4 border-gray-400 p-4 mb-4 rounded">
                        <p class="text-gray-800 text-sm flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">æç¤º:é‡æ–°é€‰æ‹©æ–¹æ¡ˆå°†è¦†ç›–å½“å‰è®¾ç½®</span>
                        </p>
                    </div>
                    
                    <div class="sticky bottom-0 bg-white border-t-2 border-gray-200 pt-4 flex justify-center">
                        <button onclick="closePlanModal()" class="bg-primary-red text-white px-10 py-3 rounded-lg font-bold transition shadow-lg text-lg hover:bg-primary-red-dark">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯¼å…¥æ¨¡æ€æ¡† -->
        <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto">
                <div class="sticky top-0 p-4 rounded-t-2xl z-10 flex items-center justify-between" style="background-color: #16a34a;">
                    <div style="width: 32px;"></div>
                    <h2 class="text-xl font-bold text-center" style="color: white;">ğŸ“‹ ç²˜è´´è¡¨æ ¼æ•°æ®</h2>
                    <button onclick="closeImportModal()" class="rounded-full w-8 h-8 flex items-center justify-center transition text-2xl font-bold hover:opacity-80" style="color: white; background-color: rgba(255,255,255,0.2);" title="å…³é—­">
                        Ã—
                    </button>
                </div>
                
                <div class="p-6">
                    <!-- ä½¿ç”¨è¯´æ˜ -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                        <h4 class="font-bold text-blue-800 mb-2">ğŸ“Œ ä½¿ç”¨è¯´æ˜</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>â€¢ ä» Excelã€WPSã€ç½‘é¡µè¡¨æ ¼ ä¸­å¤åˆ¶æ•°æ®ï¼Œç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†</li>
                            <li>â€¢ æ”¯æŒ Tabåˆ†éš”ï¼ˆExcelå¤åˆ¶ï¼‰æˆ– é€—å·åˆ†éš”ï¼ˆCSVæ ¼å¼ï¼‰</li>
                            <li>â€¢ å¿…å¡«åˆ—ï¼š<strong>çª—æˆ·ç¼–å·ã€å®½åº¦ã€é«˜åº¦ã€äº§å“ç±»å‹</strong></li>
                            <li>â€¢ å¯é€‰åˆ—ï¼šæ¥¼å±‚ã€æˆ¿é—´/åŒºåŸŸã€æœå‘ã€æ•°é‡ï¼ˆé»˜è®¤ä¸º1ï¼‰</li>
                        </ul>
                    </div>
                    
                    <!-- æ ¼å¼ç¤ºä¾‹ -->
                    <div class="bg-gray-50 border rounded-lg p-4 mb-4">
                        <h4 class="font-bold text-gray-700 mb-2">ğŸ“ æ•°æ®æ ¼å¼ç¤ºä¾‹ï¼ˆå¯ç›´æ¥å¤åˆ¶ä¸‹æ–¹ç¤ºä¾‹æµ‹è¯•ï¼‰</h4>
                        <div class="bg-white border rounded p-3 font-mono text-xs overflow-x-auto">
                            <div class="text-gray-500 mb-1"># å®Œæ•´æ ¼å¼ï¼šæ¥¼å±‚ | æˆ¿é—´ | çª—æˆ·ç¼–å· | æœå‘ | å®½åº¦ | é«˜åº¦ | äº§å“ | æ•°é‡</div>
                            <div>ä¸€æ¥¼	å®¢å…	è¥¿çª—1	è¥¿	1500	2000	æ™¨æ›¦	2</div>
                            <div>äºŒæ¥¼	ä¸»å§	A1	å—	1200	1800	æš®è¯­	1</div>
                            <div class="text-gray-500 mt-2 mb-1"># ç®€åŒ–æ ¼å¼ï¼šçª—æˆ·ç¼–å· | å®½åº¦ | é«˜åº¦ | äº§å“</div>
                            <div>B1	800	1000	æ™ºå¹•Pro30</div>
                            <div>C2	1520	2400	æ™¨æ›¦</div>
                        </div>
                    </div>
                    
                    <!-- ç²˜è´´åŒºåŸŸ -->
                    <div class="mb-4">
                        <label class="block font-bold text-gray-700 mb-2">ç²˜è´´æ•°æ®åˆ°æ­¤å¤„ï¼š</label>
                        <textarea id="importTextarea" 
                            class="w-full h-48 p-3 border-2 border-gray-300 rounded-lg font-mono text-sm focus:border-green-500 focus:outline-none"
                            placeholder="åœ¨æ­¤ç²˜è´´ä»Excelå¤åˆ¶çš„æ•°æ®...

ç¤ºä¾‹ï¼ˆTabåˆ†éš”ï¼‰ï¼š
ä¸€æ¥¼	å®¢å…	è¥¿çª—1	è¥¿	1500	2000	æ™¨æ›¦	2
äºŒæ¥¼	ä¸»å§	A1	å—	1200	1800	æš®è¯­	1

æˆ–ç®€åŒ–æ ¼å¼ï¼š
B1	800	1000	æ™ºå¹•Pro30"></textarea>
                    </div>
                    
                    <!-- å¯¼å…¥é€‰é¡¹ -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h4 class="font-bold text-gray-700 mb-3">âš™ï¸ å¯¼å…¥é€‰é¡¹</h4>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="importAppendMode" class="w-4 h-4 text-green-600">
                                <span class="text-sm">è¿½åŠ æ¨¡å¼ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼‰</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="importSkipHeader" class="w-4 h-4 text-green-600">
                                <span class="text-sm">é¦–è¡Œæ˜¯è¡¨å¤´ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œï¼‰</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="importPreview" class="hidden mb-4">
                        <h4 class="font-bold text-gray-700 mb-2">ğŸ‘€ æ•°æ®é¢„è§ˆ</h4>
                        <div id="importPreviewContent" class="border rounded-lg overflow-x-auto max-h-64 overflow-y-auto">
                        </div>
                        <div id="importPreviewStats" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                    
                    <!-- æŒ‰é’® -->
                    <div class="flex gap-3 justify-end border-t pt-4 mt-4">
                        <button onclick="previewImportData()" style="background-color: #3b82f6; color: white;" class="px-6 py-2 rounded-lg font-bold hover:opacity-90 transition">
                            ğŸ‘€ é¢„è§ˆæ•°æ®
                        </button>
                        <button onclick="confirmImportData()" style="background-color: #16a34a; color: white;" class="px-6 py-2 rounded-lg font-bold hover:opacity-90 transition">
                            âœ… ç¡®è®¤å¯¼å…¥
                        </button>
                        <button onclick="closeImportModal()" style="background-color: #6b7280; color: white;" class="px-6 py-2 rounded-lg font-bold hover:opacity-90 transition">
                            âœ– å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultSection" class="hidden">
            <div id="totalStats" class="bg-white rounded-2xl shadow-xl p-6 mb-1">
                <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: var(--primary-red);">
                    <span class="mr-2">ğŸ“Š</span> æ€»ä½“ç»Ÿè®¡
                    <button onclick="exportToImage('totalStats', 'æ€»ä½“ç»Ÿè®¡')" class="ml-auto bg-green-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow hover:bg-green-700" style="font-size: 0.85rem;">
                        ğŸ“· å¯¼å‡ºå›¾ç‰‡
                    </button>
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: var(--secondary-gray); font-size: 0.7rem;">ç»ç’ƒæ€»æ•°</div>
                        <div class="font-bold" style="color: var(--secondary-gray); font-size: 1.5rem;"><span id="totalGlassCount">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">å—</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: #373737; font-size: 0.7rem;">äº§å“ç±»å‹æ•°</div>
                        <div class="font-bold" style="color: #373737; font-size: 1.5rem;"><span id="productTypeCount">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">ç§</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: #373737; font-size: 0.7rem;">æ€»å¼€å·æ•°</div>
                        <div class="font-bold" style="color: #373737; font-size: 1.5rem;"><span id="totalRollCount">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">å·</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: var(--secondary-gray); font-size: 0.7rem;">å·æåˆ©ç”¨ç‡</div>
                        <div class="font-bold" style="color: var(--secondary-gray); font-size: 1.5rem;"><span id="rollUtilization">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">%</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: var(--secondary-gray); font-size: 0.7rem;">å·ææŸè€—ç‡</div>
                        <div class="font-bold" style="color: var(--secondary-gray); font-size: 1.5rem;"><span id="materialWasteRate">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">%</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: #373737; font-size: 0.7rem;">ç»ç’ƒæ€»é¢ç§¯</div>
                        <div class="font-bold" style="color: #373737; font-size: 1.5rem;"><span id="totalGlassArea">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">mÂ²</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: var(--secondary-gray); font-size: 0.7rem;">è†œææ€»é¢ç§¯</div>
                        <div class="font-bold" style="color: var(--secondary-gray); font-size: 1.5rem;"><span id="totalFilmArea">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">mÂ²</span></div>
                    </div>
                    <div class="bg-gray-200 rounded-xl p-3 border-2 border-gray-300">
                        <div class="text-xs font-semibold mb-1" style="color: #373737; font-size: 0.7rem;">å®é™…ç”¨è†œæ€»é•¿åº¦</div>
                        <div class="font-bold" style="color: #373737; font-size: 1.5rem;"><span id="totalFilmLength">0</span><span style="font-size: 0.9rem; margin-left: 0.2rem;">m</span></div>
                    </div>
                </div>
            </div>

            <div id="scrapManagement" class="bg-white rounded-2xl shadow-xl p-6 mb-1">
                <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: var(--primary-red);">
                    <span class="mr-2">ğŸ“¦</span> ä½™æ–™ç®¡ç†
                    <button onclick="exportToImage('scrapManagement', 'ä½™æ–™ç®¡ç†')" class="ml-auto bg-green-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow hover:bg-green-700" style="font-size: 0.85rem;">
                        ğŸ“· å¯¼å‡ºå›¾ç‰‡
                    </button>
                </h2>
                <div id="scrapList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">æš‚æ— ä½™æ–™æ•°æ®</div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-6 mb-1">
                <h2 class="text-2xl font-bold mb-6 flex items-center" style="color: var(--primary-red);">
                    <span class="mr-2">ğŸ“Š</span> äº§å“åˆ†ç±»ç»Ÿè®¡
                    <button onclick="exportToImage('productStats', 'äº§å“åˆ†ç±»ç»Ÿè®¡')" class="ml-auto bg-green-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition shadow hover:bg-green-700" style="font-size: 0.85rem;">
                        ğŸ“· å¯¼å‡ºå›¾ç‰‡
                    </button>
                </h2>
                <div id="productStats" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">æš‚æ— æ•°æ®</div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: var(--primary-red);">
                    <span class="mr-2">ğŸ“„</span> è¯¦ç»†è®¡ç®—æ—¥å¿—
                </h2>
                <p class="text-gray-600 mb-4">å®Œæ•´çš„è®¡ç®—è¿‡ç¨‹å’Œè¯¦ç»†ç»“æœå·²ä¿å­˜,ç‚¹å‡»ä¸‹è½½æŸ¥çœ‹</p>
                <button onclick="downloadLog()" class="bg-primary-red text-white font-bold py-3 px-8 rounded-lg transition shadow-lg hover:bg-primary-red-dark">
                    ğŸ“¥ ä¸‹è½½è¯¦ç»†æ—¥å¿—
                </button>
            </div>
        </div>
    </div>

    <script>
        const FILM_WIDTH = 1520;
        const FILM_MAX_LENGTH = 30000;
        const NEAR_WIDTH_MIN = 1300;
        const SCRAP_MIN_SIZE = 200;
        const SCRAP_MARGIN = 10;
        const SIGHT_LINE_MIN = 1500;
        const SIGHT_LINE_MAX = 1700;
        
        window.glasses = [];
        window.optimizationState = null;
        window.allGlassesPlans = [];
        window.selectedPlans = {};
        window.editingIndex = -1;
        window.allItems = [];
        window.placed = new Set();
        
        const productNames = {
            'æ™¨æ›¦': 'æ™¨æ›¦',
            'æš®è¯­': 'æš®è¯­',
            'æ™ºå¹•Pro30': 'æ™ºå¹•Pro30',
            'æ™ºå¹•Pro70': 'æ™ºå¹•Pro70',
            'å…¶ä»–': 'å…¶ä»–'
        };
        
        const productColors = {
            'æ™¨æ›¦': { bg: 'linear-gradient(135deg, #ff6b6b, #ff5722)', text: 'white' },
            'æš®è¯­': { bg: 'linear-gradient(135deg, #9c27b0, #673ab7)', text: 'white' },
            'æ™ºå¹•Pro30': { bg: 'linear-gradient(135deg, #2196f3, #1976d2)', text: 'white' },
            'æ™ºå¹•Pro70': { bg: 'linear-gradient(135deg, #4caf50, #388e3c)', text: 'white' },
            'å…¶ä»–': { bg: 'linear-gradient(135deg, #607d8b, #455a64)', text: 'white' },
            '-': { bg: '#e0e0e0', text: '#666' }
        };

        class GlassItem {
            constructor(id, width, height, baseId, product) {
                this.id = id;
                this.width = width;
                this.height = height;
                this.baseId = baseId;
                this.product = product;
                this.originalWidth = width;
                this.originalHeight = height;
            }
            area() { return this.width * this.height; }
            minSide() { return Math.min(this.width, this.height); }
            maxSide() { return Math.max(this.width, this.height); }
            aspectRatio() { return this.maxSide() / this.minSide(); }
        }

        class ScrapArea {
            constructor(width, height, segmentId) {
                this.width = width;
                this.height = height;
                this.segmentId = segmentId;
                this.area = width * height;
                this.isUsable = width >= SCRAP_MIN_SIZE && height >= SCRAP_MIN_SIZE;
            }
            
            getUtilization(usedArea) {
                return this.area > 0 ? usedArea / this.area : 0;
            }
        }

        class GlassPlacement {
            constructor(glass, rotated = false) {
                this.glass = glass;
                this.rotated = rotated;
                
                if (rotated) {
                    this.width = glass.height;
                    this.height = glass.width;
                } else {
                    this.width = glass.width;
                    this.height = glass.height;
                }
                
                this.area = this.width * this.height;
            }
            
            getOccupiedWidth(margin = SCRAP_MARGIN) {
                return this.width + 2 * margin;
            }
            
            getOccupiedHeight(margin = SCRAP_MARGIN) {
                return this.height + 2 * margin;
            }
        }

        function checkSightLineConflictForGlass(glass) {
            const width = glass.width;
            const height = glass.height;
            const shortSide = glass.minSide();
            const longSide = glass.maxSide();
            
            if (shortSide <= FILM_WIDTH) {
                return {
                    horizontal: { needsSplicing: false },
                    vertical: { needsSplicing: false },
                    needsUserSelection: () => false,
                    canAutoSplice: () => false
                };
            }
            
            const hNeedsSplicing = (height > FILM_WIDTH);
            let hResult = {
                needsSplicing: hNeedsSplicing,
                canAutoSelect: false,
                bothConflict: false,
                stitch1Conflict: false,
                stitch2Conflict: false,
                stitch1Position: 0,
                stitch2Position: 0,
                segmentsNeeded: hNeedsSplicing ? Math.ceil(height / FILM_WIDTH) : 1
            };
            
            if (hNeedsSplicing && height < 3020 && width <= FILM_MAX_LENGTH) {
                const stitch1 = FILM_WIDTH;
                const stitch2 = height - FILM_WIDTH;
                hResult.stitch1Position = stitch1;
                hResult.stitch2Position = stitch2;
                hResult.stitch1Conflict = (stitch1 >= SIGHT_LINE_MIN && stitch1 <= SIGHT_LINE_MAX);
                hResult.stitch2Conflict = (stitch2 >= SIGHT_LINE_MIN && stitch2 <= SIGHT_LINE_MAX);
                hResult.bothConflict = hResult.stitch1Conflict && hResult.stitch2Conflict;
                hResult.canAutoSelect = !hResult.bothConflict;
            } else if (hNeedsSplicing) {
                hResult.bothConflict = true;
            }
            
            const vNeedsSplicing = (width > FILM_WIDTH);
            let vResult = {
                needsSplicing: vNeedsSplicing,
                canAutoSelect: false,
                bothConflict: vNeedsSplicing ? true : false,
                isVerticalSeam: vNeedsSplicing
            };
            
            return {
                horizontal: hResult,
                vertical: vResult,
                needsUserSelection: function() {
                    if (hResult.needsSplicing && vResult.needsSplicing) {
                        if (height < 3020 && width <= FILM_MAX_LENGTH && hResult.canAutoSelect) {
                            return false;
                        }
                        return true;
                    }
                    if (hResult.needsSplicing && !vResult.needsSplicing) {
                        return hResult.bothConflict || height >= 3020;
                    }
                    if (vResult.needsSplicing && !hResult.needsSplicing) {
                        return true;
                    }
                    return false;
                },
                canAutoSplice: function() {
                    if (hNeedsSplicing && height < 3020 && width <= FILM_MAX_LENGTH) {
                        return hResult.canAutoSelect;
                    }
                    return false;
                }
            };
        }

        class SkylinePacker {
            constructor(width, maxHeight, margin = SCRAP_MARGIN) {
                this.width = width;
                this.maxHeight = maxHeight;
                this.margin = margin;
                this.skyline = [{ x: 0, y: 0, width: width }];
                this.placedItems = [];
                this.usedHeight = 0;
            }
            
            findBestPosition(glassPlacement) {
                let bestY = this.maxHeight + 1;
                let bestIndex = -1;
                let bestX = 0;
                
                const occupiedWidth = glassPlacement.getOccupiedWidth(this.margin);
                const occupiedHeight = glassPlacement.getOccupiedHeight(this.margin);
                
                for (let i = 0; i < this.skyline.length; i++) {
                    let currentX = this.skyline[i].x;
                    
                    if (currentX + occupiedWidth > this.width) continue;
                    
                    let maxY = 0;
                    let canPlace = true;
                    let width = 0;
                    
                    for (let j = i; j < this.skyline.length && width < occupiedWidth; j++) {
                        maxY = Math.max(maxY, this.skyline[j].y);
                        width += this.skyline[j].width;
                        
                        if (this.skyline[j].x + this.skyline[j].width > currentX + occupiedWidth) {
                            break;
                        }
                    }
                    
                    if (maxY + occupiedHeight > this.maxHeight) {
                        canPlace = false;
                    }
                    
                    if (canPlace && maxY < bestY) {
                        bestY = maxY;
                        bestIndex = i;
                        bestX = currentX;
                    }
                }
                
                if (bestIndex === -1) return null;
                
                return {
                    x: bestX + this.margin,
                    y: bestY + this.margin,
                    index: bestIndex
                };
            }
            
            tryPlace(glassPlacement) {
                const position = this.findBestPosition(glassPlacement);
                
                if (!position) return false;
                
                const placement = {
                    glass: glassPlacement.glass,
                    rotated: glassPlacement.rotated,
                    x: position.x,
                    y: position.y,
                    width: glassPlacement.width,
                    height: glassPlacement.height
                };
                
                this.placedItems.push(placement);
                this.updateSkyline(position.x - this.margin, position.y - this.margin, 
                                  glassPlacement.getOccupiedWidth(this.margin),
                                  glassPlacement.getOccupiedHeight(this.margin));
                
                this.usedHeight = Math.max(this.usedHeight, position.y + glassPlacement.height + this.margin);
                
                return true;
            }
            
            updateSkyline(x, y, width, height) {
                const newY = y + height;
                const newSegment = { x: x, y: newY, width: width };
                
                let i = 0;
                while (i < this.skyline.length) {
                    const seg = this.skyline[i];
                    
                    if (seg.x >= x && seg.x + seg.width <= x + width) {
                        this.skyline.splice(i, 1);
                        continue;
                    }
                    else if (seg.x < x && seg.x + seg.width > x && seg.x + seg.width <= x + width) {
                        seg.width = x - seg.x;
                        i++;
                    }
                    else if (seg.x >= x && seg.x < x + width && seg.x + seg.width > x + width) {
                        const diff = (x + width) - seg.x;
                        seg.x = x + width;
                        seg.width -= diff;
                        i++;
                    }
                    else if (seg.x < x && seg.x + seg.width > x + width) {
                        const oldWidth = seg.width;
                        seg.width = x - seg.x;
                        this.skyline.splice(i + 1, 0, {
                            x: x + width,
                            y: seg.y,
                            width: oldWidth - seg.width - width
                        });
                        i++;
                    }
                    else {
                        i++;
                    }
                }
                
                let inserted = false;
                for (let i = 0; i < this.skyline.length; i++) {
                    if (this.skyline[i].x >= x) {
                        this.skyline.splice(i, 0, newSegment);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    this.skyline.push(newSegment);
                }
                
                this.mergeSkyline();
            }
            
            mergeSkyline() {
                let i = 0;
                while (i < this.skyline.length - 1) {
                    if (Math.abs(this.skyline[i].y - this.skyline[i + 1].y) < 0.01) {
                        this.skyline[i].width += this.skyline[i + 1].width;
                        this.skyline.splice(i + 1, 1);
                    } else {
                        i++;
                    }
                }
            }
            
            getUtilization(totalArea) {
                const usedArea = this.placedItems.reduce((sum, item) => 
                    sum + item.width * item.height, 0
                );
                return totalArea > 0 ? usedArea / totalArea : 0;
            }
            
            getUsedArea() {
                return this.placedItems.reduce((sum, item) => 
                    sum + item.width * item.height, 0
                );
            }
        }

        function trySmartEnumeration(glasses, filmWidth, maxLength) {
            if (glasses.length > 4) return null;
            
            const totalArea = glasses.reduce((sum, g) => sum + g.area(), 0);
            const minPossibleLength = Math.ceil(totalArea / filmWidth);
            
            let bestResult = null;
            
            const permutations = generatePermutations(glasses);
            
            for (const perm of permutations) {
                const rotationCombos = Math.pow(2, perm.length);
                
                for (let rotMask = 0; rotMask < rotationCombos; rotMask++) {
                    const placements = perm.map((glass, idx) => {
                        const shouldRotate = (rotMask >> idx) & 1;
                        return new GlassPlacement(glass, shouldRotate);
                    });
                    
                    for (let targetLen = minPossibleLength; targetLen <= maxLength; targetLen += 50) {
                        const packer = new SkylinePacker(filmWidth, targetLen, 10);
                        
                        let allPlaced = true;
                        for (const placement of placements) {
                            if (!packer.tryPlace(placement)) {
                                allPlaced = false;
                                break;
                            }
                        }
                        
                        if (allPlaced) {
                            const actualLength = Math.ceil(packer.usedHeight / 10) * 10;
                            const util = packer.getUsedArea() / (filmWidth * actualLength);
                            
                            if (!bestResult || actualLength < bestResult.length || 
                                (actualLength === bestResult.length && util > bestResult.utilization)) {
                                bestResult = {
                                    length: actualLength,
                                    utilization: util,
                                    glasses: perm,
                                    glassIds: perm.map(g => g.id),
                                    placedItems: packer.placedItems,
                                    strategy: 'smart_enum',
                                    algorithm: 'enum_v2'
                                };
                            }
                            break;
                        }
                    }
                }
            }
            
            return bestResult;
        }
        
        function generatePermutations(arr) {
            if (arr.length <= 1) return [arr];
            if (arr.length === 2) return [arr, [arr[1], arr[0]]];
            
            const result = [];
            for (let i = 0; i < arr.length; i++) {
                const rest = [...arr.slice(0, i), ...arr.slice(i + 1)];
                const restPerms = generatePermutations(rest);
                for (const perm of restPerms) {
                    result.push([arr[i], ...perm]);
                }
            }
            return result;
        }

        function find2DPackingLayout(glasses, filmWidth, estimatedMaxLength = 5000) {
            if (glasses.length === 0) return null;
            if (glasses.length === 1) {
                const glass = glasses[0];
                return {
                    length: glass.maxSide() + 20,
                    utilization: glass.area() / (filmWidth * (glass.maxSide() + 20)),
                    glasses: [glass],
                    glassIds: [glass.id],
                    placedItems: [{
                        glass: glass,
                        x: 10,
                        y: 10,
                        width: glass.width,
                        height: glass.height,
                        rotated: false
                    }],
                    strategy: 'single',
                    algorithm: 'direct'
                };
            }
            
            const totalArea = glasses.reduce((sum, g) => sum + g.area(), 0);
            const theoreticalMin = Math.ceil(totalArea / filmWidth);
            const maxSide = Math.max(...glasses.map(g => g.maxSide()));
            const absMin = Math.max(theoreticalMin, maxSide + 20);
            
            if (glasses.length <= 4) {
                const enumResult = trySmartEnumeration(glasses, filmWidth, Math.min(estimatedMaxLength, absMin + 1500));
                if (enumResult) {
                    return enumResult;
                }
            }
            
            const sortStrategies = [
                { name: 'aspect_ratio', sort: (a, b) => a.aspectRatio() - b.aspectRatio() },
                { name: 'max_side', sort: (a, b) => b.maxSide() - a.maxSide() },
                { name: 'min_side', sort: (a, b) => b.minSide() - a.minSide() }
            ];
            
            let bestResult = null;
            
            const searchLimit = Math.min(estimatedMaxLength, absMin + 2000);
            const stepSize = glasses.length <= 6 ? 25 : 50;
            
            for (let targetLength = absMin; targetLength <= searchLimit; targetLength += stepSize) {
                for (const strategy of sortStrategies) {
                    const sorted = [...glasses].sort(strategy.sort);
                    const packer = new SkylinePacker(filmWidth, targetLength, 10);
                    
                    let allPlaced = true;
                    for (const glass of sorted) {
                        const orientations = [
                            new GlassPlacement(glass, false),
                            new GlassPlacement(glass, true)
                        ];
                        
                        let placed = false;
                        for (const placement of orientations) {
                            if (packer.tryPlace(placement)) {
                                placed = true;
                                break;
                            }
                        }
                        
                        if (!placed) {
                            allPlaced = false;
                            break;
                        }
                    }
                    
                    if (allPlaced) {
                        const actualLength = Math.ceil(packer.usedHeight / 10) * 10;
                        const utilization = packer.getUsedArea() / (filmWidth * actualLength);
                        
                        const isBetter = !bestResult || 
                            utilization > bestResult.utilization + 0.02 || 
                            (Math.abs(utilization - bestResult.utilization) <= 0.02 && actualLength < bestResult.length);
                        
                        if (isBetter) {
                            bestResult = {
                                length: actualLength,
                                utilization: utilization,
                                glasses: sorted,
                                glassIds: sorted.map(g => g.id),
                                placedItems: packer.placedItems,
                                strategy: strategy.name,
                                algorithm: 'skyline_v2'
                            };
                        }
                        
                        if (utilization > 0.92) {
                            return bestResult;
                        }
                    }
                }
                
                if (bestResult && bestResult.utilization > 0.80 && targetLength > bestResult.length + 500) {
                    break;
                }
            }
            
            return bestResult;
        }

        function strategyA_AspectRatioGrouping(glasses, filmWidth) {
            if (glasses.length === 0) return { segments: [], totalLength: 0 };
            
            const groups = {
                square: [],
                medium: [],
                elongated: [],
                veryLong: []
            };
            
            glasses.forEach(g => {
                const ratio = g.aspectRatio();
                if (ratio <= 1.2) groups.square.push(g);
                else if (ratio <= 2.5) groups.medium.push(g);
                else if (ratio <= 5.0) groups.elongated.push(g);
                else groups.veryLong.push(g);
            });
            
            const segments = [];
            
            Object.entries(groups).forEach(([groupName, groupGlasses]) => {
                if (groupGlasses.length === 0) return;
                
                const packResult = find2DPackingLayout(groupGlasses, filmWidth, 8000);
                
                if (packResult) {
                    segments.push({
                        name: `AR_${groupName}`,
                        length: packResult.length,
                        mainGlassArea: groupGlasses.reduce((s, g) => s + g.area(), 0),
                        mainGlassIds: groupGlasses.map(g => g.id),
                        scrapArea: 0,
                        scrapWidth: 0,
                        scrapHeight: 0,
                        scrapGlassArea: 0,
                        scrapGlassIds: [],
                        glasses: groupGlasses.map(g => g.id)
                    });
                } else {
                    groupGlasses.forEach(glass => {
                        segments.push({
                            name: `Single_${glass.id}`,
                            length: glass.maxSide() + 20,
                            mainGlassArea: glass.area(),
                            mainGlassIds: [glass.id],
                            scrapArea: 0,
                            scrapWidth: 0,
                            scrapHeight: 0,
                            scrapGlassArea: 0,
                            scrapGlassIds: [],
                            glasses: [glass.id]
                        });
                    });
                }
            });
            
            const totalLength = segments.reduce((s, seg) => s + seg.length, 0);
            return { segments, totalLength };
        }

        function strategyB_EdgeClustering(glasses, filmWidth) {
            if (glasses.length === 0) return { segments: [], totalLength: 0 };
            
            const sorted = [...glasses].sort((a, b) => b.maxSide() - a.maxSide());
            
            const maxEdges = sorted.map(g => g.maxSide());
            const minEdge = Math.min(...maxEdges);
            const maxEdge = Math.max(...maxEdges);
            
            const numGroups = Math.min(4, Math.max(2, Math.ceil(glasses.length / 4)));
            
            const groups = Array.from({ length: numGroups }, () => []);
            
            sorted.forEach((g, idx) => {
                const groupIndex = Math.min(numGroups - 1, Math.floor(idx / Math.ceil(sorted.length / numGroups)));
                groups[groupIndex].push(g);
            });
            
            const segments = [];
            
            groups.forEach((group, i) => {
                if (group.length === 0) return;
                
                const packResult = find2DPackingLayout(group, filmWidth);
                
                if (packResult) {
                    segments.push({
                        name: `Edge_G${i+1}`,
                        length: packResult.length,
                        mainGlassArea: group.reduce((s, g) => s + g.area(), 0),
                        mainGlassIds: group.map(g => g.id),
                        scrapArea: 0,
                        scrapWidth: 0,
                        scrapHeight: 0,
                        scrapGlassArea: 0,
                        scrapGlassIds: [],
                        glasses: group.map(g => g.id)
                    });
                } else {
                    group.forEach(glass => {
                        segments.push({
                            name: `Single_${glass.id}`,
                            length: glass.maxSide() + 20,
                            mainGlassArea: glass.area(),
                            mainGlassIds: [glass.id],
                            scrapArea: 0,
                            scrapWidth: 0,
                            scrapHeight: 0,
                            scrapGlassArea: 0,
                            scrapGlassIds: [],
                            glasses: [glass.id]
                        });
                    });
                }
            });
            
            const totalLength = segments.reduce((s, seg) => s + seg.length, 0);
            return { segments, totalLength };
        }

        function strategyC_AggressivePacking(glasses, filmWidth) {
            const segments = [];
            const used = new Set();
            let iterCount = 0;
            
            const sortedByArea = [...glasses].sort((a, b) => b.area() - a.area());
            
            while (sortedByArea.some(g => !used.has(g.id)) && iterCount < 20) {
                iterCount++;
                const remaining = sortedByArea.filter(g => !used.has(g.id));
                
                if (remaining.length === 0) break;
                
                let bestResult = null;
                let bestMetric = -1;
                
                const tryComboSizes = [
                    Math.min(8, remaining.length),
                    Math.min(6, remaining.length),
                    Math.min(4, remaining.length),
                    Math.min(3, remaining.length),
                    Math.min(2, remaining.length),
                    1
                ];
                
                for (const trySize of tryComboSizes) {
                    if (trySize === 0) continue;
                    
                    const tryGlasses = remaining.slice(0, trySize);
                    const result = find2DPackingLayout(tryGlasses, filmWidth, 8000);
                    
                    if (result && result.glasses && result.glasses.length > 0) {
                        const metric = result.utilization * result.glasses.length;
                        
                        if (metric > bestMetric) {
                            bestMetric = metric;
                            bestResult = result;
                        }
                        
                        if (result.utilization > 0.85) {
                            break;
                        }
                    }
                }
                
                if (bestResult) {
                    const usedArea = bestResult.placedItems.reduce((sum, item) => 
                        sum + item.width * item.height, 0
                    );
                    
                    segments.push({
                        name: `Pack${segments.length + 1}`,
                        length: bestResult.length,
                        mainGlassArea: usedArea,
                        mainGlassIds: bestResult.glassIds,
                        scrapArea: 0,
                        scrapWidth: 0,
                        scrapHeight: 0,
                        scrapGlassArea: 0,
                        scrapGlassIds: [],
                        glasses: bestResult.glassIds
                    });
                    
                    bestResult.glasses.forEach(g => used.add(g.id));
                } else {
                    const glass = remaining[0];
                    segments.push({
                        name: `Single_${glass.id}`,
                        length: glass.maxSide() + 20,
                        mainGlassArea: glass.area(),
                        mainGlassIds: [glass.id],
                        scrapArea: 0,
                        scrapWidth: 0,
                        scrapHeight: 0,
                        scrapGlassArea: 0,
                        scrapGlassIds: [],
                        glasses: [glass.id]
                    });
                    used.add(glass.id);
                }
            }
            
            const totalLength = segments.reduce((s, seg) => s + seg.length, 0);
            return { segments, totalLength };
        }

        function strategyD_HybridDensity(glasses, filmWidth) {
            if (glasses.length === 0) return { segments: [], totalLength: 0 };
            
            const sortedByArea = [...glasses].sort((a, b) => b.area() - a.area());
            const totalCount = sortedByArea.length;
            
            const large = [];
            const medium = [];
            const small = [];
            
            sortedByArea.forEach((g, idx) => {
                if (idx < totalCount * 0.3) {
                    large.push(g);
                } else if (idx < totalCount * 0.7) {
                    medium.push(g);
                } else {
                    small.push(g);
                }
            });
            
            const segments = [];
            
            large.sort((a, b) => a.aspectRatio() - b.aspectRatio());
            medium.sort((a, b) => a.aspectRatio() - b.aspectRatio());
            small.sort((a, b) => a.aspectRatio() - b.aspectRatio());
            
            let iterCount = 0;
            
            while ((large.length > 0 || medium.length > 0 || small.length > 0) && iterCount < 30) {
                iterCount++;
                let currentCombo = [];
                
                if (large.length > 0) {
                    currentCombo.push(large.shift());
                    if (large.length > 0 && currentCombo[0].aspectRatio() < 2.5) {
                        currentCombo.push(large.shift());
                    }
                }
                
                if (currentCombo.length === 0 && medium.length > 0) {
                    currentCombo.push(medium.shift());
                    if (medium.length > 0) {
                        currentCombo.push(medium.shift());
                    }
                }
                
                let addedMedium = 0;
                while (medium.length > 0 && addedMedium < 2 && currentCombo.length < 5) {
                    currentCombo.push(medium.shift());
                    addedMedium++;
                }
                
                let addedSmall = 0;
                while (small.length > 0 && addedSmall < 5 && currentCombo.length < 8) {
                    currentCombo.push(small.shift());
                    addedSmall++;
                }
                
                if (currentCombo.length === 0) break;
                
                const packResult = find2DPackingLayout(currentCombo, filmWidth, 8000);
                
                if (packResult) {
                    segments.push({
                        name: `Hybrid${segments.length + 1}`,
                        length: packResult.length,
                        mainGlassArea: currentCombo.reduce((s, g) => s + g.area(), 0),
                        mainGlassIds: currentCombo.map(g => g.id),
                        scrapArea: 0,
                        scrapWidth: 0,
                        scrapHeight: 0,
                        scrapGlassArea: 0,
                        scrapGlassIds: [],
                        glasses: currentCombo.map(g => g.id)
                    });
                } else {
                    currentCombo.forEach(glass => {
                        segments.push({
                            name: `Single_${glass.id}`,
                            length: glass.maxSide() + 20,
                            mainGlassArea: glass.area(),
                            mainGlassIds: [glass.id],
                            scrapArea: 0,
                            scrapWidth: 0,
                            scrapHeight: 0,
                            scrapGlassArea: 0,
                            scrapGlassIds: [],
                            glasses: [glass.id]
                        });
                    });
                }
            }
            
            const totalLength = segments.reduce((s, seg) => s + seg.length, 0);
            return { segments, totalLength };
        }

        function optimizeRemainingGlassesWithMultipleStrategies(remaining, filmWidth) {
            if (remaining.length === 0) return [];
            
            log(`  ğŸ” å°è¯•${remaining.length}å—ç»ç’ƒçš„4ç§V3.0ç­–ç•¥...`, 'info');
            log(`  ç»ç’ƒåˆ—è¡¨: ${remaining.map(g => g.id).join(', ')}`, 'info');
            
            const strategies = [
                { name: 'V2-ç­–ç•¥A: é•¿å®½æ¯”åˆ†ç»„', fn: strategyA_AspectRatioGrouping },
                { name: 'V2-ç­–ç•¥B: è¾¹é•¿èšç±»', fn: strategyB_EdgeClustering },
                { name: 'V2-ç­–ç•¥C: æ¿€è¿›ç»„åˆ', fn: strategyC_AggressivePacking },
                { name: 'V2-ç­–ç•¥D: æ··åˆå¯†åº¦', fn: strategyD_HybridDensity }
            ];
            
            const results = [];
            
            for (const strategy of strategies) {
                try {
                    const glassesCopy = remaining.map(g => 
                        new GlassItem(g.id, g.width, g.height, g.baseId, g.product)
                    );
                    
                    const result = strategy.fn(glassesCopy, filmWidth);
                    
                    if (!result || !result.segments) {
                        log(`    ${strategy.name}: å¤±è´¥ (è¿”å›æ— æ•ˆç»“æœ)`, 'error');
                        continue;
                    }
                    
                    const processedIds = new Set();
                    result.segments.forEach(seg => {
                        if (seg.glasses) {
                            seg.glasses.forEach(id => processedIds.add(id));
                        }
                    });
                    
                    const allProcessed = remaining.every(g => processedIds.has(g.id));
                    
                    if (!allProcessed) {
                        const missing = remaining.filter(g => !processedIds.has(g.id));
                        log(`    ${strategy.name}: æœªå®Œæˆ (é—æ¼${missing.length}å—: ${missing.map(g => g.id).join(',')})`, 'error');
                        continue;
                    }
                    
                    result.strategyName = strategy.name;
                    results.push(result);
                    
                    const totalFilmArea = result.segments.reduce((sum, seg) => 
                        sum + filmWidth * seg.length, 0
                    );
                    const totalGlassArea = remaining.reduce((sum, g) => sum + g.area(), 0);
                    const util = totalFilmArea > 0 ? (totalGlassArea / totalFilmArea * 100).toFixed(1) : 0;
                    
                    log(`    ${strategy.name}: ${(result.totalLength/1000).toFixed(2)}m, ${result.segments.length}æ®µ, åˆ©ç”¨ç‡${util}%`, 'info');
                } catch (e) {
                    log(`    ${strategy.name}: å¼‚å¸¸å¤±è´¥ - ${e.message}`, 'error');
                    console.error(`Strategy ${strategy.name} error:`, e);
                }
            }
            
            if (results.length === 0) {
                log(`  âš ï¸ æ‰€æœ‰ç­–ç•¥éƒ½å¤±è´¥,å°è¯•ç‹¬ç«‹å¤„ç†`, 'error');
                return remaining.map(glass => ({
                    name: `Single_${glass.id}`,
                    length: glass.maxSide() + 20,
                    mainGlassArea: glass.area(),
                    mainGlassIds: [glass.id],
                    scrapArea: 0,
                    scrapWidth: 0,
                    scrapHeight: 0,
                    scrapGlassArea: 0,
                    scrapGlassIds: [],
                    glasses: [glass.id]
                }));
            }
            
            results.sort((a, b) => {
                const lenDiff = a.totalLength - b.totalLength;
                if (Math.abs(lenDiff) > 100) return lenDiff;
                return a.segments.length - b.segments.length;
            });
            
            const best = results[0];
            
            log(`  âœ” é€‰æ‹© ${best.strategyName}: ${(best.totalLength/1000).toFixed(2)}m, ${best.segments.length}æ®µ`, 'success');
            
            return best.segments;
        }

        function optimizeScrapFilling(scrapArea, candidates, margin = SCRAP_MARGIN) {
            if (!scrapArea.isUsable) {
                return {
                    success: false,
                    reason: `ä½™æ–™åŒºå°ºå¯¸è¿‡å°(< ${SCRAP_MIN_SIZE}mm),è§†ä¸ºåºŸæ–™`,
                    placedGlasses: [],
                    utilization: 0,
                    usedArea: 0
                };
            }
            
            const feasibleCandidates = candidates.filter(glass => {
                const minRequired = Math.min(glass.width, glass.height) + 2 * margin;
                const maxRequired = Math.max(glass.width, glass.height) + 2 * margin;
                
                return (minRequired <= scrapArea.width && maxRequired <= scrapArea.height) ||
                       (minRequired <= scrapArea.height && maxRequired <= scrapArea.width);
            });
            
            if (feasibleCandidates.length === 0) {
                return {
                    success: false,
                    reason: 'æ²¡æœ‰å¯æ”¾å…¥çš„å°ç»ç’ƒ',
                    placedGlasses: [],
                    utilization: 0,
                    usedArea: 0
                };
            }
            
            if (feasibleCandidates.length <= 4) {
                const enumResult = trySmartEnumerationForScrap(scrapArea, feasibleCandidates, margin);
                if (enumResult && enumResult.success) {
                    return enumResult;
                }
            }
            
            const strategies = [
                { name: 'æŒ‰é•¿å®½æ¯”', sort: (a, b) => a.aspectRatio() - b.aspectRatio() },
                { name: 'æŒ‰å‘¨é•¿é™åº', sort: (a, b) => (b.width + b.height) - (a.width + a.height) },
                { name: 'æŒ‰æœ€é•¿è¾¹é™åº', sort: (a, b) => Math.max(b.width, b.height) - Math.max(a.width, a.height) }
            ];
            
            let bestResult = null;
            let bestUtilization = 0;
            
            for (const strategy of strategies) {
                const sorted = [...feasibleCandidates].sort(strategy.sort);
                const result = tryPackWithSkyline(scrapArea, sorted, margin);
                
                if (result.utilization > bestUtilization) {
                    bestUtilization = result.utilization;
                    bestResult = result;
                    bestResult.strategy = strategy.name;
                }
            }
            
            return bestResult;
        }
        
        function trySmartEnumerationForScrap(scrapArea, glasses, margin) {
            if (glasses.length > 4) return null;
            
            let bestResult = null;
            let bestCount = 0;
            
            const permutations = generatePermutations(glasses);
            
            for (const perm of permutations) {
                const rotationCombos = Math.pow(2, perm.length);
                
                for (let rotMask = 0; rotMask < rotationCombos; rotMask++) {
                    const placements = perm.map((glass, idx) => {
                        const shouldRotate = (rotMask >> idx) & 1;
                        return new GlassPlacement(glass, shouldRotate);
                    });
                    
                    const packer = new SkylinePacker(scrapArea.width, scrapArea.height, margin);
                    
                    for (const placement of placements) {
                        packer.tryPlace(placement);
                    }
                    
                    const placedCount = packer.placedItems.length;
                    const util = packer.getUtilization(scrapArea.area);
                    
                    if (placedCount > bestCount || (placedCount === bestCount && util > (bestResult?.utilization || 0))) {
                        bestCount = placedCount;
                        bestResult = {
                            success: placedCount > 0,
                            placedGlasses: packer.placedItems,
                            placedCount: placedCount,
                            utilization: util,
                            usedArea: packer.getUsedArea(),
                            totalArea: scrapArea.area,
                            algorithm: 'enum_scrap_v2',
                            strategy: 'smart_enum'
                        };
                    }
                }
            }
            
            return bestResult;
        }

        function tryPackWithSkyline(scrapArea, sortedCandidates, margin) {
            const packer = new SkylinePacker(scrapArea.width, scrapArea.height, margin);
            
            for (const glass of sortedCandidates) {
                const orientations = [
                    new GlassPlacement(glass, false),
                    new GlassPlacement(glass, true)
                ];
                
                let placed = false;
                for (const placement of orientations) {
                    if (packer.tryPlace(placement)) {
                        placed = true;
                        break;
                    }
                }
            }
            
            const util = packer.getUtilization(scrapArea.area);
            return {
                success: packer.placedItems.length > 0,
                placedGlasses: packer.placedItems,
                placedCount: packer.placedItems.length,
                utilization: util,
                usedArea: packer.getUsedArea(),
                totalArea: scrapArea.area,
                algorithm: 'skyline'
            };
        }

        let logMessages = [];

        function log(message, type = 'info') {
            logMessages.push({ message, type });
        }

        function generateSixPlans(glass, filmWidth, candidates) {
            const plans = [];
            
            const hSegmentsNeeded = Math.ceil(glass.height / filmWidth);
            const vSegmentsNeeded = Math.ceil(glass.width / filmWidth);
            
            if (hSegmentsNeeded === 2) {
                const part2Height1 = glass.height - filmWidth;
                const scrapWidth1 = filmWidth - part2Height1;
                const usableScraps1 = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth1 && maxReq <= glass.width) ||
                           (minReq <= glass.width && maxReq <= scrapWidth1);
                });
                
                plans.push({
                    id: 1,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥,ä»é¡¶éƒ¨å¼€å§‹é“ºè®¾',
                    segments: 2,
                    segmentHeights: [filmWidth, part2Height1],
                    method: 'horizontal',
                    stitchPosition: filmWidth,
                    scrapWidth: Math.max(0, scrapWidth1),
                    scrapHeight: glass.width,
                    usableScraps: usableScraps1.length,
                    scrapArea: usableScraps1.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps1.slice(0, 5),
                    filmLength: glass.width + 20
                });
                
                plans.push({
                    id: 2,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥,ä»åº•éƒ¨å¼€å§‹é“ºè®¾',
                    segments: 2,
                    segmentHeights: [part2Height1, filmWidth],
                    method: 'horizontal',
                    stitchPosition: part2Height1,
                    scrapWidth: Math.max(0, scrapWidth1),
                    scrapHeight: glass.width,
                    usableScraps: usableScraps1.length,
                    scrapArea: usableScraps1.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps1.slice(0, 5),
                    filmLength: glass.width + 20
                });
            } else if (hSegmentsNeeded === 3) {
                const remaining = glass.height - 2 * filmWidth;
                const scrapWidth = filmWidth - remaining;
                const usableScraps = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth && maxReq <= glass.width) ||
                           (minReq <= glass.width && maxReq <= scrapWidth);
                });
                
                plans.push({
                    id: 1,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥,ä»é¡¶éƒ¨å¼€å§‹é“ºè®¾',
                    segments: 3,
                    segmentHeights: [filmWidth, filmWidth, remaining],
                    method: 'horizontal',
                    stitchPosition: filmWidth,
                    stitchPosition2: 2 * filmWidth,
                    scrapWidth: Math.max(0, scrapWidth),
                    scrapHeight: glass.width,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 5),
                    filmLength: glass.width + 20
                });
                
                plans.push({
                    id: 2,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥,ä»åº•éƒ¨å¼€å§‹é“ºè®¾',
                    segments: 3,
                    segmentHeights: [remaining, filmWidth, filmWidth],
                    method: 'horizontal',
                    stitchPosition: remaining,
                    stitchPosition2: remaining + filmWidth,
                    scrapWidth: Math.max(0, scrapWidth),
                    scrapHeight: glass.width,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 5),
                    filmLength: glass.width + 20
                });
            } else {
                const fullSegments = Math.floor(glass.height / filmWidth);
                const remaining = glass.height - (fullSegments * filmWidth);
                const topPart = Math.floor(remaining / 2);
                const bottomPart = remaining - topPart;
                const scrapWidth = topPart > 0 ? (filmWidth - topPart) : 0;
                const usableScraps = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth && maxReq <= glass.width) ||
                           (minReq <= glass.width && maxReq <= scrapWidth);
                });
                
                plans.push({
                    id: 1,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥,ä»é¡¶éƒ¨å¼€å§‹é“ºè®¾',
                    segments: hSegmentsNeeded,
                    segmentHeights: Array(fullSegments).fill(filmWidth).concat([remaining]),
                    method: 'horizontal',
                    stitchPosition: filmWidth,
                    scrapWidth: Math.max(0, filmWidth - remaining),
                    scrapHeight: glass.width,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 6),
                    filmLength: glass.width + 20
                });
                
                plans.push({
                    id: 2,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥,ä»åº•éƒ¨å¼€å§‹é“ºè®¾',
                    segments: hSegmentsNeeded,
                    segmentHeights: [remaining].concat(Array(fullSegments).fill(filmWidth)),
                    method: 'horizontal',
                    stitchPosition: remaining,
                    scrapWidth: Math.max(0, filmWidth - remaining),
                    scrapHeight: glass.width,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 6),
                    filmLength: glass.width + 20
                });
            }
            
            if (hSegmentsNeeded >= 3) {
                const fullSegments = Math.floor(glass.height / filmWidth);
                const remaining = glass.height - (fullSegments * filmWidth);
                const topPart = Math.floor(remaining / 2);
                const bottomPart = remaining - topPart;
                const scrapWidth = topPart > 0 ? (filmWidth - topPart) : 0;
                const usableScraps = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth && maxReq <= glass.width) ||
                           (minReq <= glass.width && maxReq <= scrapWidth);
                });
                
                const segHeights = topPart > 0 ? [topPart].concat(Array(fullSegments).fill(filmWidth)).concat([bottomPart]) : Array(fullSegments).fill(filmWidth);
                const totalSegs = topPart > 0 ? fullSegments + 2 : fullSegments;
                
                plans.push({
                    id: 3,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥-å±…ä¸­é“ºè®¾',
                    segments: totalSegs,
                    segmentHeights: segHeights,
                    method: 'horizontal',
                    stitchPosition: topPart > 0 ? topPart : filmWidth,
                    stitchPosition2: topPart > 0 ? topPart + filmWidth : 2 * filmWidth,
                    scrapWidth: Math.max(0, scrapWidth),
                    scrapHeight: glass.width,
                    usableScraps: topPart > 0 ? usableScraps.length * 2 : 0,
                    scrapArea: topPart > 0 ? usableScraps.reduce((s, g) => s + g.area(), 0) * 2 : 0,
                    scrapList: usableScraps.slice(0, 6),
                    filmLength: glass.width + 20
                });
            } else {
                plans.push({
                    id: 3,
                    description: 'è†œææ¨ªå‘æ‹¼æ¥-å±…ä¸­é“ºè®¾(åŒæ–¹æ¡ˆä¸€)',
                    segments: 2,
                    segmentHeights: [filmWidth, glass.height - filmWidth],
                    method: 'horizontal',
                    stitchPosition: filmWidth,
                    scrapWidth: Math.max(0, filmWidth - (glass.height - filmWidth)),
                    scrapHeight: glass.width,
                    usableScraps: 0,
                    scrapArea: 0,
                    scrapList: [],
                    filmLength: glass.width + 20
                });
            }
            
            if (vSegmentsNeeded === 2) {
                const part2Width = glass.width - filmWidth;
                const scrapWidth4 = filmWidth - part2Width;
                const usableScraps4 = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth4 && maxReq <= glass.height) ||
                           (minReq <= glass.height && maxReq <= scrapWidth4);
                });
                
                plans.push({
                    id: 4,
                    description: 'è†œæçºµå‘æ‹¼æ¥,ä»å·¦ä¾§å¼€å§‹é“ºè®¾',
                    segments: 2,
                    segmentWidths: [filmWidth, part2Width],
                    method: 'vertical',
                    stitchPosition: filmWidth,
                    scrapWidth: Math.max(0, scrapWidth4),
                    scrapHeight: glass.height,
                    usableScraps: usableScraps4.length,
                    scrapArea: usableScraps4.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps4.slice(0, 5),
                    filmLength: glass.height + 20
                });
                
                plans.push({
                    id: 5,
                    description: 'è†œæçºµå‘æ‹¼æ¥,ä»å³ä¾§å¼€å§‹é“ºè®¾',
                    segments: 2,
                    segmentWidths: [part2Width, filmWidth],
                    method: 'vertical',
                    stitchPosition: part2Width,
                    scrapWidth: Math.max(0, scrapWidth4),
                    scrapHeight: glass.height,
                    usableScraps: usableScraps4.length,
                    scrapArea: usableScraps4.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps4.slice(0, 5),
                    filmLength: glass.height + 20
                });
            } else if (vSegmentsNeeded === 3) {
                const remaining = glass.width - 2 * filmWidth;
                const scrapWidth = filmWidth - remaining;
                const usableScraps = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth && maxReq <= glass.height) ||
                           (minReq <= glass.height && maxReq <= scrapWidth);
                });
                
                plans.push({
                    id: 4,
                    description: 'è†œæçºµå‘æ‹¼æ¥,ä»å·¦ä¾§å¼€å§‹é“ºè®¾',
                    segments: 3,
                    segmentWidths: [filmWidth, filmWidth, remaining],
                    method: 'vertical',
                    stitchPosition: filmWidth,
                    stitchPosition2: 2 * filmWidth,
                    scrapWidth: Math.max(0, scrapWidth),
                    scrapHeight: glass.height,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 5),
                    filmLength: glass.height + 20
                });
                
                plans.push({
                    id: 5,
                    description: 'è†œæçºµå‘æ‹¼æ¥,ä»å³ä¾§å¼€å§‹é“ºè®¾',
                    segments: 3,
                    segmentWidths: [remaining, filmWidth, filmWidth],
                    method: 'vertical',
                    stitchPosition: remaining,
                    stitchPosition2: remaining + filmWidth,
                    scrapWidth: Math.max(0, scrapWidth),
                    scrapHeight: glass.height,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 5),
                    filmLength: glass.height + 20
                });
            } else {
                const fullSegments = Math.floor(glass.width / filmWidth);
                const remaining = glass.width - (fullSegments * filmWidth);
                const leftPart = Math.floor(remaining / 2);
                const scrapWidth = leftPart > 0 ? (filmWidth - leftPart) : 0;
                const usableScraps = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth && maxReq <= glass.height) ||
                           (minReq <= glass.height && maxReq <= scrapWidth);
                });
                
                plans.push({
                    id: 4,
                    description: `è†œæçºµå‘æ‹¼æ¥,ä»å·¦ä¾§å¼€å§‹é“ºè®¾`,
                    segments: vSegmentsNeeded,
                    segmentWidths: Array(fullSegments).fill(filmWidth).concat([remaining]),
                    method: 'vertical',
                    stitchPosition: filmWidth,
                    scrapWidth: Math.max(0, filmWidth - remaining),
                    scrapHeight: glass.height,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 6),
                    filmLength: glass.height + 20
                });
                
                plans.push({
                    id: 5,
                    description: `è†œæçºµå‘æ‹¼æ¥,ä»å³ä¾§å¼€å§‹é“ºè®¾`,
                    segments: vSegmentsNeeded,
                    segmentWidths: [remaining].concat(Array(fullSegments).fill(filmWidth)),
                    method: 'vertical',
                    stitchPosition: remaining,
                    scrapWidth: Math.max(0, filmWidth - remaining),
                    scrapHeight: glass.height,
                    usableScraps: usableScraps.length,
                    scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0),
                    scrapList: usableScraps.slice(0, 6),
                    filmLength: glass.height + 20
                });
            }
            
            if (vSegmentsNeeded >= 3) {
                const fullSegments = Math.floor(glass.width / filmWidth);
                const remaining = glass.width - (fullSegments * filmWidth);
                const leftPart = Math.floor(remaining / 2);
                const rightPart = remaining - leftPart;
                const scrapWidth = leftPart > 0 ? (filmWidth - leftPart) : 0;
                const usableScraps = candidates.filter(s => {
                    const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                    const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                    return (minReq <= scrapWidth && maxReq <= glass.height) ||
                           (minReq <= glass.height && maxReq <= scrapWidth);
                });
                
                const segWidths = leftPart > 0 ? [leftPart].concat(Array(fullSegments).fill(filmWidth)).concat([rightPart]) : Array(fullSegments).fill(filmWidth);
                const totalSegs = leftPart > 0 ? fullSegments + 2 : fullSegments;
                
                plans.push({
                    id: 6,
                    description: 'è†œæçºµå‘æ‹¼æ¥-å±…ä¸­é“ºè®¾',
                    segments: totalSegs,
                    segmentWidths: segWidths,
                    method: 'vertical',
                    stitchPosition: leftPart > 0 ? leftPart : filmWidth,
                    stitchPosition2: leftPart > 0 ? leftPart + filmWidth : 2 * filmWidth,
                    scrapWidth: Math.max(0, scrapWidth),
                    scrapHeight: glass.height,
                    usableScraps: leftPart > 0 ? usableScraps.length * 2 : 0,
                    scrapArea: leftPart > 0 ? usableScraps.reduce((s, g) => s + g.area(), 0) * 2 : 0,
                    scrapList: usableScraps.slice(0, 6),
                    filmLength: glass.height + 20
                });
            } else if (vSegmentsNeeded === 2) {
                const remaining = glass.width - filmWidth;
                const leftPart = Math.floor(remaining / 2);
                const rightPart = remaining - leftPart;
                
                if (leftPart > 0) {
                    const segWidths = [leftPart, filmWidth, rightPart];
                    const scrapWidth = filmWidth - leftPart;
                    const usableScraps = candidates.filter(s => {
                        const minReq = s.minSide() + 2 * SCRAP_MARGIN;
                        const maxReq = s.maxSide() + 2 * SCRAP_MARGIN;
                        return (minReq <= scrapWidth && maxReq <= glass.height) ||
                               (minReq <= glass.height && maxReq <= scrapWidth);
                    });
                    
                    plans.push({
                        id: 6,
                        description: 'è†œæçºµå‘æ‹¼æ¥-å±…ä¸­é“ºè®¾',
                        segments: 3,
                        segmentWidths: segWidths,
                        method: 'vertical',
                        stitchPosition: leftPart,
                        stitchPosition2: leftPart + filmWidth,
                        scrapWidth: Math.max(0, scrapWidth),
                        scrapHeight: glass.height,
                        usableScraps: usableScraps.length * 2,
                        scrapArea: usableScraps.reduce((s, g) => s + g.area(), 0) * 2,
                        scrapList: usableScraps.slice(0, 6),
                        filmLength: glass.height + 20
                    });
                } else {
                    const segWidths = [filmWidth, remaining];
                    const scrapWidth = filmWidth - remaining;
                    
                    plans.push({
                        id: 6,
                        description: 'è†œæçºµå‘æ‹¼æ¥-å±…ä¸­é“ºè®¾(åŒæ–¹æ¡ˆå››)',
                        segments: 2,
                        segmentWidths: segWidths,
                        method: 'vertical',
                        stitchPosition: filmWidth,
                        scrapWidth: Math.max(0, scrapWidth),
                        scrapHeight: glass.height,
                        usableScraps: 0,
                        scrapArea: 0,
                        scrapList: [],
                        filmLength: glass.height + 20
                    });
                }
            } else {
                plans.push({
                    id: 6,
                    description: 'è†œæçºµå‘æ‹¼æ¥-å±…ä¸­é“ºè®¾(æ— éœ€æ‹¼æ¥)',
                    segments: 1,
                    segmentWidths: [glass.width],
                    method: 'vertical',
                    stitchPosition: 0,
                    scrapWidth: 0,
                    scrapHeight: glass.height,
                    usableScraps: 0,
                    scrapArea: 0,
                    scrapList: [],
                    filmLength: glass.height + 20
                });
            }
            
            return plans;
        }

        let currentSelectingGlass = null;
        let currentGlassPlans = [];
        let currentSelectedPlan = null;
        
        function showSingleGlassPlanSelection(glass, candidates) {
            currentSelectingGlass = glass;
            
            const sameProductCandidates = candidates.filter(c => c.product === glass.product);
            currentGlassPlans = generateSixPlans(glass, FILM_WIDTH, sameProductCandidates);
            
            currentSelectedPlan = currentGlassPlans[3];
            
            const glassInfo = `ç»ç’ƒè§„æ ¼:${glass.width}Ã—${glass.height}mm | çª—æˆ·:${glass.baseId} | äº§å“:${glass.product}`;
            document.getElementById('currentGlassInfo').textContent = glassInfo;
            
            const plansDiv = document.getElementById('sixPlansDisplay');
            plansDiv.innerHTML = currentGlassPlans.map((plan) => {
                const isSelected = plan.id === currentSelectedPlan.id;
                const isRecommended = plan.scrapArea > 0 && plan.segments === 2;
                
                let borderColor = 'border-gray-300 bg-white';
                if (isSelected && isRecommended) {
                    borderColor = 'border-primary-red bg-light-blue';
                } else if (isSelected) {
                    borderColor = 'border-primary-red bg-light-blue';
                } else if (isRecommended) {
                    borderColor = 'border-light-tan bg-white';
                }
                
                const svgContent = generatePlanDiagram(plan, glass);
                
                let layoutDetails = '';
                let description = plan.description;
                
                if (plan.method === 'horizontal') {
                    if (plan.segmentHeights && plan.segmentHeights.length > 0) {
                        const segments = plan.segmentHeights.map((h, idx) => {
                            const isComplete = h === FILM_WIDTH;
                            return isComplete ? `ç¬¬${idx+1}æ®µ: å®Œæ•´è†œæ(1520mm)` : `ç¬¬${idx+1}æ®µ: å‰©ä½™${Math.round(h)}mm`;
                        });
                        layoutDetails = `
                            <p class="text-xs mb-1" style="color: var(--secondary-gray);">å¸ƒå±€è¯¦æƒ…(å…±${plan.segments}æ¡è†œæ):</p>
                            <p class="text-xs text-gray-600">${segments.join(' | ')}</p>
                        `;
                    }
                } else {
                    if (plan.segmentWidths && plan.segmentWidths.length > 0) {
                        const segments = plan.segmentWidths.map((w, idx) => {
                            const isComplete = w === FILM_WIDTH;
                            return isComplete ? `ç¬¬${idx+1}æ®µ: å®Œæ•´è†œæ(1520mm)` : `ç¬¬${idx+1}æ®µ: å‰©ä½™${Math.round(w)}mm`;
                        });
                        layoutDetails = `
                            <p class="text-xs mb-1" style="color: var(--secondary-gray);">å¸ƒå±€è¯¦æƒ…(å…±${plan.segments}æ¡è†œæ):</p>
                            <p class="text-xs text-gray-600">${segments.join(' | ')}</p>
                        `;
                    }
                }
                
                return `
                    <div class="relative border-2 ${borderColor} rounded-xl p-4 cursor-pointer transition hover:shadow-lg"
                         onclick="selectSinglePlan(${plan.id})">
                        ${isSelected ? '<div class="absolute top-3 right-3 w-6 h-6 bg-primary-red rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg></div>' : ''}
                        
                        <div class="mb-4 flex justify-center bg-white rounded-lg p-3 border border-gray-200">
                            ${svgContent}
                        </div>
                        
                        <h4 class="text-center font-bold text-lg mb-2" style="color: var(--primary-red);">
                            æ–¹æ¡ˆ${['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][plan.id - 1]}
                            ${isSelected ? ' âœ” å½“å‰é€‰æ‹©' : ''}
                        </h4>
                        
                        <p class="text-center text-sm mb-2" style="color: var(--secondary-gray);">${description}</p>
                        
                        <div class="text-center mb-3">
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-bold" style="background: var(--aux-light-tan); color: var(--secondary-gray);">
                                å…±${plan.segments}æ¡è†œæ
                            </span>
                            ${isRecommended ? '<span class="ml-2 inline-block px-2 py-1 rounded text-xs font-semibold bg-light-blue" style="color: var(--secondary-gray);">âœ” æ¨è</span>' : ''}
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-3 text-left">
                            ${layoutDetails}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('planSelectionModal').classList.remove('hidden');
        }
        
        function generatePlanDiagram(plan, glass) {
            const svgWidth = 280;
            const svgHeight = 180;
            const isHorizontal = plan.method === 'horizontal';
            
            let glassWidth, glassHeight;
            
            if (isHorizontal) {
                glassWidth = svgWidth * 0.65;
                glassHeight = svgHeight * 0.65;
            } else {
                glassWidth = svgWidth * 0.45;
                glassHeight = svgHeight * 0.65;
            }
            
            const glassX = (svgWidth - glassWidth) / 2;
            const glassY = 40;
            
            let content = '';
            
            content += `
                <rect x="${glassX}" y="${glassY}" width="${glassWidth}" height="${glassHeight}" 
                      fill="rgba(232, 245, 233, 0.3)" stroke="#27ae60" stroke-width="2.5" rx="4"/>
            `;
            
            if (isHorizontal && plan.segmentHeights) {
                const totalH = plan.segmentHeights.reduce((s, h) => s + h, 0);
                let currentY = glassY;
                
                plan.segmentHeights.forEach((h, idx) => {
                    const ratio = h / totalH;
                    const rectH = glassHeight * ratio;
                    
                    if (idx < plan.segmentHeights.length - 1) {
                        content += `
                            <line x1="${glassX}" y1="${currentY + rectH}" 
                                  x2="${glassX + glassWidth}" y2="${currentY + rectH}" 
                                  stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                        `;
                    }
                    
                    currentY += rectH;
                });
                
                const arrowCenterX = svgWidth / 2;
                const arrowCenterY = glassY + glassHeight / 2;
                const arrowLen = 24;
                
                content += `
                    <line x1="${arrowCenterX - arrowLen}" y1="${arrowCenterY}" 
                          x2="${arrowCenterX + arrowLen}" y2="${arrowCenterY}" 
                          stroke="#27ae60" stroke-width="2.5" fill="none"/>
                    <path d="M ${arrowCenterX - arrowLen} ${arrowCenterY} 
                             L ${arrowCenterX - arrowLen + 7} ${arrowCenterY - 4.5} 
                             M ${arrowCenterX - arrowLen} ${arrowCenterY} 
                             L ${arrowCenterX - arrowLen + 7} ${arrowCenterY + 4.5}" 
                          stroke="#27ae60" stroke-width="2.5" fill="none"/>
                    <path d="M ${arrowCenterX + arrowLen} ${arrowCenterY} 
                             L ${arrowCenterX + arrowLen - 7} ${arrowCenterY - 4.5} 
                             M ${arrowCenterX + arrowLen} ${arrowCenterY} 
                             L ${arrowCenterX + arrowLen - 7} ${arrowCenterY + 4.5}" 
                          stroke="#27ae60" stroke-width="2.5" fill="none"/>
                `;
            } else if (!isHorizontal && plan.segmentWidths) {
                const totalW = plan.segmentWidths.reduce((s, w) => s + w, 0);
                let currentX = glassX;
                
                plan.segmentWidths.forEach((w, idx) => {
                    const ratio = w / totalW;
                    const rectW = glassWidth * ratio;
                    
                    if (idx < plan.segmentWidths.length - 1) {
                        content += `
                            <line x1="${currentX + rectW}" y1="${glassY}" 
                                  x2="${currentX + rectW}" y2="${glassY + glassHeight}" 
                                  stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                        `;
                    }
                    
                    currentX += rectW;
                });
                
                const arrowCenterX = svgWidth / 2;
                const arrowCenterY = glassY + glassHeight / 2;
                const arrowLen = 20;
                
                content += `
                    <line x1="${arrowCenterX}" y1="${arrowCenterY - arrowLen}" 
                          x2="${arrowCenterX}" y2="${arrowCenterY + arrowLen}" 
                          stroke="#27ae60" stroke-width="2.5" fill="none"/>
                    <path d="M ${arrowCenterX} ${arrowCenterY - arrowLen} 
                             L ${arrowCenterX - 4.5} ${arrowCenterY - arrowLen + 7} 
                             M ${arrowCenterX} ${arrowCenterY - arrowLen} 
                             L ${arrowCenterX + 4.5} ${arrowCenterY - arrowLen + 7}" 
                          stroke="#27ae60" stroke-width="2.5" fill="none"/>
                    <path d="M ${arrowCenterX} ${arrowCenterY + arrowLen} 
                             L ${arrowCenterX - 4.5} ${arrowCenterY + arrowLen - 7} 
                             M ${arrowCenterX} ${arrowCenterY + arrowLen} 
                             L ${arrowCenterX + 4.5} ${arrowCenterY + arrowLen - 7}" 
                          stroke="#27ae60" stroke-width="2.5" fill="none"/>
                `;
            }
            
            return `
                <svg width="${svgWidth}" height="${svgHeight}" style="background: #fafafa; border-radius: 8px;">
                    <text x="${svgWidth/2}" y="22" text-anchor="middle" font-size="14" font-weight="bold" fill="#c62828">
                        æ–¹æ¡ˆ${['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][plan.id - 1]}
                    </text>
                    
                    ${content}
                </svg>
            `;
        }
        
        function selectSinglePlan(planId) {
            currentSelectedPlan = currentGlassPlans.find(p => p.id === planId);
            
            if (currentSelectedPlan && currentSelectingGlass) {
                selectedPlans[currentSelectingGlass.baseId] = currentSelectedPlan.id;
                
                document.getElementById('planSelectionModal').classList.add('hidden');
                
                currentSelectingGlass = null;
                currentGlassPlans = [];
                currentSelectedPlan = null;
                
                updateGlassList();
            }
        }
        
        function selectPlanForGlassInList(index) {
            const glass = glasses[index];
            
            const glassItem = new GlassItem(glass.id, glass.width, glass.height, glass.id, glass.product);
            
            const candidates = glasses.filter((g, i) => i !== index && g.product === glass.product).map(g => 
                new GlassItem(g.id, g.width, g.height, g.id, g.product)
            );
            
            showSingleGlassPlanSelection(glassItem, candidates);
        }
        
        function closePlanModal() {
            if (!currentSelectedPlan || !currentSelectingGlass) {
                document.getElementById('planSelectionModal').classList.add('hidden');
                currentSelectingGlass = null;
                currentGlassPlans = [];
                currentSelectedPlan = null;
                return;
            }
            
            selectedPlans[currentSelectingGlass.baseId] = currentSelectedPlan.id;
            
            document.getElementById('planSelectionModal').classList.add('hidden');
            
            currentSelectingGlass = null;
            currentGlassPlans = [];
            currentSelectedPlan = null;
            
            updateGlassList();
        }
        
        function optimizeGlasses(glasses, filmWidth = FILM_WIDTH) {
            logMessages = [];
            log('ğŸš€ V3.0 å‡ ä½•å½¢çŠ¶ä¼˜åŒ–ç‰ˆ + è§†å¹³çº¿æ£€æµ‹ + äº§å“éš”ç¦»', 'header');
            log('åˆ›æ–°: é•¿å®½æ¯”åˆ†ç»„ | è¾¹é•¿èšç±» | æ¿€è¿›ç»„åˆ | æ··åˆå¯†åº¦ | äº§å“ç»å¯¹éš”ç¦»', 'header');
            log('='.repeat(70), 'divider');
            
            const productGroups = {};
            glasses.forEach(g => {
                if (!productGroups[g.product]) {
                    productGroups[g.product] = [];
                }
                productGroups[g.product].push(g);
            });
            
            const firstOccurrence = {};
            glasses.forEach((g, idx) => {
                if (!(g.product in firstOccurrence)) {
                    firstOccurrence[g.product] = idx;
                }
            });
            
            const sortedProducts = Object.keys(productGroups).sort((a, b) => 
                firstOccurrence[a] - firstOccurrence[b]
            );
            
            log(`è¾“å…¥äº§å“ç±»å‹: ${sortedProducts.join(', ')}`, 'info');
            log(`æ€»ç»ç’ƒæ•°: ${glasses.length}å—`, 'info');
            sortedProducts.forEach(product => {
                log(`  ã€${product}ã€‘: ${productGroups[product].length}å—`, 'info');
            });
            log('');
            
            const allSegments = [];
            const productResults = [];
            let needsSelection = false;
            
            for (const product of sortedProducts) {
                log('', '');
                log(`â”Œ${'â”€'.repeat(68)}â”`, 'divider');
                log(`â”‚ å¼€å§‹ä¼˜åŒ–äº§å“ç»„:ã€${product}ã€‘${' '.repeat(68 - 20 - product.length)}â”‚`, 'section');
                log(`â””${'â”€'.repeat(68)}â”˜`, 'divider');
                log('');
                
                const productGlasses = productGroups[product];
                const result = optimizeProductGroup(productGlasses, product, filmWidth);
                
                if (result.needsSelection) {
                    needsSelection = true;
                    return result;
                }
                
                allSegments.push(...result.segments);
                productResults.push({
                    product: product,
                    segments: result.segments,
                    totalLength: result.totalLength,
                    utilization: result.utilization,
                    glassCount: productGlasses.length
                });
                
                log('');
                log(`â”Œ${'â”€'.repeat(68)}â”`, 'divider');
                log(`â”‚ å®Œæˆäº§å“ç»„:ã€${product}ã€‘${' '.repeat(68 - 18 - product.length)}â”‚`, 'section');
                log(`â”‚   æ€»é•¿åº¦: ${(result.totalLength/1000).toFixed(2)}m, æ®µæ•°: ${result.segments.length}, åˆ©ç”¨ç‡: ${result.utilization}%${' '.repeat(68 - 45 - (result.totalLength/1000).toFixed(2).length - result.segments.length.toString().length - result.utilization.toString().length)}â”‚`, 'section');
                log(`â””${'â”€'.repeat(68)}â”˜`, 'divider');
            }
            
            log('');
            log('='.repeat(70), 'divider');
            log('ğŸ“Š å…¨å±€æ±‡æ€»ç»Ÿè®¡', 'header');
            log('');
            
            const totalLength = allSegments.reduce((s, seg) => s + seg.length, 0);
            const totalGlassArea = glasses.reduce((sum, g) => sum + g.width * g.height * g.quantity, 0);
            const totalFilmArea = filmWidth * totalLength;
            const utilization = ((totalGlassArea / totalFilmArea) * 100).toFixed(2);
            
            productResults.forEach(pr => {
                log(`ã€${pr.product}ã€‘: ${pr.glassCount}å—ç»ç’ƒ, ${pr.segments.length}æ®µ, ${(pr.totalLength/1000).toFixed(2)}m, ${pr.utilization}%`, 'info');
            });
            
            log('');
            log('ğŸ“Š æœ€ç»ˆç»“æœ:', 'header');
            log(`  æ€»é•¿åº¦: ${(totalLength/1000).toFixed(3)}m`, 'result');
            log(`  æ€»åˆ©ç”¨ç‡: ${utilization}%`, 'result');
            log(`  æ®µæ•°: ${allSegments.length}æ®µ`, 'result');
            
            return { 
                segments: allSegments, 
                totalLength, 
                utilization, 
                logMessages,
                productResults
            };
        }
        
        function optimizeProductGroup(glasses, product, filmWidth) {
            allItems = [];
            let globalItemIndex = 0;  // å…¨å±€è®¡æ•°å™¨ç¡®ä¿IDå”¯ä¸€
            for (const glass of glasses) {
                for (let i = 1; i <= glass.quantity; i++) {
                    globalItemIndex++;
                    // ä¿®å¤bug: ä½¿ç”¨å…¨å±€ç´¢å¼•ç¡®ä¿æ¯ä¸ªGlassItemæœ‰å”¯ä¸€ID
                    // åŸæ¥çš„IDç”Ÿæˆæ–¹å¼åœ¨å¤šæ¡åŒåç»ç’ƒè®°å½•æ—¶ä¼šäº§ç”Ÿé‡å¤ID
                    allItems.push(new GlassItem(`${glass.id}_${i}_#${globalItemIndex}`, glass.width, glass.height, glass.id, product));
                }
            }
            
            const totalGlassArea = allItems.reduce((s, g) => s + g.area(), 0);
            log(`äº§å“ã€${product}ã€‘: ${allItems.length}å—ç»ç’ƒ, æ€»é¢ç§¯${(totalGlassArea/1000000).toFixed(2)}mÂ²`);
            log(`ç†è®ºæœ€çŸ­: ${(totalGlassArea/(filmWidth*1000)).toFixed(2)}m (100%åˆ©ç”¨ç‡)`, 'info');
            log('');
            
            const segments = [];
            placed = new Set();
            
            const needSelection = allItems.filter(g => {
                if (placed.has(g.id)) return false;
                if (selectedPlans[g.baseId]) return false;
                
                const sightCheck = checkSightLineConflictForGlass(g);
                return sightCheck.needsUserSelection();
            });
            
            if (needSelection.length > 0) {
                log('ã€é˜¶æ®µ0: ğŸš¨ éœ€è¦æ–¹æ¡ˆé€‰æ‹©çš„æ‹¼æ¥ç»ç’ƒ - ç¬¬ä¸€ä¼˜å…ˆçº§ã€‘', 'section');
                log(`è¯†åˆ«æ¡ä»¶: ä»»ä½•éœ€è¦æ‹¼æ¥ä¸”æ‰€æœ‰æ–¹æ¡ˆéƒ½å½±å“è§†çº¿çš„ç»ç’ƒ`, 'info');
                log(`è¯†åˆ«åˆ°${needSelection.length}ä¸ªéœ€è¦é€‰æ‹©çš„ç»ç’ƒ: ${needSelection.map(g => g.baseId).join(', ')}`, 'info');
                
                needSelection.forEach(g => {
                    const sightCheck = checkSightLineConflictForGlass(g);
                    const h = sightCheck.horizontal;
                    const v = sightCheck.vertical;
                    
                    if (h.needsSplicing && v.needsSplicing) {
                        log(`  ${g.baseId} (${g.width}Ã—${g.height}): æ¨ªå‘å’Œçºµå‘éƒ½éœ€æ‹¼æ¥`, 'info');
                        if (h.needsSplicing && g.height >= 3020) {
                            log(`    æ¨ªå‘: é«˜åº¦${g.height}éœ€3æ®µæˆ–ä»¥ä¸Š`, 'info');
                        } else if (h.bothConflict) {
                            log(`    æ¨ªå‘: ä¸¤æ–¹æ¡ˆéƒ½åœ¨è§†å¹³çº¿å†… (${h.stitch1Position}mm, ${h.stitch2Position}mm)`, 'info');
                        }
                        log(`    çºµå‘: æ‹¼æ¥ç¼æ˜¯å‚ç›´çš„,å¿…ç„¶ç©¿è¶Šè§†å¹³çº¿ âœ˜`, 'info');
                    } else if (h.needsSplicing) {
                        if (g.height >= 3020) {
                            log(`  ${g.baseId} (${g.width}Ã—${g.height}): æ¨ªå‘éœ€æ‹¼æ¥,é«˜åº¦${g.height}éœ€3æ®µæˆ–ä»¥ä¸Š`, 'info');
                        } else {
                            log(`  ${g.baseId} (${g.width}Ã—${g.height}): æ¨ªå‘éœ€æ‹¼æ¥,ä¸¤æ–¹æ¡ˆéƒ½åœ¨è§†å¹³çº¿å†… (${h.stitch1Position}mm, ${h.stitch2Position}mm)`, 'info');
                        }
                    } else if (v.needsSplicing) {
                        log(`  ${g.baseId} (${g.width}Ã—${g.height}): çºµå‘éœ€æ‹¼æ¥,æ‹¼æ¥ç¼æ˜¯å‚ç›´çš„,å¿…ç„¶ç©¿è¶Šè§†å¹³çº¿ âœ˜`, 'info');
                    }
                });
                log('');
                log('âš ï¸ è¯·å…ˆä¸ºè¿™äº›ç»ç’ƒé€‰æ‹©æ‹¼æ¥æ–¹æ¡ˆ,ç„¶åå†æ¬¡ç‚¹å‡»"æ‰§è¡Œä¼˜åŒ–ç®—æ³•"', 'error');
                log('', '');
                
                const firstGlass = needSelection[0];
                const remaining = allItems.filter(g => !placed.has(g.id) && g.id !== firstGlass.id && g.product === product);
                
                showSingleGlassPlanSelection(firstGlass, remaining);
                
                displayLogsOnly(logMessages);
                
                return { needsSelection: true, logMessages };
            }
            
            return continueOptimizationAfterStage0({ allItems, segments, placed, totalGlassArea, product });
        }

        function continueOptimizationAfterStage0(state) {
            const { allItems, segments, placed, totalGlassArea, product } = state;
            const filmWidth = FILM_WIDTH;
            
            const glassesWithSelectedPlans = allItems.filter(g => 
                selectedPlans[g.baseId] && !placed.has(g.id)
            );
            
            if (glassesWithSelectedPlans.length > 0) {
                log('', '');
                log('ã€é˜¶æ®µ0: å¤„ç†å·²é€‰æ–¹æ¡ˆçš„ç»ç’ƒã€‘', 'section');
                
                const groupedByBase = {};
                glassesWithSelectedPlans.forEach(glass => {
                    if (!groupedByBase[glass.baseId]) {
                        groupedByBase[glass.baseId] = [];
                    }
                    groupedByBase[glass.baseId].push(glass);
                });
                
                for (const [baseId, glassGroup] of Object.entries(groupedByBase)) {
                    const glass = glassGroup[0];
                    const chosenPlanId = selectedPlans[baseId];
                    
                    const remaining = allItems.filter(g => !placed.has(g.id) && g.baseId !== baseId && g.product === product);
                    const plans = generateSixPlans(glass, FILM_WIDTH, remaining);
                    const chosenPlan = plans.find(p => p.id === chosenPlanId);
                    
                    if (!chosenPlan) continue;
                    
                    log(`  å¤„ç†ç»ç’ƒ ${baseId} (${glass.width}Ã—${glass.height}) - ${glassGroup.length}ç‰‡`, 'info');
                    log(`  âœ” å®¢æˆ·é€‰æ‹©æ–¹æ¡ˆ${chosenPlan.id}: ${chosenPlan.description}`, 'success');
                    
                    glassGroup.forEach(g => {
                        const scrapArea = new ScrapArea(chosenPlan.scrapWidth, chosenPlan.scrapHeight, `${g.id}_scrap`);
                        const fillResult = optimizeScrapFilling(scrapArea, remaining, SCRAP_MARGIN);
                        
                        if (fillResult.success) {
                            log(`    âœ… ${g.id} ä½™æ–™ä¼˜åŒ–: ${fillResult.placedCount}å— ${fillResult.placedGlasses.map(p => p.glass.id).join(',')}, åˆ©ç”¨ç‡${(fillResult.utilization * 100).toFixed(1)}% [${fillResult.strategy}+Skyline]`, 'success');
                            fillResult.placedGlasses.forEach(p => placed.add(p.glass.id));
                        }
                        
                        const filmLength = chosenPlan.filmLength;
                        
                        if (chosenPlan.method === 'horizontal') {
                            if (chosenPlan.segments === 2) {
                                const part1Height = chosenPlan.segmentHeights[0];
                                const part2Height = chosenPlan.segmentHeights[1];
                                
                                const p1HasScrap = (part1Height < FILM_WIDTH);
                                const p2HasScrap = (part2Height < FILM_WIDTH);
                                
                                segments.push({
                                    name: `${product}_${g.baseId}_P1`,
                                    length: filmLength,
                                    mainGlassArea: part1Height * glass.width,
                                    mainGlassIds: [g.id],
                                    scrapArea: p1HasScrap ? chosenPlan.scrapWidth * chosenPlan.scrapHeight : 0,
                                    scrapWidth: p1HasScrap ? chosenPlan.scrapWidth : 0,
                                    scrapHeight: p1HasScrap ? chosenPlan.scrapHeight : 0,
                                    scrapGlassArea: (p1HasScrap && fillResult.success) ? fillResult.usedArea : 0,
                                    scrapGlassIds: (p1HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [],
                                    glasses: [g.id, ...((p1HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [])],
                                    product: product
                                });
                                
                                segments.push({
                                    name: `${product}_${g.baseId}_P2`,
                                    length: filmLength,
                                    mainGlassArea: part2Height * glass.width,
                                    mainGlassIds: [g.id],
                                    scrapArea: p2HasScrap ? chosenPlan.scrapWidth * chosenPlan.scrapHeight : 0,
                                    scrapWidth: p2HasScrap ? chosenPlan.scrapWidth : 0,
                                    scrapHeight: p2HasScrap ? chosenPlan.scrapHeight : 0,
                                    scrapGlassArea: (p2HasScrap && fillResult.success) ? fillResult.usedArea : 0,
                                    scrapGlassIds: (p2HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [],
                                    glasses: [g.id, ...((p2HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [])],
                                    product: product
                                });
                            } else {
                                for (let i = 0; i < chosenPlan.segments; i++) {
                                    const isFirstOrLast = i === 0 || i === chosenPlan.segments - 1;
                                    const hasScrap = isFirstOrLast && chosenPlan.scrapWidth > 0;
                                    
                                    segments.push({
                                        name: `${product}_${g.baseId}_P${i+1}`,
                                        length: filmLength,
                                        mainGlassArea: (glass.height / chosenPlan.segments) * glass.width,
                                        mainGlassIds: [g.id],
                                        scrapArea: hasScrap ? chosenPlan.scrapWidth * chosenPlan.scrapHeight : 0,
                                        scrapWidth: hasScrap ? chosenPlan.scrapWidth : 0,
                                        scrapHeight: hasScrap ? chosenPlan.scrapHeight : 0,
                                        scrapGlassArea: 0,
                                        scrapGlassIds: [],
                                        glasses: [g.id],
                                        product: product
                                    });
                                }
                            }
                        } else {
                            if (chosenPlan.segments === 2) {
                                const part1Width = chosenPlan.segmentWidths[0];
                                const part2Width = chosenPlan.segmentWidths[1];
                                
                                const p1HasScrap = (part1Width < FILM_WIDTH);
                                const p2HasScrap = (part2Width < FILM_WIDTH);
                                
                                segments.push({
                                    name: `${product}_${g.baseId}_P1`,
                                    length: filmLength,
                                    mainGlassArea: part1Width * glass.height,
                                    mainGlassIds: [g.id],
                                    scrapArea: p1HasScrap ? chosenPlan.scrapWidth * chosenPlan.scrapHeight : 0,
                                    scrapWidth: p1HasScrap ? chosenPlan.scrapWidth : 0,
                                    scrapHeight: p1HasScrap ? chosenPlan.scrapHeight : 0,
                                    scrapGlassArea: (p1HasScrap && fillResult.success) ? fillResult.usedArea : 0,
                                    scrapGlassIds: (p1HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [],
                                    glasses: [g.id, ...((p1HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [])],
                                    product: product
                                });
                                
                                segments.push({
                                    name: `${product}_${g.baseId}_P2`,
                                    length: filmLength,
                                    mainGlassArea: part2Width * glass.height,
                                    mainGlassIds: [g.id],
                                    scrapArea: p2HasScrap ? chosenPlan.scrapWidth * chosenPlan.scrapHeight : 0,
                                    scrapWidth: p2HasScrap ? chosenPlan.scrapWidth : 0,
                                    scrapHeight: p2HasScrap ? chosenPlan.scrapHeight : 0,
                                    scrapGlassArea: (p2HasScrap && fillResult.success) ? fillResult.usedArea : 0,
                                    scrapGlassIds: (p2HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [],
                                    glasses: [g.id, ...((p2HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [])],
                                    product: product
                                });
                            } else {
                                for (let i = 0; i < chosenPlan.segments; i++) {
                                    const isFirstOrLast = i === 0 || i === chosenPlan.segments - 1;
                                    const hasScrap = isFirstOrLast && chosenPlan.scrapWidth > 0;
                                    
                                    segments.push({
                                        name: `${product}_${g.baseId}_P${i+1}`,
                                        length: filmLength,
                                        mainGlassArea: (glass.width / chosenPlan.segments) * glass.height,
                                        mainGlassIds: [g.id],
                                        scrapArea: hasScrap ? chosenPlan.scrapWidth * chosenPlan.scrapHeight : 0,
                                        scrapWidth: hasScrap ? chosenPlan.scrapWidth : 0,
                                        scrapHeight: hasScrap ? chosenPlan.scrapHeight : 0,
                                        scrapGlassArea: 0,
                                        scrapGlassIds: [],
                                        glasses: [g.id],
                                        product: product
                                    });
                                }
                            }
                        }
                        
                        placed.add(g.id);
                    });
                    
                    log(`  å®Œæˆ: ${chosenPlan.segments}æ®µ Ã— ${glassGroup.length}ç‰‡`, 'success');
                    log('');
                }
            }
            
            const autoSplicing = allItems.filter(g => {
                if (placed.has(g.id)) return false;
                
                const sightCheck = checkSightLineConflictForGlass(g);
                return sightCheck.canAutoSplice();
            });
            
            if (autoSplicing.length > 0) {
                log('', '');
                log('ã€é˜¶æ®µ1: ğŸ”§ å¯è‡ªåŠ¨æ¨ªå‘æ‹¼æ¥çš„ç»ç’ƒ - ç¬¬äºŒä¼˜å…ˆçº§ã€‘', 'section');
                log(`è¯†åˆ«åˆ°${autoSplicing.length}ä¸ª: ${autoSplicing.map(g => g.id).join(', ')}`, 'info');
                log(`æ¡ä»¶: æ¨ªå‘æ‹¼æ¥2æ®µ(heightåœ¨1520-3020ä¹‹é—´), ä¸”è‡³å°‘ä¸€ä¸ªæ–¹æ¡ˆä¸åœ¨è§†å¹³çº¿${SIGHT_LINE_MIN}-${SIGHT_LINE_MAX}mmå†…`, 'info');
                log('');
                
                for (const glass of autoSplicing) {
                    const sightCheck = checkSightLineConflictForGlass(glass);
                    const h = sightCheck.horizontal;
                    
                    const verticalSize = glass.height;
                    const horizontalSize = glass.width;
                    
                    let useTopStart = true;
                    if (h.stitch1Conflict && !h.stitch2Conflict) {
                        useTopStart = false;
                    }
                    
                    const filmLength = horizontalSize + 20;
                    const part1Height = useTopStart ? FILM_WIDTH : (verticalSize - FILM_WIDTH);
                    const part2Height = verticalSize - part1Height;
                    const scrapWidth = FILM_WIDTH - (verticalSize - FILM_WIDTH);
                    
                    log(`  å¤„ç† ${glass.id} (${glass.width}Ã—${glass.height}) [æ¨ªå‘æ‹¼æ¥,é«˜åº¦${verticalSize}éœ€2æ®µ]`, 'info');
                    log(`    è§†å¹³çº¿æ£€æŸ¥: æ–¹æ¡ˆ1æ‹¼æ¥ç¼${h.stitch1Position}mm${h.stitch1Conflict?'âœ˜':'âœ…'}, æ–¹æ¡ˆ2æ‹¼æ¥ç¼${h.stitch2Position}mm${h.stitch2Conflict?'âœ˜':'âœ…'}`, 'info');
                    log(`    è‡ªåŠ¨é€‰æ‹©: ${useTopStart ? 'æ–¹æ¡ˆ1(ä»é¡¶éƒ¨å¼€å§‹)' : 'æ–¹æ¡ˆ2(ä»åº•éƒ¨å¼€å§‹)'}`, 'success');
                    
                    const remaining = allItems.filter(g => !placed.has(g.id) && g.id !== glass.id && g.product === product);
                    const scrapArea = new ScrapArea(scrapWidth, horizontalSize, `${glass.id}_P${useTopStart?1:2}`);
                    const fillResult = optimizeScrapFilling(scrapArea, remaining, SCRAP_MARGIN);
                    
                    const p1HasScrap = (part1Height < FILM_WIDTH);
                    const p2HasScrap = (part2Height < FILM_WIDTH);
                    
                    segments.push({
                        name: `${product}_${glass.baseId}_P1`,
                        length: filmLength,
                        mainGlassArea: part1Height * horizontalSize,
                        mainGlassIds: [glass.id],
                        scrapArea: p1HasScrap ? scrapWidth * horizontalSize : 0,
                        scrapWidth: p1HasScrap ? scrapWidth : 0,
                        scrapHeight: p1HasScrap ? horizontalSize : 0,
                        scrapGlassArea: (p1HasScrap && fillResult.success) ? fillResult.usedArea : 0,
                        scrapGlassIds: (p1HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [],
                        glasses: [glass.id, ...((p1HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [])],
                        product: product
                    });
                    
                    segments.push({
                        name: `${product}_${glass.baseId}_P2`,
                        length: filmLength,
                        mainGlassArea: part2Height * horizontalSize,
                        mainGlassIds: [glass.id],
                        scrapArea: p2HasScrap ? scrapWidth * horizontalSize : 0,
                        scrapWidth: p2HasScrap ? scrapWidth : 0,
                        scrapHeight: p2HasScrap ? horizontalSize : 0,
                        scrapGlassArea: (p2HasScrap && fillResult.success) ? fillResult.usedArea : 0,
                        scrapGlassIds: (p2HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [],
                        glasses: [glass.id, ...((p2HasScrap && fillResult.success) ? fillResult.placedGlasses.map(p => p.glass.id) : [])],
                        product: product
                    });
                    
                    if (fillResult.success) {
                        log(`    âœ… ä½™æ–™ä¼˜åŒ–: ${fillResult.placedCount}å—, åˆ©ç”¨ç‡${(fillResult.utilization * 100).toFixed(1)}% [${fillResult.strategy}+Skyline]`, 'success');
                        fillResult.placedGlasses.forEach(p => placed.add(p.glass.id));
                    }
                    
                    placed.add(glass.id);
                    log(`    å®Œæˆ: 2æ®µ Ã— ${(filmLength/1000).toFixed(2)}m`, 'success');
                    log('');
                }
            }
            
            const nearWidth = allItems.filter(g => {
                if (placed.has(g.id)) return false;
                
                const shortSide = g.minSide();
                const longSide = g.maxSide();
                
                const isNearWidth = (shortSide >= NEAR_WIDTH_MIN && 
                                    shortSide <= FILM_WIDTH && 
                                    longSide <= FILM_MAX_LENGTH);
                
                return isNearWidth;
            });
            
            if (nearWidth.length > 0) {
                log('', '');
                log('ã€é˜¶æ®µ2: ğŸ“ è¿‘å®½å¹…ç»ç’ƒ - ç¬¬ä¸‰ä¼˜å…ˆçº§ã€‘', 'section');
                log(`è¯†åˆ«åˆ°${nearWidth.length}å—: ${nearWidth.map(g => g.id).join(', ')}`, 'info');
                log('æ ‡å‡†: çŸ­è¾¹åœ¨1300-1520mmä¹‹é—´,é•¿è¾¹â‰¤30000mm', 'info');
                
                for (const glass of nearWidth) {
                    const filmLength = glass.maxSide() + 20;
                    
                    segments.push({
                        name: `${product}_${glass.id}`,
                        length: filmLength,
                        mainGlassArea: glass.area(),
                        mainGlassIds: [glass.id],
                        scrapArea: 0,
                        scrapWidth: 0,
                        scrapHeight: 0,
                        scrapGlassArea: 0,
                        scrapGlassIds: [],
                        glasses: [glass.id],
                        product: product
                    });
                    placed.add(glass.id);
                    
                    const util = ((glass.area()/(filmWidth*filmLength))*100).toFixed(1);
                    log(`  âœ… ${glass.id}: ${(filmLength/1000).toFixed(2)}m, ${util}%`, 'success');
                }
                log('');
            }
            
            log('');
            log('='.repeat(70), 'divider');
            log('ã€é˜¶æ®µ3: ğŸ“¦ å…¶ä»–å‰©ä½™ç»ç’ƒ - ç¬¬å››ä¼˜å…ˆçº§ã€‘', 'section');
            log('æ­¥éª¤1: ä½™æ–™åŒºå›å¡« âœ æ­¥éª¤2: V3.0å¤šç­–ç•¥å¹¶è¡Œ', 'info');
            log('ç­–ç•¥A-é•¿å®½æ¯” | ç­–ç•¥B-è¾¹é•¿èšç±» | ç­–ç•¥C-æ¿€è¿›ç»„åˆ | ç­–ç•¥D-æ··åˆå¯†åº¦', 'info');
            log('');
            
            let remainingForBackfill = allItems.filter(g => !placed.has(g.id));
            
            if (remainingForBackfill.length > 0) {
                log(`å‰©ä½™${remainingForBackfill.length}å—å¾…å›å¡«: ${remainingForBackfill.map(g => g.id).join(', ')}`, 'info');
                
                for (let i = 0; i < segments.length; i++) {
                    const seg = segments[i];
                    
                    if (!seg.scrapWidth || !seg.scrapHeight || seg.scrapWidth < SCRAP_MIN_SIZE || seg.scrapHeight < SCRAP_MIN_SIZE) {
                        continue;
                    }
                    
                    const remainingScrapArea = seg.scrapArea - seg.scrapGlassArea;
                    if (remainingScrapArea < SCRAP_MIN_SIZE * SCRAP_MIN_SIZE) {
                        continue;
                    }
                    
                    if (seg.scrapGlassIds && seg.scrapGlassIds.length > 0) {
                        continue;
                    }
                    
                    const scrapArea = new ScrapArea(seg.scrapWidth, seg.scrapHeight, seg.name);
                    const fillResult = optimizeScrapFilling(scrapArea, remainingForBackfill, SCRAP_MARGIN);
                    
                    if (fillResult.success) {
                        fillResult.placedGlasses.forEach(p => {
                            seg.glasses.push(p.glass.id);
                            seg.scrapGlassIds.push(p.glass.id);
                            placed.add(p.glass.id);
                        });
                        
                        seg.scrapGlassArea = fillResult.usedArea;
                        
                        log(`  âœ… æ®µ${i+1}(${seg.name}) å›å¡«${fillResult.placedCount}å—: ${fillResult.placedGlasses.map(p => p.glass.id).join(', ')}, åˆ©ç”¨ç‡${(fillResult.utilization*100).toFixed(1)}% [${fillResult.strategy}+Skyline]`, 'success');
                        remainingForBackfill = allItems.filter(g => !placed.has(g.id));
                        
                        if (remainingForBackfill.length === 0) {
                            log(`  ğŸ‰ æ‰€æœ‰å°ç»ç’ƒå·²å›å¡«å®Œæ¯•`, 'success');
                            break;
                        }
                    }
                }
                log('');
            }
            
            let remaining = allItems.filter(g => !placed.has(g.id));
            
            if (remaining.length > 0) {
                log(`æ­¥éª¤2: V3.0å¤šç­–ç•¥ç»„åˆæ–°æ®µ (å‰©ä½™${remaining.length}å—)`, 'info');
                log('');
                
                const optimizedSegments = optimizeRemainingGlassesWithMultipleStrategies(remaining, filmWidth);
                
                optimizedSegments.forEach(seg => {
                    seg.name = `${product}_${seg.name}`;
                    seg.product = product;
                    segments.push(seg);
                    seg.glasses.forEach(id => placed.add(id));
                });
                
                log('');
            }
            
            log('');
            log('='.repeat(70), 'divider');
            const totalLength = segments.reduce((s, seg) => s + seg.length, 0);
            const totalFilmArea = filmWidth * totalLength;
            
            const totalMainGlassArea = segments.reduce((s, seg) => s + (seg.mainGlassArea || 0), 0);
            const totalScrapGlassArea = segments.reduce((s, seg) => s + (seg.scrapGlassArea || 0), 0);
            const totalGlassAreaUsed = totalMainGlassArea + totalScrapGlassArea;
            
            log('ğŸ“Š é¢ç§¯ç»Ÿè®¡:', 'info');
            log(`  ä¸»ç»ç’ƒæ€»é¢ç§¯: ${(totalMainGlassArea/1000000).toFixed(2)}mÂ²`, 'info');
            log(`  ä½™æ–™åŒºç»ç’ƒé¢ç§¯: ${(totalScrapGlassArea/1000000).toFixed(2)}mÂ²`, 'info');
            log(`  ä½¿ç”¨ç»ç’ƒæ€»é¢ç§¯: ${(totalGlassAreaUsed/1000000).toFixed(2)}mÂ²`, 'info');
            log(`  è†œè†œæ€»é¢ç§¯: ${(totalFilmArea/1000000).toFixed(2)}mÂ²`, 'info');
            log(`  è¾“å…¥ç»ç’ƒæ€»é¢ç§¯: ${(totalGlassArea/1000000).toFixed(2)}mÂ²`, 'info');
            
            const utilization = ((totalGlassArea / totalFilmArea) * 100).toFixed(2);
            
            return { segments, totalLength, utilization, logMessages };
        }

        function addGlass() {
            const floor = document.getElementById('glassFloor').value;
            const room = document.getElementById('glassRoom').value;
            const windowId = document.getElementById('glassWindowId').value.trim();
            const direction = document.getElementById('glassDirection').value;
            const width = parseInt(document.getElementById('glassWidth').value);
            const height = parseInt(document.getElementById('glassHeight').value);
            const product = document.getElementById('glassProduct').value;
            const quantity = parseInt(document.getElementById('glassQuantity').value);
            
            if (!windowId) {
                alert('âš ï¸ çª—æˆ·ç¼–å·å¿…å¡«!\n\nè¯·è¾“å…¥çª—æˆ·ç¼–å·ï¼Œä¾‹å¦‚:è¥¿çª—1ã€A1ç­‰ã€‚');
                return;
            }
            
            if (!width || !height) {
                alert('âš ï¸ ç»ç’ƒå°ºå¯¸å¿…å¡«!\n\nè¯·å¡«å†™ç»ç’ƒçš„å®½åº¦å’Œé«˜åº¦ï¼ˆå•ä½:mmï¼‰ã€‚');
                return;
            }
            
            if (!quantity || quantity < 1) {
                alert('è¯·å¡«å†™æœ‰æ•ˆçš„æ•°é‡!');
                return;
            }
            
            if (!product) {
                alert('âš ï¸ äº§å“ç±»å‹å¿…å¡«!\n\nä¸ºç¡®ä¿äº§å“ç»å¯¹éš”ç¦»,æ¯å—ç»ç’ƒå¿…é¡»é€‰æ‹©äº§å“ç±»å‹ã€‚');
                return;
            }
            
            let id = '';
            if (floor && room && windowId) {
                id = `${floor.replace('æ¥¼', '')}-${room}-${windowId}`;
            } else if (windowId) {
                id = windowId;
            } else {
                id = `G${glasses.length + 1}`;
            }
            
            const glassData = { 
                id, 
                floor: floor || '-',
                room: room || '-',
                windowId: windowId || '-',
                direction: direction || '-',
                width, 
                height, 
                product: product || '-',
                quantity 
            };
            
            if (editingIndex >= 0) {
                glasses[editingIndex] = glassData;
                editingIndex = -1;
                document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
                document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
                document.getElementById('cancelEditBtn').classList.add('hidden');
            } else {
                glasses.push(glassData);
            }
            
            updateGlassList();
            
            document.getElementById('glassWidth').value = '';
            document.getElementById('glassHeight').value = '';
        }

        function updateGlassList() {
            const listDiv = document.getElementById('glassList');
            if (glasses.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-gray-400 py-8">æš‚æ— ç»ç’ƒæ•°æ®</div>';
                return;
            }
            
            listDiv.innerHTML = `
                <div class="overflow-x-auto" style="width: 100%;">
                    <table class="border-collapse" style="width: 100%; min-width: 1200px;">
                        <thead>
                            <tr class="bg-primary-gradient text-white">
                                <th class="px-3 py-3 text-left text-sm font-semibold" style="width: 13%;">æ¥¼å±‚åŒºåŸŸ</th>
                                <th class="px-3 py-3 text-left text-sm font-semibold" style="width: 8%;">çª—æˆ·ç¼–å·</th>
                                <th class="px-3 py-3 text-center text-sm font-semibold" style="width: 5%;">æœå‘</th>
                                <th class="px-3 py-3 text-left text-sm font-semibold" style="width: 11%;">å°ºå¯¸(mm)</th>
                                <th class="px-3 py-3 text-center text-sm font-semibold" style="width: 6%;">ç‰‡æ•°</th>
                                <th class="px-3 py-3 text-left text-sm font-semibold" style="width: 9%;">äº§å“ç±»å‹</th>
                                <th class="px-3 py-3 text-center text-sm font-semibold" style="width: 34%;">è£åˆ‡æ–¹æ¡ˆç¤ºæ„å›¾</th>
                                <th class="px-3 py-3 text-center text-sm font-semibold" style="width: 14%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${glasses.map((g, i) => {
                                const shortSide = Math.min(g.width, g.height);
                                const longSide = Math.max(g.width, g.height);
                                const needsSplicing = shortSide > FILM_WIDTH;
                                const isVertical = g.height > g.width;
                                
                                const sightCheck = checkSightLineConflictForGlass({
                                    width: g.width,
                                    height: g.height,
                                    minSide: () => shortSide,
                                    maxSide: () => longSide
                                });
                                const needsUserSelection = sightCheck.needsUserSelection();
                                
                                const productColor = productColors[g.product] || productColors['-'];
                                
                                let statusLabel = '';
                                let statusColor = '';
                                let statusText = '';
                                let selectedPlanDesc = '';
                                
                                const hasSelectedPlan = selectedPlans[g.id];
                                
                                const svgWidth = 120;
                                const svgHeight = 100;
                                
                                const calculateGlassRect = (glassWidth, glassHeight) => {
                                    const maxWidth = svgWidth * 0.7;
                                    const maxHeight = svgHeight * 0.7;
                                    const aspectRatio = glassWidth / glassHeight;
                                    
                                    let rectW, rectH;
                                    if (aspectRatio > maxWidth / maxHeight) {
                                        rectW = maxWidth;
                                        rectH = maxWidth / aspectRatio;
                                    } else {
                                        rectH = maxHeight;
                                        rectW = maxHeight * aspectRatio;
                                    }
                                    
                                    const rectX = (svgWidth - rectW) / 2;
                                    const rectY = 18;
                                    
                                    return { width: rectW, height: rectH, x: rectX, y: rectY };
                                };
                                
                                let svgContent = '';
                                
                                if (!needsSplicing) {
                                    statusLabel = isVertical ? 'æ•´å¹…ç«–å‘' : 'æ•´å¹…æ¨ªå‘';
                                    statusColor = 'bg-gray-200 border border-gray-300 text-[#373737]';
                                    statusText = isVertical ? 'è†œæç«–æ”¾è´´æ•·,æ— æ‹¼æ¥ç¼' : 'è†œææ¨ªæ”¾è´´æ•·,æ— æ‹¼æ¥ç¼';
                                    
                                    const glassRect = calculateGlassRect(g.width, g.height);
                                    const glassWidth = glassRect.width;
                                    const glassHeight = glassRect.height;
                                    const glassX = glassRect.x;
                                    const glassY = glassRect.y;
                                    
                                    const arrowLen = 15;
                                    
                                    svgContent = `
                                        <svg width="${svgWidth}" height="${svgHeight}" style="background: #f8f9fa; border-radius: 8px; border: 2px solid #27ae60;">
                                            <text x="${svgWidth/2}" y="12" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">
                                                ${g.width}Ã—${g.height}mm
                                            </text>
                                            
                                            <rect x="${glassX}" y="${glassY}" width="${glassWidth}" height="${glassHeight}" 
                                                  fill="rgba(232, 245, 233, 0.3)" stroke="#27ae60" stroke-width="2.5" rx="4"/>
                                            
                                            ${isVertical ? `
                                                <line x1="${svgWidth/2}" y1="${glassY + glassHeight/2 - arrowLen}" 
                                                      x2="${svgWidth/2}" y2="${glassY + glassHeight/2 + arrowLen}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${svgWidth/2} ${glassY + glassHeight/2 - arrowLen} 
                                                         L ${svgWidth/2 - 3.5} ${glassY + glassHeight/2 - arrowLen + 6} 
                                                         M ${svgWidth/2} ${glassY + glassHeight/2 - arrowLen} 
                                                         L ${svgWidth/2 + 3.5} ${glassY + glassHeight/2 - arrowLen + 6}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${svgWidth/2} ${glassY + glassHeight/2 + arrowLen} 
                                                         L ${svgWidth/2 - 3.5} ${glassY + glassHeight/2 + arrowLen - 6} 
                                                         M ${svgWidth/2} ${glassY + glassHeight/2 + arrowLen} 
                                                         L ${svgWidth/2 + 3.5} ${glassY + glassHeight/2 + arrowLen - 6}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                            ` : `
                                                <line x1="${glassX + glassWidth/2 - arrowLen}" y1="${glassY + glassHeight/2}" 
                                                      x2="${glassX + glassWidth/2 + arrowLen}" y2="${glassY + glassHeight/2}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${glassX + glassWidth/2 - arrowLen} ${glassY + glassHeight/2} 
                                                         L ${glassX + glassWidth/2 - arrowLen + 6} ${glassY + glassHeight/2 - 3.5} 
                                                         M ${glassX + glassWidth/2 - arrowLen} ${glassY + glassHeight/2} 
                                                         L ${glassX + glassWidth/2 - arrowLen + 6} ${glassY + glassHeight/2 + 3.5}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${glassX + glassWidth/2 + arrowLen} ${glassY + glassHeight/2} 
                                                         L ${glassX + glassWidth/2 + arrowLen - 6} ${glassY + glassHeight/2 - 3.5} 
                                                         M ${glassX + glassWidth/2 + arrowLen} ${glassY + glassHeight/2} 
                                                         L ${glassX + glassWidth/2 + arrowLen - 6} ${glassY + glassHeight/2 + 3.5}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                            `}
                                        </svg>
                                    `;
                                } else if (hasSelectedPlan) {
                                    statusLabel = 'å·²é€‰æ–¹æ¡ˆ - ç‚¹å‡»ä¿®æ”¹';
                                    statusColor = 'bg-gray-200 border border-gray-300 text-[#373737]';
                                    
                                    const tempItem = new GlassItem(g.id, g.width, g.height, g.id, g.product);
                                    const tempCandidates = [];
                                    const tempPlans = generateSixPlans(tempItem, FILM_WIDTH, tempCandidates);
                                    const selectedPlan = tempPlans.find(p => p.id === selectedPlans[g.id]);
                                    
                                    if (selectedPlan) {
                                        if (selectedPlan.method === 'horizontal') {
                                            if (selectedPlan.segments === 2) {
                                                const seg1 = selectedPlan.segmentHeights[0];
                                                const seg2 = selectedPlan.segmentHeights[1];
                                                const stitchFromGround = Math.min(seg1, seg2);
                                                selectedPlanDesc = `è†œææ¨ªå‘æ‹¼æ¥,æ‹¼æ¥ç¼è·åœ°${Math.round(stitchFromGround)}mm,å…±${selectedPlan.segments}æ¡è†œæ`;
                                            } else if (selectedPlan.segments === 3) {
                                                const minSeg = Math.min(...selectedPlan.segmentHeights);
                                                selectedPlanDesc = `è†œææ¨ªå‘æ‹¼æ¥,æœ€ä½æ‹¼æ¥ç¼è·åœ°${Math.round(minSeg)}mm,å…±${selectedPlan.segments}æ¡è†œæ`;
                                            } else {
                                                selectedPlanDesc = `è†œææ¨ªå‘æ‹¼æ¥,å…±${selectedPlan.segments}æ¡è†œæ`;
                                            }
                                        } else {
                                            selectedPlanDesc = `è†œæçºµå‘æ‹¼æ¥,å…±${selectedPlan.segments}æ¡è†œæ`;
                                        }
                                        
                                        statusText = selectedPlanDesc || 'å·²é€‰æ–¹æ¡ˆ';
                                        
                                        const glassRect = calculateGlassRect(g.width, g.height);
                                        const glassWidth = glassRect.width;
                                        const glassHeight = glassRect.height;
                                        const glassX = glassRect.x;
                                        const glassY = glassRect.y;
                                        
                                        let spliceLines = '';
                                        const isHoriz = selectedPlan.method === 'horizontal';
                                        
                                        if (isHoriz && selectedPlan.segmentHeights) {
                                            const totalH = selectedPlan.segmentHeights.reduce((s, h) => s + h, 0);
                                            let currentY = glassY;
                                            
                                            selectedPlan.segmentHeights.forEach((h, idx) => {
                                                const ratio = h / totalH;
                                                const rectH = glassHeight * ratio;
                                                
                                                if (idx < selectedPlan.segmentHeights.length - 1) {
                                                    spliceLines += `
                                                        <line x1="${glassX}" y1="${currentY + rectH}" 
                                                              x2="${glassX + glassWidth}" y2="${currentY + rectH}" 
                                                              stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                                    `;
                                                }
                                                currentY += rectH;
                                            });
                                        } else if (!isHoriz && selectedPlan.segmentWidths) {
                                            const totalW = selectedPlan.segmentWidths.reduce((s, w) => s + w, 0);
                                            let currentX = glassX;
                                            
                                            selectedPlan.segmentWidths.forEach((w, idx) => {
                                                const ratio = w / totalW;
                                                const rectW = glassWidth * ratio;
                                                
                                                if (idx < selectedPlan.segmentWidths.length - 1) {
                                                    spliceLines += `
                                                        <line x1="${currentX + rectW}" y1="${glassY}" 
                                                              x2="${currentX + rectW}" y2="${glassY + glassHeight}" 
                                                              stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                                    `;
                                                }
                                                currentX += rectW;
                                            });
                                        }
                                        
                                        const arrowLen = isHoriz ? 15 : 12;
                                        let arrow = '';
                                        
                                        if (isHoriz) {
                                            const arrowCenterX = svgWidth / 2;
                                            const arrowCenterY = glassY + glassHeight / 2;
                                            arrow = `
                                                <line x1="${arrowCenterX - arrowLen}" y1="${arrowCenterY}" 
                                                      x2="${arrowCenterX + arrowLen}" y2="${arrowCenterY}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${arrowCenterX - arrowLen} ${arrowCenterY} 
                                                         L ${arrowCenterX - arrowLen + 6} ${arrowCenterY - 3.5} 
                                                         M ${arrowCenterX - arrowLen} ${arrowCenterY} 
                                                         L ${arrowCenterX - arrowLen + 6} ${arrowCenterY + 3.5}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${arrowCenterX + arrowLen} ${arrowCenterY} 
                                                         L ${arrowCenterX + arrowLen - 6} ${arrowCenterY - 3.5} 
                                                         M ${arrowCenterX + arrowLen} ${arrowCenterY} 
                                                         L ${arrowCenterX + arrowLen - 6} ${arrowCenterY + 3.5}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                            `;
                                        } else {
                                            const arrowCenterX = svgWidth / 2;
                                            const arrowCenterY = glassY + glassHeight / 2;
                                            arrow = `
                                                <line x1="${arrowCenterX}" y1="${arrowCenterY - arrowLen}" 
                                                      x2="${arrowCenterX}" y2="${arrowCenterY + arrowLen}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${arrowCenterX} ${arrowCenterY - arrowLen} 
                                                         L ${arrowCenterX - 3.5} ${arrowCenterY - arrowLen + 6} 
                                                         M ${arrowCenterX} ${arrowCenterY - arrowLen} 
                                                         L ${arrowCenterX + 3.5} ${arrowCenterY - arrowLen + 6}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                                <path d="M ${arrowCenterX} ${arrowCenterY + arrowLen} 
                                                         L ${arrowCenterX - 3.5} ${arrowCenterY + arrowLen - 6} 
                                                         M ${arrowCenterX} ${arrowCenterY + arrowLen} 
                                                         L ${arrowCenterX + 3.5} ${arrowCenterY + arrowLen - 6}" 
                                                      stroke="#27ae60" stroke-width="2" fill="none"/>
                                            `;
                                        }
                                        
                                        svgContent = `
                                            <svg width="${svgWidth}" height="${svgHeight}" style="background: #f8f9fa; border-radius: 8px; border: 2px solid #fbbf24; cursor: pointer;" onclick="selectPlanForGlassInList(${i})" onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                                <text x="${svgWidth/2}" y="12" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">
                                                    ${g.width}Ã—${g.height}mm
                                                </text>
                                                
                                                <rect x="${glassX}" y="${glassY}" width="${glassWidth}" height="${glassHeight}" 
                                                      fill="rgba(232, 245, 233, 0.3)" stroke="#fbbf24" stroke-width="2.5" rx="4"/>
                                                
                                                ${spliceLines}
                                                ${arrow}
                                            </svg>
                                        `;
                                    }
                                } else if (needsUserSelection) {
                                    statusLabel = 'éœ€é€‰æ‹©æ–¹æ¡ˆ';
                                    statusColor = 'bg-red-100 text-red-800 border border-red-300';
                                    statusText = 'è¯·ç‚¹å‡»é€‰æ‹©æ‹¼æ¥æ–¹æ¡ˆ';
                                    
                                    const glassRect = calculateGlassRect(g.width, g.height);
                                    const glassWidth = glassRect.width;
                                    const glassHeight = glassRect.height;
                                    const glassX = glassRect.x;
                                    const glassY = glassRect.y;
                                    
                                    svgContent = `
                                        <svg width="${svgWidth}" height="${svgHeight}" style="background: #f8f9fa; border-radius: 8px; border: 2px solid #c0392b; cursor: pointer;" onclick="selectPlanForGlassInList(${i})" onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                            <text x="${svgWidth/2}" y="12" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">
                                                ${g.width}Ã—${g.height}mm
                                            </text>
                                            
                                            <rect x="${glassX}" y="${glassY}" width="${glassWidth}" height="${glassHeight}" 
                                                  fill="rgba(232, 245, 233, 0.3)" stroke="#c0392b" stroke-width="2.5" rx="4"/>
                                            
                                            <rect x="${glassX + glassWidth - 35}" y="${glassY + glassHeight - 16}" width="33" height="13" 
                                                  fill="rgba(239, 68, 68, 0.9)" stroke="none" rx="2"/>
                                            <text x="${glassX + glassWidth - 18.5}" y="${glassY + glassHeight - 6}" text-anchor="middle" 
                                                  font-size="8" fill="white" font-weight="bold">ç‚¹å‡»é€‰æ‹©</text>
                                        </svg>
                                    `;
                                } else {
                                    statusLabel = 'éœ€è¦æ‹¼æ¥';
                                    statusColor = 'bg-orange-100 text-[#373737]';
                                    
                                    const sightCheckForText = checkSightLineConflictForGlass({
                                        width: g.width,
                                        height: g.height,
                                        minSide: () => shortSide,
                                        maxSide: () => longSide
                                    });
                                    
                                    if (sightCheckForText.canAutoSplice()) {
                                        const segments = Math.ceil(g.height / FILM_WIDTH);
                                        if (segments === 2) {
                                            const part1Height = FILM_WIDTH;
                                            const part2Height = g.height - FILM_WIDTH;
                                            const stitchFromGround = Math.min(part1Height, part2Height);
                                            statusText = `è†œææ¨ªå‘æ‹¼æ¥,æ‹¼æ¥ç¼è·åœ°${Math.round(stitchFromGround)}mm,å…±${segments}æ¡è†œæ`;
                                        } else if (segments === 3) {
                                            const remaining = g.height - 2 * FILM_WIDTH;
                                            statusText = `è†œææ¨ªå‘æ‹¼æ¥,æœ€ä½æ‹¼æ¥ç¼è·åœ°${Math.round(remaining)}mm,å…±${segments}æ¡è†œæ`;
                                        } else {
                                            statusText = `è†œææ¨ªå‘æ‹¼æ¥,å…±${segments}æ¡è†œæ`;
                                        }
                                    } else if (g.height > FILM_WIDTH && g.width <= FILM_WIDTH) {
                                        const segments = Math.ceil(g.height / FILM_WIDTH);
                                        if (segments === 2) {
                                            const part1Height = FILM_WIDTH;
                                            const part2Height = g.height - FILM_WIDTH;
                                            const stitchFromGround = Math.min(part1Height, part2Height);
                                            statusText = `è†œææ¨ªå‘æ‹¼æ¥,æ‹¼æ¥ç¼è·åœ°${Math.round(stitchFromGround)}mm,å…±${segments}æ¡è†œæ`;
                                        } else if (segments === 3) {
                                            const remaining = g.height - 2 * FILM_WIDTH;
                                            statusText = `è†œææ¨ªå‘æ‹¼æ¥,æœ€ä½æ‹¼æ¥ç¼è·åœ°${Math.round(remaining)}mm,å…±${segments}æ¡è†œæ`;
                                        } else {
                                            statusText = `è†œææ¨ªå‘æ‹¼æ¥,å…±${segments}æ¡è†œæ`;
                                        }
                                    } else if (g.width > FILM_WIDTH && g.height <= FILM_WIDTH) {
                                        const segments = Math.ceil(g.width / FILM_WIDTH);
                                        statusText = `è†œæçºµå‘æ‹¼æ¥,å…±${segments}æ¡è†œæ`;
                                    } else {
                                        statusText = 'éœ€è¦å¤šæ®µæ‹¼æ¥';
                                    }
                                    
                                    const glassRect = calculateGlassRect(g.width, g.height);
                                    const glassWidth = glassRect.width;
                                    const glassHeight = glassRect.height;
                                    const glassX = glassRect.x;
                                    const glassY = glassRect.y;
                                    
                                    let spliceLines = '';
                                    const sightCheckForSVG = checkSightLineConflictForGlass({
                                           width: g.width,
                                           height: g.height,
                                           minSide: () => Math.min(g.width, g.height),
                                           maxSide: () => Math.max(g.width, g.height)
                                    });

                                    let hasVerticalSplice = false;
                                    let hasHorizontalSplice = false;

                                    if (sightCheckForSVG.canAutoSplice() || (g.height > FILM_WIDTH && g.width <= FILM_WIDTH)) {
                                        hasHorizontalSplice = true;
                                     } else if (g.width > FILM_WIDTH && g.height <= FILM_WIDTH) {
                                        hasVerticalSplice = true;
                                     }
                                    
                                    if (hasVerticalSplice) {
                                        const spliceX = glassX + glassWidth * 0.7;
                                        spliceLines = `
                                            <line x1="${spliceX}" y1="${glassY}" x2="${spliceX}" y2="${glassY + glassHeight}" 
                                                  stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                        `;
                                    } else if (hasHorizontalSplice) {
                                        // è®¡ç®—å®é™…æ‹¼æ¥ä½ç½®æ¯”ä¾‹
                                        const segments = Math.ceil(g.height / FILM_WIDTH);
                                        if (segments === 2) {
                                            // 2æ®µæ‹¼æ¥ï¼šæ‹¼æ¥ç¼åœ¨ min(FILM_WIDTH, height-FILM_WIDTH) ä½ç½®
                                            const stitchFromGround = Math.min(FILM_WIDTH, g.height - FILM_WIDTH);
                                            const stitchRatio = stitchFromGround / g.height;
                                            // SVGä¸­Yè½´å‘ä¸‹ï¼Œæ‰€ä»¥ä»åº•éƒ¨ç®—èµ·éœ€è¦ç”¨ 1 - ratio
                                            const spliceY = glassY + glassHeight * (1 - stitchRatio);
                                            spliceLines = `
                                                <line x1="${glassX}" y1="${spliceY}" x2="${glassX + glassWidth}" y2="${spliceY}" 
                                                      stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                            `;
                                        } else if (segments === 3) {
                                            // 3æ®µæ‹¼æ¥ï¼šä¸¤æ¡æ‹¼æ¥ç¼
                                            const remaining = g.height - 2 * FILM_WIDTH;
                                            const stitch1FromGround = remaining;  // æœ€ä½æ‹¼æ¥ç¼
                                            const stitch2FromGround = remaining + FILM_WIDTH;  // ç¬¬äºŒæ¡æ‹¼æ¥ç¼
                                            const spliceY1 = glassY + glassHeight * (1 - stitch1FromGround / g.height);
                                            const spliceY2 = glassY + glassHeight * (1 - stitch2FromGround / g.height);
                                            spliceLines = `
                                                <line x1="${glassX}" y1="${spliceY1}" x2="${glassX + glassWidth}" y2="${spliceY1}" 
                                                      stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                                <line x1="${glassX}" y1="${spliceY2}" x2="${glassX + glassWidth}" y2="${spliceY2}" 
                                                      stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                            `;
                                        } else {
                                            // æ›´å¤šæ®µï¼šå‡åˆ†æ˜¾ç¤º
                                            for (let i = 1; i < segments; i++) {
                                                const lineY = glassY + (glassHeight / segments) * i;
                                                spliceLines += `
                                                    <line x1="${glassX}" y1="${lineY}" x2="${glassX + glassWidth}" y2="${lineY}" 
                                                          stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,4"/>
                                                `;
                                            }
                                        }
                                    }
                                    
                                    const arrowLen = hasVerticalSplice ? 12 : 15;
                                    let arrow = '';
                                    
                                    if (hasVerticalSplice) {
                                        const arrowCenterX = svgWidth / 2;
                                        const arrowCenterY = glassY + glassHeight / 2;
                                        arrow = `
                                            <line x1="${arrowCenterX}" y1="${arrowCenterY - arrowLen}" 
                                                  x2="${arrowCenterX}" y2="${arrowCenterY + arrowLen}" 
                                                  stroke="#27ae60" stroke-width="2" fill="none"/>
                                            <path d="M ${arrowCenterX} ${arrowCenterY - arrowLen} 
                                                     L ${arrowCenterX - 3.5} ${arrowCenterY - arrowLen + 6} 
                                                     M ${arrowCenterX} ${arrowCenterY - arrowLen} 
                                                     L ${arrowCenterX + 3.5} ${arrowCenterY - arrowLen + 6}" 
                                                  stroke="#27ae60" stroke-width="2" fill="none"/>
                                            <path d="M ${arrowCenterX} ${arrowCenterY + arrowLen} 
                                                     L ${arrowCenterX - 3.5} ${arrowCenterY + arrowLen - 6} 
                                                     M ${arrowCenterX} ${arrowCenterY + arrowLen} 
                                                     L ${arrowCenterX + 3.5} ${arrowCenterY + arrowLen - 6}" 
                                                  stroke="#27ae60" stroke-width="2" fill="none"/>
                                        `;
                                    } else {
                                        const arrowCenterX = svgWidth / 2;
                                        const arrowCenterY = glassY + glassHeight / 2;
                                        arrow = `
                                            <line x1="${arrowCenterX - arrowLen}" y1="${arrowCenterY}" 
                                                  x2="${arrowCenterX + arrowLen}" y2="${arrowCenterY}" 
                                                  stroke="#27ae60" stroke-width="2" fill="none"/>
                                            <path d="M ${arrowCenterX - arrowLen} ${arrowCenterY} 
                                                     L ${arrowCenterX - arrowLen + 6} ${arrowCenterY - 3.5} 
                                                     M ${arrowCenterX - arrowLen} ${arrowCenterY} 
                                                     L ${arrowCenterX - arrowLen + 6} ${arrowCenterY + 3.5}" 
                                                  stroke="#27ae60" stroke-width="2" fill="none"/>
                                            <path d="M ${arrowCenterX + arrowLen} ${arrowCenterY} 
                                                     L ${arrowCenterX + arrowLen - 6} ${arrowCenterY - 3.5} 
                                                     M ${arrowCenterX + arrowLen} ${arrowCenterY} 
                                                     L ${arrowCenterX + arrowLen - 6} ${arrowCenterY + 3.5}" 
                                                  stroke="#27ae60" stroke-width="2" fill="none"/>
                                        `;
                                    }
                                    
                                    svgContent = `
                                        <svg width="${svgWidth}" height="${svgHeight}" style="background: #f8f9fa; border-radius: 8px; border: 2px solid #f97316;">
                                            <text x="${svgWidth/2}" y="12" text-anchor="middle" font-size="9" font-weight="bold" fill="#333">
                                                ${g.width}Ã—${g.height}mm
                                            </text>
                                            
                                            <rect x="${glassX}" y="${glassY}" width="${glassWidth}" height="${glassHeight}" 
                                                  fill="rgba(232, 245, 233, 0.3)" stroke="#f97316" stroke-width="2.5" rx="4"/>
                                            
                                            ${spliceLines}
                                            ${arrow}
                                        </svg>
                                    `;
                                }
                                
                                return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-3 py-3 text-sm">
                                        <div class="font-medium">${g.floor}</div>
                                        <div class="text-gray-500 text-xs">${g.room}</div>
                                    </td>
                                    <td class="px-3 py-3 text-sm font-semibold text-blue-600">${g.windowId}</td>
                                    <td class="px-3 py-3 text-sm text-center">${g.direction}</td>
                                    <td class="px-3 py-3 text-sm font-mono">${g.width}Ã—${g.height}</td>
                                    <td class="px-3 py-3 text-center">
                                        <span class="px-2 py-1 rounded-full text-xs font-bold" style="background: var(--aux-light-tan); color: var(--secondary-gray);">${g.quantity}ç‰‡</span>
                                    </td>
                                    <td class="px-3 py-3">
                                        <span class="px-2 py-1 rounded text-xs font-semibold" style="background: ${productColor.bg}; color: ${productColor.text};">
                                            ${g.product}
                                        </span>
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="flex items-center gap-2">
                                            <div class="flex-shrink-0">
                                                ${svgContent}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                ${(needsUserSelection || hasSelectedPlan) ? `
                                                    <button onclick="selectPlanForGlassInList(${i})" class="w-full mb-2 px-3 py-1.5 rounded text-xs font-semibold ${statusColor} hover:shadow-md transition">
                                                        ${statusLabel}
                                                    </button>
                                                    <div class="text-xs text-gray-600">${statusText}</div>
                                                ` : `
                                                    <div class="inline-block px-3 py-1 rounded text-xs font-semibold ${statusColor} mb-1" style="color: #373737;">
                                                        ${statusLabel}
                                                    </div>
                                                    <div class="text-xs text-gray-600">${statusText}</div>
                                                `}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3 py-3">
                                        <div class="flex gap-2 justify-center">
                                            <button onclick="editGlass(${i})" class="bg-white border-2 text-white p-2 rounded transition hover:opacity-80" title="ç¼–è¾‘" style="border-color: var(--primary-red); color: var(--primary-red);">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                </svg>
                                            </button>
                                            <button onclick="removeGlass(${i})" class="bg-primary-red btn-primary text-white p-2 rounded transition" title="åˆ é™¤">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function editGlass(index) {
            const glass = glasses[index];
            document.getElementById('glassFloor').value = glass.floor === '-' ? '' : glass.floor;
            document.getElementById('glassRoom').value = glass.room === '-' ? '' : glass.room;
            document.getElementById('glassWindowId').value = glass.windowId === '-' ? '' : glass.windowId;
            document.getElementById('glassDirection').value = glass.direction === '-' ? '' : glass.direction;
            document.getElementById('glassWidth').value = glass.width;
            document.getElementById('glassHeight').value = glass.height;
            document.getElementById('glassProduct').value = glass.product === '-' ? '' : glass.product;
            document.getElementById('glassQuantity').value = glass.quantity;
            
            editingIndex = index;
            
            document.getElementById('addGlassBtn').innerHTML = 'âœ… æ›´æ–°';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red text-white font-bold py-2 px-4 rounded-lg transition hover:bg-primary-red-dark';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            
            document.getElementById('glassFloor').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function cancelEdit() {
            editingIndex = -1;
            
            document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            
            document.getElementById('glassFloor').value = '';
            document.getElementById('glassRoom').value = '';
            document.getElementById('glassWindowId').value = '';
            document.getElementById('glassDirection').value = '';
            document.getElementById('glassWidth').value = '';
            document.getElementById('glassHeight').value = '';
            document.getElementById('glassProduct').value = '';
            document.getElementById('glassQuantity').value = '1';
        }

        function removeGlass(index) {
            if (editingIndex === index) {
                editingIndex = -1;
                document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
                document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
                document.getElementById('cancelEditBtn').classList.add('hidden');
            } else if (editingIndex > index) {
                editingIndex--;
            }
            const removedGlass = glasses[index];
            glasses.splice(index, 1);
            
            if (removedGlass) {
                delete selectedPlans[removedGlass.id];
            }
            
            updateGlassList();
        }

        function clearAll() {
            window.glasses = [];
            window.selectedPlans = {};
            window.editingIndex = -1;
            document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            updateGlassList();
            document.getElementById('resultSection').classList.add('hidden');
        }

        function loadExample1() {
            editingIndex = -1;
            document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            window.glasses = [
                { id: 'A1', floor: 'ä¸€æ¥¼', room: 'å®¢å…', windowId: 'A1', direction: 'å—', width: 3200, height: 2200, product: 'æš®è¯­', quantity: 1 },
                { id: 'B1', floor: 'ä¸€æ¥¼', room: 'å§å®¤', windowId: 'B1', direction: 'ä¸œ', width: 1500, height: 2000, product: 'æ™¨æ›¦', quantity: 2 },
                { id: 'C1', floor: 'äºŒæ¥¼', room: 'ä¹¦æˆ¿', windowId: 'C1', direction: 'åŒ—', width: 800, height: 1000, product: 'æ™ºå¹•Pro30', quantity: 4 },
                { id: 'D1', floor: 'äºŒæ¥¼', room: 'å§å®¤', windowId: 'D1', direction: 'è¥¿', width: 390, height: 1140, product: 'æ™¨æ›¦', quantity: 2 }
            ];
            window.selectedPlans = {};
            updateGlassList();
        }

        function loadExample2() {
            editingIndex = -1;
            document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            window.glasses = [
                { id: 'G1', floor: 'ä¸€æ¥¼', room: 'å®¢å…', windowId: 'G1', direction: 'å—', width: 390, height: 1140, product: 'æ™¨æ›¦', quantity: 4 },
                { id: 'G2', floor: 'ä¸€æ¥¼', room: 'å®¢å…', windowId: 'G2', direction: 'å—', width: 800, height: 570, product: 'æ™¨æ›¦', quantity: 4 },
                { id: 'G3', floor: 'ä¸€æ¥¼', room: 'é¤å…', windowId: 'G3', direction: 'ä¸œ', width: 950, height: 1600, product: 'æ™ºå¹•Pro30', quantity: 2 },
                { id: 'G4', floor: 'äºŒæ¥¼', room: 'ä¸»å§', windowId: 'G4', direction: 'å—', width: 1580, height: 520, product: 'æ™ºå¹•Pro30', quantity: 2 },
                { id: 'G5', floor: 'äºŒæ¥¼', room: 'ä¸»å§', windowId: 'G5', direction: 'å—', width: 1510, height: 2320, product: 'æš®è¯­', quantity: 1 },
                { id: 'G6', floor: 'äºŒæ¥¼', room: 'æ¬¡å§', windowId: 'G6', direction: 'åŒ—', width: 1280, height: 2310, product: 'æš®è¯­', quantity: 1 },
                { id: 'G7', floor: 'ä¸‰æ¥¼', room: 'ä¹¦æˆ¿', windowId: 'G7', direction: 'ä¸œ', width: 440, height: 1110, product: 'æ™¨æ›¦', quantity: 1 },
                { id: 'G8', floor: 'ä¸‰æ¥¼', room: 'é˜³å°', windowId: 'G8', direction: 'è¥¿', width: 610, height: 940, product: 'æ™¨æ›¦', quantity: 1 }
            ];
            window.selectedPlans = {};
            updateGlassList();
        }

        function loadExample3() {
            editingIndex = -1;
            document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            glasses = [
                { id: 'A1', floor: 'ä¸€æ¥¼', room: 'å®¢å…', windowId: 'A1', direction: 'å—', width: 1510, height: 2320, product: 'æš®è¯­', quantity: 1 },
                { id: 'A2', floor: 'ä¸€æ¥¼', room: 'å®¢å…', windowId: 'A2', direction: 'å—', width: 1280, height: 2310, product: 'æš®è¯­', quantity: 1 },
                { id: 'A3', floor: 'äºŒæ¥¼', room: 'ä¸»å§', windowId: 'A3', direction: 'ä¸œ', width: 440, height: 1110, product: 'æ™¨æ›¦', quantity: 1 },
                { id: 'A4', floor: 'äºŒæ¥¼', room: 'æ¬¡å§', windowId: 'A4', direction: 'åŒ—', width: 610, height: 940, product: 'æ™¨æ›¦', quantity: 1 },
                { id: 'A5', floor: 'ä¸‰æ¥¼', room: 'ä¹¦æˆ¿', windowId: 'A5', direction: 'å—', width: 2200, height: 3200, product: 'æš®è¯­', quantity: 1 },
                { id: 'A6', floor: 'ä¸‰æ¥¼', room: 'é˜³å°', windowId: 'A6', direction: 'è¥¿', width: 3200, height: 2200, product: 'æš®è¯­', quantity: 1 }
            ];
            selectedPlans = {};
            updateGlassList();
        }

        function loadTestCase() {
            editingIndex = -1;
            document.getElementById('addGlassBtn').innerHTML = 'â• æ·»åŠ ';
            document.getElementById('addGlassBtn').className = 'flex-1 bg-primary-red btn-primary text-white font-bold py-2 px-4 rounded-lg transition';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            glasses = [
                { id: 'a5', floor: 'ä¸€æ¥¼', room: 'å®¢å…', windowId: 'a5', direction: 'å—', width: 2050, height: 2395, product: 'æš®è¯­', quantity: 1 }
            ];
            selectedPlans = {};
            updateGlassList();
        }
        
        function exportPDF() {
            alert('PDFå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        function printReport() {
            if (glasses.length === 0) {
                alert('è¯·å…ˆæ·»åŠ ç»ç’ƒæ•°æ®!');
                return;
            }
            
            // è·å–é¡¹ç›®ä¿¡æ¯
            const projectName = document.getElementById('projectName').value || 'æœªå¡«å†™';
            const ownerName = document.getElementById('ownerName').value || 'æœªå¡«å†™';
            const contactPhone = document.getElementById('contactPhone').value || 'æœªå¡«å†™';
            const projectAddress = document.getElementById('projectAddress').value || 'æœªå¡«å†™';
            
            // è·å–ç»Ÿè®¡æ•°æ®
            const totalGlassCount = document.getElementById('totalGlassCount').textContent;
            const productTypeCount = document.getElementById('productTypeCount').textContent;
            const totalRollCount = document.getElementById('totalRollCount').textContent;
            const rollUtilization = document.getElementById('rollUtilization').textContent;
            const materialWasteRate = document.getElementById('materialWasteRate').textContent;
            const totalGlassArea = document.getElementById('totalGlassArea').textContent;
            const totalFilmArea = document.getElementById('totalFilmArea').textContent;
            const totalFilmLength = document.getElementById('totalFilmLength').textContent;
            
            // è·å–äº§å“åˆ†ç±»ç»Ÿè®¡HTML
            const productStatsHTML = document.getElementById('productStats').innerHTML;
            
            // ç”Ÿæˆç»ç’ƒè¯¦ç»†ä¿¡æ¯çš„SVGå‡½æ•°
            const generateGlassSVG = (glass) => {
                const svgWidth = 180;
                const svgHeight = 140;
                const shortSide = Math.min(glass.width, glass.height);
                const longSide = Math.max(glass.width, glass.height);
                const needsSplicing = shortSide > FILM_WIDTH;
                const isVertical = glass.height > glass.width;
                
                const maxW = svgWidth * 0.65;
                const maxH = svgHeight * 0.65;
                const aspectRatio = glass.width / glass.height;
                
                let rectW, rectH;
                if (aspectRatio > maxW / maxH) {
                    rectW = maxW;
                    rectH = maxW / aspectRatio;
                } else {
                    rectH = maxH;
                    rectW = maxH * aspectRatio;
                }
                
                const rectX = (svgWidth - rectW) / 2;
                const rectY = 22;
                const arrowLen = 18;
                
                let description = '';
                let borderColor = '#27ae60';
                let svgElements = '';
                
                if (!needsSplicing) {
                    description = isVertical ? 'æ•´å¹…ç«–å‘<br/>è†œæç«–æ”¾è´´æ•·,æ— æ‹¼æ¥ç¼' : 'æ•´å¹…æ¨ªå‘<br/>è†œææ¨ªæ”¾è´´æ•·,æ— æ‹¼æ¥ç¼';
                    
                    if (isVertical) {
                        svgElements = `
                            <line x1="${svgWidth/2}" y1="${rectY + rectH/2 - arrowLen}" 
                                  x2="${svgWidth/2}" y2="${rectY + rectH/2 + arrowLen}" 
                                  stroke="#27ae60" stroke-width="3"/>
                            <path d="M ${svgWidth/2} ${rectY + rectH/2 - arrowLen} 
                                     L ${svgWidth/2 - 5} ${rectY + rectH/2 - arrowLen + 8}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${svgWidth/2} ${rectY + rectH/2 - arrowLen} 
                                     L ${svgWidth/2 + 5} ${rectY + rectH/2 - arrowLen + 8}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${svgWidth/2} ${rectY + rectH/2 + arrowLen} 
                                     L ${svgWidth/2 - 5} ${rectY + rectH/2 + arrowLen - 8}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${svgWidth/2} ${rectY + rectH/2 + arrowLen} 
                                     L ${svgWidth/2 + 5} ${rectY + rectH/2 + arrowLen - 8}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                        `;
                    } else {
                        svgElements = `
                            <line x1="${rectX + rectW/2 - arrowLen}" y1="${rectY + rectH/2}" 
                                  x2="${rectX + rectW/2 + arrowLen}" y2="${rectY + rectH/2}" 
                                  stroke="#27ae60" stroke-width="3"/>
                            <path d="M ${rectX + rectW/2 - arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 - arrowLen + 8} ${rectY + rectH/2 - 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${rectX + rectW/2 - arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 - arrowLen + 8} ${rectY + rectH/2 + 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${rectX + rectW/2 + arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 + arrowLen - 8} ${rectY + rectH/2 - 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${rectX + rectW/2 + arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 + arrowLen - 8} ${rectY + rectH/2 + 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                        `;
                    }
                } else {
                    const hasSelectedPlan = selectedPlans[glass.id];
                    
                    if (hasSelectedPlan) {
                        borderColor = '#fbbf24';
                        const tempItem = new GlassItem(glass.id, glass.width, glass.height, glass.id, glass.product);
                        const tempCandidates = [];
                        const tempPlans = generateSixPlans(tempItem, FILM_WIDTH, tempCandidates);
                        const selectedPlan = tempPlans.find(p => p.id === selectedPlans[glass.id]);
                        
                        if (selectedPlan) {
                            const isHoriz = selectedPlan.method === 'horizontal';
                            
                            if (isHoriz && selectedPlan.segments === 2) {
                                const seg1 = selectedPlan.segmentHeights[0];
                                const seg2 = selectedPlan.segmentHeights[1];
                                const stitchFromGround = Math.min(seg1, seg2);
                                description = `éœ€è¦æ‹¼æ¥<br/>è†œææ¨ªå‘æ‹¼æ¥,æ‹¼æ¥ç¼è·åœ°${Math.round(stitchFromGround)}mm,å…±2æ¡è†œæ`;
                            } else if (isHoriz) {
                                description = `éœ€è¦æ‹¼æ¥<br/>è†œææ¨ªå‘æ‹¼æ¥,å…±${selectedPlan.segments}æ¡è†œæ`;
                            } else {
                                description = `éœ€è¦æ‹¼æ¥<br/>è†œæçºµå‘æ‹¼æ¥,å…±${selectedPlan.segments}æ¡è†œæ`;
                            }
                            
                            if (isHoriz && selectedPlan.segmentHeights) {
                                const totalH = selectedPlan.segmentHeights.reduce((s, h) => s + h, 0);
                                let currentY = rectY;
                                
                                selectedPlan.segmentHeights.forEach((h, idx) => {
                                    const ratio = h / totalH;
                                    const segH = rectH * ratio;
                                    
                                    if (idx < selectedPlan.segmentHeights.length - 1) {
                                        svgElements += `
                                            <line x1="${rectX}" y1="${currentY + segH}" 
                                                  x2="${rectX + rectW}" y2="${currentY + segH}" 
                                                  stroke="#e74c3c" stroke-width="3" stroke-dasharray="6,5"/>
                                        `;
                                    }
                                    currentY += segH;
                                });
                            } else if (!isHoriz && selectedPlan.segmentWidths) {
                                const totalW = selectedPlan.segmentWidths.reduce((s, w) => s + w, 0);
                                let currentX = rectX;
                                
                                selectedPlan.segmentWidths.forEach((w, idx) => {
                                    const ratio = w / totalW;
                                    const segW = rectW * ratio;
                                    
                                    if (idx < selectedPlan.segmentWidths.length - 1) {
                                        svgElements += `
                                            <line x1="${currentX + segW}" y1="${rectY}" 
                                                  x2="${currentX + segW}" y2="${rectY + rectH}" 
                                                  stroke="#e74c3c" stroke-width="3" stroke-dasharray="6,5"/>
                                        `;
                                    }
                                    currentX += segW;
                                });
                            }
                            
                            if (isHoriz) {
                                svgElements += `
                                    <line x1="${rectX + rectW/2 - arrowLen}" y1="${rectY + rectH/2}" 
                                          x2="${rectX + rectW/2 + arrowLen}" y2="${rectY + rectH/2}" 
                                          stroke="#27ae60" stroke-width="3"/>
                                    <path d="M ${rectX + rectW/2 - arrowLen} ${rectY + rectH/2} 
                                             L ${rectX + rectW/2 - arrowLen + 8} ${rectY + rectH/2 - 5}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                    <path d="M ${rectX + rectW/2 - arrowLen} ${rectY + rectH/2} 
                                             L ${rectX + rectW/2 - arrowLen + 8} ${rectY + rectH/2 + 5}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                    <path d="M ${rectX + rectW/2 + arrowLen} ${rectY + rectH/2} 
                                             L ${rectX + rectW/2 + arrowLen - 8} ${rectY + rectH/2 - 5}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                    <path d="M ${rectX + rectW/2 + arrowLen} ${rectY + rectH/2} 
                                             L ${rectX + rectW/2 + arrowLen - 8} ${rectY + rectH/2 + 5}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                `;
                            } else {
                                svgElements += `
                                    <line x1="${svgWidth/2}" y1="${rectY + rectH/2 - arrowLen}" 
                                          x2="${svgWidth/2}" y2="${rectY + rectH/2 + arrowLen}" 
                                          stroke="#27ae60" stroke-width="3"/>
                                    <path d="M ${svgWidth/2} ${rectY + rectH/2 - arrowLen} 
                                             L ${svgWidth/2 - 5} ${rectY + rectH/2 - arrowLen + 8}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                    <path d="M ${svgWidth/2} ${rectY + rectH/2 - arrowLen} 
                                             L ${svgWidth/2 + 5} ${rectY + rectH/2 - arrowLen + 8}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                    <path d="M ${svgWidth/2} ${rectY + rectH/2 + arrowLen} 
                                             L ${svgWidth/2 - 5} ${rectY + rectH/2 + arrowLen - 8}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                    <path d="M ${svgWidth/2} ${rectY + rectH/2 + arrowLen} 
                                             L ${svgWidth/2 + 5} ${rectY + rectH/2 + arrowLen - 8}" 
                                          stroke="#27ae60" stroke-width="3" fill="none"/>
                                `;
                            }
                        }
                    } else {
                        const segments = Math.ceil(glass.height / FILM_WIDTH);
                        if (segments === 2) {
                            const part1Height = FILM_WIDTH;
                            const part2Height = glass.height - FILM_WIDTH;
                            const stitchFromGround = Math.min(part1Height, part2Height);
                            description = `éœ€è¦æ‹¼æ¥<br/>è†œææ¨ªå‘æ‹¼æ¥,æ‹¼æ¥ç¼è·åœ°${Math.round(stitchFromGround)}mm,å…±${segments}æ¡è†œæ`;
                        } else {
                            description = `éœ€è¦æ‹¼æ¥<br/>è†œææ¨ªå‘æ‹¼æ¥,å…±${segments}æ¡è†œæ`;
                        }
                        borderColor = '#fbbf24';
                        
                        // æ ¹æ®å®é™…æ‹¼æ¥ä½ç½®ç»˜åˆ¶è™šçº¿
                        if (segments === 2) {
                            // 2æ®µæ‹¼æ¥ï¼šæ‹¼æ¥ç¼åœ¨ min(FILM_WIDTH, height-FILM_WIDTH) ä½ç½®
                            const stitchFromGround = Math.min(FILM_WIDTH, glass.height - FILM_WIDTH);
                            const stitchRatio = stitchFromGround / glass.height;
                            // SVGä¸­Yè½´å‘ä¸‹ï¼Œæ‰€ä»¥ä»åº•éƒ¨ç®—èµ·éœ€è¦ç”¨ 1 - ratio
                            const lineY = rectY + rectH * (1 - stitchRatio);
                            svgElements += `
                                <line x1="${rectX}" y1="${lineY}" 
                                      x2="${rectX + rectW}" y2="${lineY}" 
                                      stroke="#e74c3c" stroke-width="3" stroke-dasharray="6,5"/>
                            `;
                        } else if (segments === 3) {
                            // 3æ®µæ‹¼æ¥ï¼šä¸¤æ¡æ‹¼æ¥ç¼
                            const remaining = glass.height - 2 * FILM_WIDTH;
                            const stitch1FromGround = remaining;  // æœ€ä½æ‹¼æ¥ç¼
                            const stitch2FromGround = remaining + FILM_WIDTH;  // ç¬¬äºŒæ¡æ‹¼æ¥ç¼
                            const lineY1 = rectY + rectH * (1 - stitch1FromGround / glass.height);
                            const lineY2 = rectY + rectH * (1 - stitch2FromGround / glass.height);
                            svgElements += `
                                <line x1="${rectX}" y1="${lineY1}" 
                                      x2="${rectX + rectW}" y2="${lineY1}" 
                                      stroke="#e74c3c" stroke-width="3" stroke-dasharray="6,5"/>
                                <line x1="${rectX}" y1="${lineY2}" 
                                      x2="${rectX + rectW}" y2="${lineY2}" 
                                      stroke="#e74c3c" stroke-width="3" stroke-dasharray="6,5"/>
                            `;
                        } else {
                            // æ›´å¤šæ®µï¼šå‡åˆ†æ˜¾ç¤º
                            for (let i = 1; i < segments; i++) {
                                const lineY = rectY + (rectH / segments) * i;
                                svgElements += `
                                    <line x1="${rectX}" y1="${lineY}" 
                                          x2="${rectX + rectW}" y2="${lineY}" 
                                          stroke="#e74c3c" stroke-width="3" stroke-dasharray="6,5"/>
                                `;
                            }
                        }
                        
                        svgElements += `
                            <line x1="${rectX + rectW/2 - arrowLen}" y1="${rectY + rectH/2}" 
                                  x2="${rectX + rectW/2 + arrowLen}" y2="${rectY + rectH/2}" 
                                  stroke="#27ae60" stroke-width="3"/>
                            <path d="M ${rectX + rectW/2 - arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 - arrowLen + 8} ${rectY + rectH/2 - 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${rectX + rectW/2 - arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 - arrowLen + 8} ${rectY + rectH/2 + 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${rectX + rectW/2 + arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 + arrowLen - 8} ${rectY + rectH/2 - 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                            <path d="M ${rectX + rectW/2 + arrowLen} ${rectY + rectH/2} 
                                     L ${rectX + rectW/2 + arrowLen - 8} ${rectY + rectH/2 + 5}" 
                                  stroke="#27ae60" stroke-width="3" fill="none"/>
                        `;
                    }
                }
                
                return `
                    <div style="text-align: center;">
                        <svg width="${svgWidth}" height="${svgHeight}" style="background: #f8f9fa; border-radius: 8px; border: 2.5px solid ${borderColor};">
                            <text x="${svgWidth/2}" y="15" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">
                                ${glass.width}Ã—${glass.height}mm
                            </text>
                            <rect x="${rectX}" y="${rectY}" width="${rectW}" height="${rectH}" 
                                  fill="rgba(232, 245, 233, 0.3)" stroke="${borderColor}" stroke-width="3" rx="4"/>
                            ${svgElements}
                        </svg>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #374151; line-height: 1.3;">
                            ${description}
                        </div>
                    </div>
                `;
            };
            
            // åˆ›å»ºæ‰“å°å®¹å™¨
            const printContainer = document.createElement('div');
            printContainer.className = 'print-section';
            printContainer.innerHTML = `
                <!-- ç¬¬1é¡µï¼šè¡¨å¤´å’Œé¡¹ç›®è¯¦æƒ… -->
                <div class="print-page-1">
                    <div class="print-flex" style="display: flex; align-items: center; justify-content: center; gap: 1.2rem; margin-bottom: 0.8rem;">
                        <div style="width: 80px; height: 80px; border: none; border-radius: 0.6rem; display: flex; align-items: center; justify-content: center; background: transparent; flex-shrink: 0;">
                            <img src="å…¬å¸logo.png" alt="å…¬å¸Logo" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.6rem; font-weight: bold; color: var(--primary-red); margin-bottom: 0.3rem; line-height: 1;">TECH Xå¤ªç§‘æ–¯ç»ç’ƒéš”çƒ­è†œ</div>
                            <div style="font-size: 1rem; color: #999; letter-spacing: 0.08em; line-height: 1;">æ— è¾¹ç•Œæ–°ææ–™ç§‘æŠ€</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(to right, var(--primary-red), var(--primary-red-dark)); border-radius: 0.8rem; padding: 1rem; color: white; text-align: center; margin-bottom: 0.8rem;">
                        <div class="print-flex" style="display: flex; align-items: center; justify-content: center; margin-bottom: 0.3rem;">
                            <svg style="width: 2rem; height: 2rem; margin-right: 0.6rem; display: block;" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                            </svg>
                            <h1 style="font-size: 1.6rem; font-weight: bold; margin: 0; line-height: 1;">ç»ç’ƒéš”çƒ­è†œæ™ºèƒ½è£åˆ‡ä¼˜åŒ–ç³»ç»Ÿ</h1>
                        </div>
                        <p style="font-size: 0.85rem; opacity: 0.9; margin: 0; line-height: 1.2;">æ™ºèƒ½æ’å¸ƒ + ä½™æ–™å¤ç”¨ + å…¨å±€ä¼˜åŒ– </p>
                    </div>
                    
                    <div style="background: white; border-radius: 0.8rem; padding: 1.2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.8rem; color: var(--primary-red); display: flex; align-items: center; line-height: 1;">
                            <span style="margin-right: 0.4rem;">ğŸ“‹</span> é¡¹ç›®è¯¦æƒ…
                        </h2>
                        <div class="print-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2rem;">
                            <div>
                                <div style="font-weight: 600; color: var(--secondary-gray); margin-bottom: 0.3rem; font-size: 0.9rem; line-height: 1.2;">é¡¹ç›®åç§°</div>
                                <div style="padding: 0.7rem; border: 2px solid #e5e7eb; border-radius: 0.4rem; background: #f9fafb; font-size: 0.9rem; line-height: 1.3;">${projectName}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--secondary-gray); margin-bottom: 0.3rem; font-size: 0.9rem; line-height: 1.2;">ä¸šä¸»å§“å</div>
                                <div style="padding: 0.7rem; border: 2px solid #e5e7eb; border-radius: 0.4rem; background: #f9fafb; font-size: 0.9rem; line-height: 1.3;">${ownerName}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--secondary-gray); margin-bottom: 0.3rem; font-size: 0.9rem; line-height: 1.2;">è”ç³»æ–¹å¼</div>
                                <div style="padding: 0.7rem; border: 2px solid #e5e7eb; border-radius: 0.4rem; background: #f9fafb; font-size: 0.9rem; line-height: 1.3;">${contactPhone}</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--secondary-gray); margin-bottom: 0.3rem; font-size: 0.9rem; line-height: 1.2;">é¡¹ç›®åœ°å€</div>
                                <div style="padding: 0.7rem; border: 2px solid #e5e7eb; border-radius: 0.4rem; background: #f9fafb; font-size: 0.9rem; line-height: 1.3;">${projectAddress}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬2é¡µï¼šæ€»ä½“ç»Ÿè®¡å’Œäº§å“åˆ†ç±»ç»Ÿè®¡ -->
                <div class="print-page-stats">
                    <div style="background: white; border-radius: 0.8rem; padding: 0.7rem; margin-bottom: 0.6rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h2 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--primary-red); display: flex; align-items: center; line-height: 1;">
                            <span style="margin-right: 0.3rem;">ğŸ“Š</span> æ€»ä½“ç»Ÿè®¡
                        </h2>
                        <div class="print-grid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.4rem;">
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">ç»ç’ƒæ€»æ•°</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${totalGlassCount}<span style="font-size: 0.75rem; margin-left: 0.1rem;">å—</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">äº§å“ç±»å‹æ•°</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${productTypeCount}<span style="font-size: 0.75rem; margin-left: 0.1rem;">ç§</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">æ€»å¼€å·æ•°</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${totalRollCount}<span style="font-size: 0.75rem; margin-left: 0.1rem;">å·</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">å·æåˆ©ç”¨ç‡</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${rollUtilization}<span style="font-size: 0.75rem; margin-left: 0.1rem;">%</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">å·ææŸè€—ç‡</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${materialWasteRate}<span style="font-size: 0.75rem; margin-left: 0.1rem;">%</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">ç»ç’ƒæ€»é¢ç§¯</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${totalGlassArea}<span style="font-size: 0.75rem; margin-left: 0.1rem;">mÂ²</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">è†œææ€»é¢ç§¯</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${totalFilmArea}<span style="font-size: 0.75rem; margin-left: 0.1rem;">mÂ²</span></div>
                            </div>
                            <div style="background: #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; border: 2px solid #d1d5db;">
                                <div style="font-size: 0.6rem; font-weight: 600; margin-bottom: 0.1rem; color: #373737; line-height: 1.1;">å®é™…ç”¨è†œæ€»é•¿åº¦</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #373737; line-height: 1;">${totalFilmLength}<span style="font-size: 0.75rem; margin-left: 0.1rem;">m</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 0.8rem; padding: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h2 style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--primary-red); display: flex; align-items: center; line-height: 1;">
                            <span style="margin-right: 0.3rem;">ğŸ“¦</span> äº§å“åˆ†ç±»ç»Ÿè®¡
                        </h2>
                        <div style="display: block;">
                            ${document.getElementById('productStats').innerHTML.replace(/<div class="border-4/g, '<div class="print-product-card border-4')}
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬3é¡µï¼šè¯¦ç»†ç»ç’ƒä¿¡æ¯è¡¨æ ¼ -->
                <div class="print-page-details">
                    <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.7rem; color: var(--primary-red); display: flex; align-items: center; line-height: 1;">
                        <span style="margin-right: 0.4rem;">ğŸ“‹</span> è¯¦ç»†ç»ç’ƒä¿¡æ¯
                    </h2>
                    <table style="width: 100%; border-collapse: collapse; border: 2px solid #d1d5db; font-size: 0.8rem;">
                        <thead>
                            <tr style="background: linear-gradient(to right, var(--primary-red), var(--primary-red-dark)); color: white;">
                                <th style="padding: 0.6rem; text-align: left; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 10%;">æ¥¼å±‚åŒºåŸŸ</th>
                                <th style="padding: 0.6rem; text-align: left; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 8%;">çª—æˆ·ç¼–å·</th>
                                <th style="padding: 0.6rem; text-align: center; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 6%;">æœå‘</th>
                                <th style="padding: 0.6rem; text-align: left; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 10%;">å°ºå¯¸(mm)</th>
                                <th style="padding: 0.6rem; text-align: center; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 6%;">ç‰‡æ•°</th>
                                <th style="padding: 0.6rem; text-align: left; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 9%;">äº§å“ç±»å‹</th>
                                <th style="padding: 0.6rem; text-align: center; font-size: 0.8rem; font-weight: 600; border: 1px solid white; width: 51%;">è£åˆ‡æ–¹æ¡ˆç¤ºæ„å›¾</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${glasses.map((g, i) => {
                                const productColor = productColors[g.product] || productColors['-'];
                                const svgDiagram = generateGlassSVG(g);
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e5e7eb; ${i % 2 === 0 ? 'background: #f9fafb;' : 'background: white;'}">
                                        <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">
                                            <div style="font-weight: 600; color: #374151; font-size: 0.8rem; line-height: 1.2;">${g.floor}</div>
                                            <div style="font-size: 0.7rem; color: #6b7280; line-height: 1.2;">${g.room}</div>
                                        </td>
                                        <td style="padding: 0.5rem; font-weight: 600; color: #374151; border: 1px solid #e5e7eb; font-size: 0.8rem;">${g.windowId}</td>
                                        <td style="padding: 0.5rem; text-align: center; border: 1px solid #e5e7eb;">
                                            <span style="display: inline-block; padding: 0.2rem 0.5rem; background: #e5e7eb; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; color: #374151;">${g.direction}</span>
                                        </td>
                                        <td style="padding: 0.5rem; font-family: monospace; font-weight: 600; color: #374151; border: 1px solid #e5e7eb; font-size: 0.8rem;">${g.width}Ã—${g.height}</td>
                                        <td style="padding: 0.5rem; text-align: center; font-size: 1.1rem; font-weight: bold; color: var(--primary-red); border: 1px solid #e5e7eb;">${g.quantity}</td>
                                        <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">
                                            <span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${productColor.bg}; border-radius: 0.3rem; font-weight: 600; color: white; font-size: 0.75rem;">${g.product}</span>
                                        </td>
                                        <td style="padding: 0.4rem; text-align: center; border: 1px solid #e5e7eb; vertical-align: middle;">
                                            ${svgDiagram}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // å°†æ‰“å°å®¹å™¨æ·»åŠ åˆ°body
            document.body.appendChild(printContainer);
            
            // æ‰§è¡Œæ‰“å°
            window.print();
            
            // æ‰“å°å®Œæˆåç§»é™¤æ‰“å°å®¹å™¨
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 100);
        }
        
        updateGlassList();

        function runOptimization() {
            if (glasses.length === 0) {
                alert('è¯·å…ˆæ·»åŠ ç»ç’ƒæ•°æ®!');
                return;
            }
            
            optimizationState = null;
            
            const result = optimizeGlasses(glasses);
            
            if (!result.needsSelection) {
                displayResults(result);
            }
        }
        
        function displayLogsOnly(messages) {
            document.getElementById('resultSection').classList.remove('hidden');
            
            document.getElementById('totalGlassCount').textContent = '-';
            document.getElementById('productTypeCount').textContent = '-';
            document.getElementById('totalRollCount').textContent = '-';
            document.getElementById('rollUtilization').textContent = '-';
            document.getElementById('materialWasteRate').textContent = '-';
            document.getElementById('totalGlassArea').textContent = '-';
            document.getElementById('totalFilmArea').textContent = '-';
            document.getElementById('totalFilmLength').textContent = '-';
            
            document.getElementById('productStats').innerHTML = '<div class="text-center text-gray-500 py-8">è¯·å®Œæˆæ–¹æ¡ˆé€‰æ‹©åå†æ¬¡æ‰§è¡Œä¼˜åŒ–ç®—æ³•</div>';
            
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function displayResults(result) {
            document.getElementById('resultSection').classList.remove('hidden');
            
            const ROLL_LENGTH = 30000;
            const filmWidth = FILM_WIDTH;
            
            const totalGlassCount = glasses.reduce((sum, g) => sum + g.quantity, 0);
            
            const productTypes = new Set(glasses.map(g => g.product));
            const productTypeCount = productTypes.size;
            
            const totalFilmLengthMm = result.totalLength;
            const totalFilmLengthM = (totalFilmLengthMm / 1000).toFixed(2);
            
            const totalGlassAreaMm2 = glasses.reduce((sum, g) => sum + g.width * g.height * g.quantity, 0);
            const totalGlassAreaM2 = (totalGlassAreaMm2 / 1000000).toFixed(2);
            
            const totalFilmAreaMm2 = filmWidth * totalFilmLengthMm;
            const totalFilmAreaM2 = (totalFilmAreaMm2 / 1000000).toFixed(2);
            
            let totalRollCount = 0;
            if (result.productResults) {
                result.productResults.forEach(pr => {
                    const productFilmLengthMm = pr.totalLength;
                    const productRollCount = Math.ceil(productFilmLengthMm / ROLL_LENGTH);
                    totalRollCount += productRollCount;
                });
            } else {
                totalRollCount = Math.ceil(totalFilmLengthMm / ROLL_LENGTH);
            }
            
            const totalRollLengthMm = totalRollCount * ROLL_LENGTH;
            const rollUtilization = ((totalFilmLengthMm / totalRollLengthMm) * 100).toFixed(2);
            
            // è®¡ç®—å·ææŸè€—ç‡ = 1 - ç»ç’ƒæ€»é¢ç§¯/è†œææ€»é¢ç§¯
            const materialWasteRate = totalFilmAreaMm2 > 0 ? ((1 - totalGlassAreaMm2 / totalFilmAreaMm2) * 100).toFixed(2) : 0;
            
            document.getElementById('totalGlassCount').textContent = totalGlassCount;
            document.getElementById('productTypeCount').textContent = productTypeCount;
            document.getElementById('totalRollCount').textContent = totalRollCount;
            document.getElementById('rollUtilization').textContent = rollUtilization;
            document.getElementById('materialWasteRate').textContent = materialWasteRate;
            document.getElementById('totalGlassArea').textContent = totalGlassAreaM2;
            document.getElementById('totalFilmArea').textContent = totalFilmAreaM2;
            document.getElementById('totalFilmLength').textContent = totalFilmLengthM;
            
            const productStatsDiv = document.getElementById('productStats');
            
            if (result.productResults) {
                productStatsDiv.innerHTML = result.productResults.map((pr, idx) => {
                    const productColor = productColors[pr.product] || productColors['-'];
                    
                    const productSegments = result.segments.filter(seg => seg.product === pr.product);
                    
                    const productGlassCount = glasses.filter(g => g.product === pr.product)
                        .reduce((sum, g) => sum + g.quantity, 0);
                    
                    const productFilmLengthMm = productSegments.reduce((sum, seg) => sum + seg.length, 0);
                    const productFilmLengthM = (productFilmLengthMm / 1000).toFixed(2);
                    
                    const productRollCount = Math.ceil(productFilmLengthMm / ROLL_LENGTH);
                    
                    const productGlassAreaMm2 = glasses.filter(g => g.product === pr.product)
                        .reduce((sum, g) => sum + g.width * g.height * g.quantity, 0);
                    const productGlassAreaM2 = (productGlassAreaMm2 / 1000000).toFixed(2);
                    
                    const productFilmAreaMm2 = filmWidth * productFilmLengthMm;
                    const productFilmAreaM2 = (productFilmAreaMm2 / 1000000).toFixed(2);
                    
                    const productUtilization = ((productGlassAreaMm2 / productFilmAreaMm2) * 100).toFixed(2);
                    
                    const productWasteRate = (100 - parseFloat(productUtilization)).toFixed(2);
                    
                    return `
                        <div class="border-4 rounded-xl p-4" style="border-color: ${productColor.bg.match(/#[0-9a-f]{6}/gi)?.[0] || '#e0e0e0'};">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold flex items-center">
                                    <span class="px-3 py-1.5 rounded-lg text-white mr-2" style="background: ${productColor.bg}; font-size: 0.95rem;">
                                        ã€${pr.product}ã€‘
                                    </span>
                                    <span style="color: var(--secondary-gray); font-size: 0.95rem;">${productGlassCount}å—ç»ç’ƒ</span>
                                </h3>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                                <div class="bg-gray-200 rounded-lg p-3 border border-gray-300">
                                    <div class="font-semibold mb-1.5" style="color: #373737; font-size: 0.7rem; line-height: 1.1;">å¼€å·æ•°</div>
                                    <div class="font-bold" style="color: #373737; font-size: 1.3rem; line-height: 1.2;">${productRollCount}<span style="font-size: 0.8rem; margin-left: 0.2rem;">å·</span></div>
                                </div>
                                <div class="bg-gray-200 rounded-lg p-3 border border-gray-300">
                                    <div class="font-semibold mb-1.5" style="color: #373737; font-size: 0.7rem; line-height: 1.1;">ææ–™åˆ©ç”¨ç‡</div>
                                    <div class="font-bold" style="color: #373737; font-size: 1.3rem; line-height: 1.2;">${productUtilization}<span style="font-size: 0.8rem; margin-left: 0.2rem;">%</span></div>
                                </div>
                                <div class="bg-gray-200 rounded-lg p-3 border border-gray-300">
                                    <div class="font-semibold mb-1.5" style="color: #373737; font-size: 0.7rem; line-height: 1.1;">ææ–™æŸè€—ç‡</div>
                                    <div class="font-bold" style="color: #373737; font-size: 1.3rem; line-height: 1.2;">${productWasteRate}<span style="font-size: 0.8rem; margin-left: 0.2rem;">%</span></div>
                                </div>
                                <div class="bg-gray-200 rounded-lg p-3 border border-gray-300">
                                    <div class="font-semibold mb-1.5" style="color: #373737; font-size: 0.7rem; line-height: 1.1;">ç»ç’ƒé¢ç§¯</div>
                                    <div class="font-bold" style="color: #373737; font-size: 1.3rem; line-height: 1.2;">${productGlassAreaM2}<span style="font-size: 0.8rem; margin-left: 0.2rem;">mÂ²</span></div>
                                </div>
                                <div class="bg-gray-200 rounded-lg p-3 border border-gray-300">
                                    <div class="font-semibold mb-1.5" style="color: #373737; font-size: 0.7rem; line-height: 1.1;">å®é™…ç”¨è†œé•¿åº¦</div>
                                    <div class="font-bold" style="color: #373737; font-size: 1.3rem; line-height: 1.2;">${productFilmLengthM}<span style="font-size: 0.8rem; margin-left: 0.2rem;">m</span></div>
                                </div>
                                <div class="bg-gray-200 rounded-lg p-3 border border-gray-300">
                                    <div class="font-semibold mb-1.5" style="color: #373737; font-size: 0.7rem; line-height: 1.1;">å®é™…ç”¨è†œé¢ç§¯</div>
                                    <div class="font-bold" style="color: #373737; font-size: 1.3rem; line-height: 1.2;">${productFilmAreaM2}<span style="font-size: 0.8rem; margin-left: 0.2rem;">mÂ²</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                productStatsDiv.innerHTML = '<div class="text-center text-gray-500 py-8">æ— äº§å“åˆ†ç±»æ•°æ®</div>';
            }
            
            window.optimizationLog = result.logMessages;
            window.optimizationResult = result;
            
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadLog() {
            if (!window.optimizationLog || !window.optimizationResult) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ—¥å¿—æ•°æ®');
                return;
            }
            
            let logText = '========================================\n';
            logText += 'ç»ç’ƒè´´è†œä¼˜åŒ–ç³»ç»Ÿ - è¯¦ç»†è®¡ç®—æ—¥å¿—\n';
            logText += '========================================\n\n';
            
            logText += 'é¡¹ç›®ä¿¡æ¯:\n';
            logText += `é¡¹ç›®åç§°:${document.getElementById('projectName').value || 'æœªå¡«å†™'}\n`;
            logText += `ä¸šä¸»å§“å:${document.getElementById('ownerName').value || 'æœªå¡«å†™'}\n`;
            logText += `è”ç³»æ–¹å¼:${document.getElementById('contactPhone').value || 'æœªå¡«å†™'}\n`;
            logText += `é¡¹ç›®åœ°å€:${document.getElementById('projectAddress').value || 'æœªå¡«å†™'}\n`;
            logText += `ç”Ÿæˆæ—¶é—´:${new Date().toLocaleString('zh-CN')}\n\n`;
            
            logText += '========================================\n';
            logText += 'è¾“å…¥æ•°æ®\n';
            logText += '========================================\n\n';
            glasses.forEach((g, i) => {
                logText += `${i + 1}. ${g.id} - ${g.product}\n`;
                logText += `   æ¥¼å±‚:${g.floor} | æˆ¿é—´:${g.room} | çª—æˆ·:${g.windowId} | æœå‘:${g.direction}\n`;
                logText += `   å°ºå¯¸:${g.width}Ã—${g.height}mm | æ•°é‡:${g.quantity}ç‰‡\n\n`;
            });
            
            logText += '========================================\n';
            logText += 'è¯¦ç»†è®¡ç®—è¿‡ç¨‹\n';
            logText += '========================================\n\n';
            window.optimizationLog.forEach(msg => {
                logText += msg.message + '\n';
            });
            
            logText += '\n========================================\n';
            logText += 'æœ€ç»ˆç»“æœç»Ÿè®¡\n';
            logText += '========================================\n\n';
            logText += `æ€»ä½“ç»Ÿè®¡:\n`;
            logText += `  ç»ç’ƒæ€»æ•°:${document.getElementById('totalGlassCount').textContent}å—\n`;
            logText += `  äº§å“ç±»å‹æ•°:${document.getElementById('productTypeCount').textContent}ç§\n`;
            logText += `  æ€»å¼€å·æ•°:${document.getElementById('totalRollCount').textContent}å·\n`;
            logText += `  å·æåˆ©ç”¨ç‡:${document.getElementById('rollUtilization').textContent}%\n`;
            logText += `  å·ææŸè€—ç‡:${document.getElementById('materialWasteRate').textContent}%\n`;
            logText += `  ç»ç’ƒæ€»é¢ç§¯:${document.getElementById('totalGlassArea').textContent}mÂ²\n`;
            logText += `  è†œææ€»é¢ç§¯:${document.getElementById('totalFilmArea').textContent}mÂ²\n`;
            logText += `  å®é™…ç”¨è†œæ€»é•¿åº¦:${document.getElementById('totalFilmLength').textContent}m\n\n`;
            
            if (window.optimizationResult.productResults) {
                logText += `äº§å“åˆ†ç±»ç»Ÿè®¡:\n`;
                window.optimizationResult.productResults.forEach(pr => {
                    logText += `\nã€${pr.product}ã€‘\n`;
                    logText += `  ç»ç’ƒæ•°é‡:${pr.glassCount}å—\n`;
                    logText += `  æ®µæ•°:${pr.segments.length}æ®µ\n`;
                    logText += `  æ€»é•¿åº¦:${(pr.totalLength/1000).toFixed(2)}m\n`;
                    logText += `  åˆ©ç”¨ç‡:${pr.utilization}%\n`;
                });
            }
            
            const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç»ç’ƒè´´è†œä¼˜åŒ–æ—¥å¿—_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ==================== æ•°æ®å¯¼å…¥åŠŸèƒ½ ====================
        
        // æ˜¾ç¤ºå¯¼å…¥æ¨¡æ€æ¡†
        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importTextarea').value = '';
            document.getElementById('importPreview').classList.add('hidden');
            document.getElementById('importAppendMode').checked = false;
            document.getElementById('importSkipHeader').checked = false;
        }
        
        // å…³é—­å¯¼å…¥æ¨¡æ€æ¡†
        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }
        
        // ä¸‹è½½Excelæ¨¡æ¿
        function downloadTemplate() {
            // ä½¿ç”¨é€—å·åˆ†éš”ï¼Œå¹¶ä¸”æ¯ä¸ªå­—æ®µç”¨åŒå¼•å·åŒ…è£¹ï¼Œè¿™æ ·Excelèƒ½æ­£ç¡®è¯†åˆ«
            const headers = '"æ¥¼å±‚","æˆ¿é—´/åŒºåŸŸ","çª—æˆ·ç¼–å·","æœå‘","å®½åº¦(mm)","é«˜åº¦(mm)","äº§å“ç±»å‹","æ•°é‡"';
            const rows = [
                '"ä¸€æ¥¼","å®¢å…","è¥¿çª—1","è¥¿","1500","2000","æ™¨æ›¦","2"',
                '"ä¸€æ¥¼","é¤å…","A1","å—","1200","1800","æš®è¯­","1"',
                '"äºŒæ¥¼","ä¸»å§","B1","ä¸œ","800","1000","æ™ºå¹•Pro30","4"',
                '"äºŒæ¥¼","ä¹¦æˆ¿","C1","åŒ—","1520","2400","æ™ºå¹•Pro70","1"'
            ];
            const templateContent = headers + '\n' + rows.join('\n');
            
            // æ·»åŠ BOMå¤´ï¼Œç¡®ä¿Excelæ­£ç¡®è¯†åˆ«UTF-8ç¼–ç 
            const blob = new Blob(['\ufeff' + templateContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ç»ç’ƒæ•°æ®å¯¼å…¥æ¨¡æ¿.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // è§£æç²˜è´´çš„æ•°æ®
        function parseImportData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() && !line.trim().startsWith('#'));
            const skipHeader = document.getElementById('importSkipHeader').checked;
            
            const startIndex = skipHeader ? 1 : 0;
            const results = [];
            const errors = [];
            
            const productMap = {
                'æ™¨æ›¦': 'æ™¨æ›¦',
                'æš®è¯­': 'æš®è¯­',
                'æ™ºå¹•pro30': 'æ™ºå¹•Pro30',
                'æ™ºå¹•Pro30': 'æ™ºå¹•Pro30',
                'æ™ºå¹•pro70': 'æ™ºå¹•Pro70',
                'æ™ºå¹•Pro70': 'æ™ºå¹•Pro70',
                'å…¶ä»–': 'å…¶ä»–'
            };
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // å°è¯•Tabåˆ†éš”ï¼Œç„¶åå°è¯•é€—å·åˆ†éš”
                let cols = line.split('\t');
                if (cols.length < 4) {
                    cols = line.split(',');
                }
                
                // å»é™¤æ¯åˆ—çš„ç©ºæ ¼å’Œå¼•å·
                cols = cols.map(c => c.trim().replace(/^["']|["']$/g, ''));
                
                let glassData = null;
                
                if (cols.length >= 8) {
                    // å®Œæ•´æ ¼å¼ï¼šæ¥¼å±‚ | æˆ¿é—´ | çª—æˆ·ç¼–å· | æœå‘ | å®½åº¦ | é«˜åº¦ | äº§å“ | æ•°é‡
                    glassData = {
                        floor: cols[0] || '-',
                        room: cols[1] || '-',
                        windowId: cols[2],
                        direction: cols[3] || '-',
                        width: parseInt(cols[4]),
                        height: parseInt(cols[5]),
                        product: productMap[cols[6]] || cols[6],
                        quantity: parseInt(cols[7]) || 1
                    };
                } else if (cols.length >= 7) {
                    // 7åˆ—æ ¼å¼ï¼šæ¥¼å±‚ | æˆ¿é—´ | çª—æˆ·ç¼–å· | æœå‘ | å®½åº¦ | é«˜åº¦ | äº§å“
                    glassData = {
                        floor: cols[0] || '-',
                        room: cols[1] || '-',
                        windowId: cols[2],
                        direction: cols[3] || '-',
                        width: parseInt(cols[4]),
                        height: parseInt(cols[5]),
                        product: productMap[cols[6]] || cols[6],
                        quantity: 1
                    };
                } else if (cols.length >= 6) {
                    // 6åˆ—æ ¼å¼ï¼šæ¥¼å±‚ | æˆ¿é—´ | çª—æˆ·ç¼–å· | å®½åº¦ | é«˜åº¦ | äº§å“
                    glassData = {
                        floor: cols[0] || '-',
                        room: cols[1] || '-',
                        windowId: cols[2],
                        direction: '-',
                        width: parseInt(cols[3]),
                        height: parseInt(cols[4]),
                        product: productMap[cols[5]] || cols[5],
                        quantity: 1
                    };
                } else if (cols.length >= 5) {
                    // 5åˆ—æ ¼å¼ï¼šçª—æˆ·ç¼–å· | å®½åº¦ | é«˜åº¦ | äº§å“ | æ•°é‡
                    glassData = {
                        floor: '-',
                        room: '-',
                        windowId: cols[0],
                        direction: '-',
                        width: parseInt(cols[1]),
                        height: parseInt(cols[2]),
                        product: productMap[cols[3]] || cols[3],
                        quantity: parseInt(cols[4]) || 1
                    };
                } else if (cols.length >= 4) {
                    // ç®€åŒ–æ ¼å¼ï¼šçª—æˆ·ç¼–å· | å®½åº¦ | é«˜åº¦ | äº§å“
                    glassData = {
                        floor: '-',
                        room: '-',
                        windowId: cols[0],
                        direction: '-',
                        width: parseInt(cols[1]),
                        height: parseInt(cols[2]),
                        product: productMap[cols[3]] || cols[3],
                        quantity: 1
                    };
                } else {
                    errors.push(`ç¬¬${i + 1}è¡Œ: åˆ—æ•°ä¸è¶³ï¼Œè‡³å°‘éœ€è¦4åˆ—ï¼ˆçª—æˆ·ç¼–å·ã€å®½åº¦ã€é«˜åº¦ã€äº§å“ï¼‰`);
                    continue;
                }
                
                // éªŒè¯æ•°æ®
                if (!glassData.windowId) {
                    errors.push(`ç¬¬${i + 1}è¡Œ: ç¼ºå°‘çª—æˆ·ç¼–å·`);
                    continue;
                }
                if (!glassData.width || isNaN(glassData.width) || glassData.width <= 0) {
                    errors.push(`ç¬¬${i + 1}è¡Œ: å®½åº¦æ— æ•ˆ "${cols[cols.length >= 6 ? 4 : 1]}"`);
                    continue;
                }
                if (!glassData.height || isNaN(glassData.height) || glassData.height <= 0) {
                    errors.push(`ç¬¬${i + 1}è¡Œ: é«˜åº¦æ— æ•ˆ "${cols[cols.length >= 6 ? 5 : 2]}"`);
                    continue;
                }
                if (!glassData.product || !productMap[glassData.product]) {
                    // å¦‚æœäº§å“ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œè®¾ä¸º"å…¶ä»–"
                    if (glassData.product) {
                        glassData.product = 'å…¶ä»–';
                    } else {
                        errors.push(`ç¬¬${i + 1}è¡Œ: ç¼ºå°‘äº§å“ç±»å‹`);
                        continue;
                    }
                }
                
                // ç”ŸæˆID
                if (glassData.floor !== '-' && glassData.room !== '-' && glassData.windowId) {
                    glassData.id = `${glassData.floor.replace('æ¥¼', '')}-${glassData.room}-${glassData.windowId}`;
                } else {
                    glassData.id = glassData.windowId;
                }
                
                results.push(glassData);
            }
            
            return { results, errors };
        }
        
        // é¢„è§ˆå¯¼å…¥æ•°æ®
        function previewImportData() {
            const text = document.getElementById('importTextarea').value;
            if (!text.trim()) {
                alert('è¯·å…ˆç²˜è´´æ•°æ®ï¼');
                return;
            }
            
            const { results, errors } = parseImportData(text);
            
            const previewDiv = document.getElementById('importPreview');
            const contentDiv = document.getElementById('importPreviewContent');
            const statsDiv = document.getElementById('importPreviewStats');
            
            if (results.length === 0 && errors.length > 0) {
                contentDiv.innerHTML = `
                    <div class="p-4 bg-red-50 text-red-700">
                        <h5 class="font-bold mb-2">âŒ è§£æå¤±è´¥</h5>
                        <ul class="text-sm list-disc list-inside">
                            ${errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                `;
                statsDiv.innerHTML = '';
                previewDiv.classList.remove('hidden');
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            let tableHTML = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="px-2 py-1 text-left">æ¥¼å±‚</th>
                            <th class="px-2 py-1 text-left">æˆ¿é—´</th>
                            <th class="px-2 py-1 text-left">çª—æˆ·ç¼–å·</th>
                            <th class="px-2 py-1 text-left">æœå‘</th>
                            <th class="px-2 py-1 text-right">å®½åº¦</th>
                            <th class="px-2 py-1 text-right">é«˜åº¦</th>
                            <th class="px-2 py-1 text-left">äº§å“</th>
                            <th class="px-2 py-1 text-right">æ•°é‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach((g, i) => {
                const productColor = productColors[g.product] || productColors['-'];
                tableHTML += `
                    <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-2 py-1">${g.floor}</td>
                        <td class="px-2 py-1">${g.room}</td>
                        <td class="px-2 py-1 font-semibold">${g.windowId}</td>
                        <td class="px-2 py-1">${g.direction}</td>
                        <td class="px-2 py-1 text-right font-mono">${g.width}</td>
                        <td class="px-2 py-1 text-right font-mono">${g.height}</td>
                        <td class="px-2 py-1">
                            <span class="px-2 py-0.5 rounded text-xs" style="background: ${productColor.bg}; color: ${productColor.text};">${g.product}</span>
                        </td>
                        <td class="px-2 py-1 text-right">${g.quantity}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            contentDiv.innerHTML = tableHTML;
            
            // ç»Ÿè®¡ä¿¡æ¯
            const totalPieces = results.reduce((sum, g) => sum + g.quantity, 0);
            let statsHTML = `<span class="text-green-600 font-semibold">âœ… æˆåŠŸè§£æ ${results.length} æ¡è®°å½•ï¼Œå…± ${totalPieces} ç‰‡ç»ç’ƒ</span>`;
            
            if (errors.length > 0) {
                statsHTML += `<span class="text-orange-500 ml-4">âš ï¸ ${errors.length} æ¡è®°å½•æœ‰é—®é¢˜è¢«è·³è¿‡</span>`;
            }
            
            statsDiv.innerHTML = statsHTML;
            previewDiv.classList.remove('hidden');
        }
        
        // ç¡®è®¤å¯¼å…¥æ•°æ®
        function confirmImportData() {
            const text = document.getElementById('importTextarea').value;
            if (!text.trim()) {
                alert('è¯·å…ˆç²˜è´´æ•°æ®ï¼');
                return;
            }
            
            const { results, errors } = parseImportData(text);
            
            if (results.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„æœ‰æ•ˆæ•°æ®ï¼\n\n' + errors.join('\n'));
                return;
            }
            
            const appendMode = document.getElementById('importAppendMode').checked;
            
            if (!appendMode) {
                window.glasses = [];
                window.selectedPlans = {};
            }
            
            // æ·»åŠ æ•°æ®
            results.forEach(g => {
                window.glasses.push(g);
            });
            
            updateGlassList();
            closeImportModal();
            
            const totalPieces = results.reduce((sum, g) => sum + g.quantity, 0);
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${results.length} æ¡è®°å½•ï¼Œå…± ${totalPieces} ç‰‡ç»ç’ƒï¼`);
        }
        
        // å¤„ç†æ–‡ä»¶å¯¼å…¥ï¼ˆExcel/CSVï¼‰
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                // CSVæ–‡ä»¶ç›´æ¥è¯»å–
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('importTextarea').value = e.target.result;
                    showImportModal();
                    document.getElementById('importSkipHeader').checked = true;
                    previewImportData();
                };
                reader.readAsText(file, 'UTF-8');
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Excelæ–‡ä»¶éœ€è¦ä½¿ç”¨SheetJSåº“
                alert('æ­£åœ¨åŠ è½½Excelè§£æåº“ï¼Œè¯·ç¨å€™...');
                
                // åŠ¨æ€åŠ è½½SheetJS
                if (typeof XLSX === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                    script.onload = function() {
                        processExcelFile(file);
                    };
                    script.onerror = function() {
                        alert('Excelè§£æåº“åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å°†Excelå¦å­˜ä¸ºCSVæ ¼å¼åå¯¼å…¥ã€‚');
                    };
                    document.head.appendChild(script);
                } else {
                    processExcelFile(file);
                }
            } else {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·ä½¿ç”¨ .xlsxã€.xls æˆ– .csv æ–‡ä»¶ã€‚');
            }
            
            // æ¸…ç©ºfile inputä»¥ä¾¿é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }
        
        // å¤„ç†Excelæ–‡ä»¶
        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // è½¬æ¢ä¸ºCSVæ ¼å¼
                    const csv = XLSX.utils.sheet_to_csv(firstSheet, { FS: '\t' });
                    
                    document.getElementById('importTextarea').value = csv;
                    showImportModal();
                    document.getElementById('importSkipHeader').checked = true;
                    previewImportData();
                } catch (error) {
                    console.error('Excelè§£æé”™è¯¯:', error);
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼\n\nè¯·å°è¯•å°†Excelå¦å­˜ä¸ºCSVæ ¼å¼åå¯¼å…¥ã€‚');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ==================== æ•°æ®å¯¼å…¥åŠŸèƒ½ç»“æŸ ====================
        
        window.addGlass = addGlass;
        window.editGlass = editGlass;
        window.cancelEdit = cancelEdit;
        window.removeGlass = removeGlass;
        window.clearAll = clearAll;
        window.loadExample1 = loadExample1;
        window.loadExample2 = loadExample2;
        window.loadExample3 = loadExample3;
        window.loadTestCase = loadTestCase;
        window.runOptimization = runOptimization;
        window.exportPDF = exportPDF;
        window.printReport = printReport;
        window.selectSinglePlan = selectSinglePlan;
        window.selectPlanForGlassInList = selectPlanForGlassInList;
        window.closePlanModal = closePlanModal;
        window.downloadLog = downloadLog;
        
        // æ•°æ®å¯¼å…¥ç›¸å…³å‡½æ•°
        window.showImportModal = showImportModal;
        window.closeImportModal = closeImportModal;
        window.downloadTemplate = downloadTemplate;
        window.previewImportData = previewImportData;
        window.confirmImportData = confirmImportData;
        window.handleFileImport = handleFileImport;
        
        updateGlassList();
    </script>

    <!-- ==================== è®¤è¯åŠŸèƒ½æ¡¥æ¥ä»£ç  ==================== -->
    <script>
        // ç­‰å¾…AppAuthåŠ è½½å®Œæˆåå†åˆ›å»ºæ¡¥æ¥å‡½æ•°
        function initAuthBridge() {
            // æ¡¥æ¥å‡½æ•°ï¼šä½¿app.jsçš„å‡½æ•°å¯åœ¨HTMLä¸­è°ƒç”¨
            window.showAuthModal = function(tab) {
                if (window.AppAuth && window.AppAuth.showAuthModal) {
                    window.AppAuth.showAuthModal(tab);
                } else {
                    console.error('AppAuthæœªåŠ è½½');
                }
            };
            
            window.showHistoryModal = function() {
                if (window.AppAuth && window.AppAuth.showHistoryModal) {
                    window.AppAuth.showHistoryModal();
                }
            };
            
            window.showSaveModal = function() {
                if (window.AppAuth && window.AppAuth.showSaveModal) {
                    window.AppAuth.showSaveModal();
                }
            };
            
            window.logoutUser = function() {
                if (window.AppAuth && window.AppAuth.logoutUser) {
                    window.AppAuth.logoutUser();
                }
            };
            
            window.closeModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                }
            };
            
            window.closeAuthModal = function() {
                closeModal('authModal');
            };
            
            window.closeHistoryModal = function() {
                closeModal('historyModal');
            };
            
            window.closeSaveModal = function() {
                closeModal('saveModal');
            };
            
            // åˆå§‹åŒ–ç™»å½•çŠ¶æ€æ£€æŸ¥
            if (window.AppAuth && window.AppAuth.checkLoginStatus) {
                setTimeout(function() {
                    window.AppAuth.checkLoginStatus();
                }, 200);
            }
        }
        
        // ç«‹å³å°è¯•åˆå§‹åŒ–ï¼Œå¦‚æœAppAuthè¿˜æœªåŠ è½½ï¼Œåˆ™è®¾ç½®å®šæ—¶å™¨æ£€æŸ¥
        if (window.AppAuth) {
            initAuthBridge();
        } else {
            // ç­‰å¾…AppAuthåŠ è½½
            let attempts = 0;
            const checkAuth = setInterval(function() {
                attempts++;
                if (window.AppAuth || attempts > 50) {
                    clearInterval(checkAuth);
                    if (window.AppAuth) {
                        initAuthBridge();
                    }
                }
            }, 100);
        }
    </script>

    <!-- ==================== è®¤è¯æ¨¡æ€æ¡† ==================== -->
    
    <!-- è®¤è¯æ¨¡æ€æ¡†ï¼ˆç™»å½•/æ³¨å†Œï¼‰ -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[95vh] overflow-y-auto relative">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="authModalClose" class="absolute top-4 right-4 text-white hover:text-gray-200 z-20">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <div class="bg-primary-gradient text-white p-6 rounded-t-2xl">
                <div class="flex justify-center gap-8">
                    <button id="loginTab" class="text-lg font-bold border-b-2 border-white pb-2">ç™»å½•</button>
                    <button id="registerTab" class="text-lg font-bold border-b-2 border-transparent pb-2 opacity-80">æ³¨å†Œ</button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- ç™»å½•è¡¨å• -->
                <form id="loginFormElement">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">å¯†ç </label>
                        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    <button type="submit" class="w-full bg-primary-red text-white font-bold py-3 px-4 rounded-lg transition hover:bg-primary-red-dark">
                        ç™»å½•
                    </button>
                </form>
                
                <!-- æ³¨å†Œè¡¨å• -->
                <form id="registerFormElement" class="hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">ç”¨æˆ·å</label>
                        <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">å¯†ç </label>
                        <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="registerPasswordConfirm" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                    </div>
                    <button type="submit" class="w-full bg-primary-red text-white font-bold py-3 px-4 rounded-lg transition hover:bg-primary-red-dark">
                        æ³¨å†Œ
                    </button>
                </form>
                
                <!-- é”™è¯¯æç¤º -->
                <div id="authError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-center"></div>
            </div>
        </div>
    </div>
    
    <!-- ä¿å­˜é¡¹ç›®æ¨¡æ€æ¡† -->
    <div id="saveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full relative">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="saveModalClose" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <div class="bg-primary-gradient text-white p-6 rounded-t-2xl">
                <h2 class="text-2xl font-bold text-center">ä¿å­˜é¡¹ç›®</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">é¡¹ç›®åç§°</label>
                    <input type="text" id="saveProjectName" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2" style="color: var(--secondary-gray);">é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="saveProjectDescription" placeholder="è¯·è¾“å…¥é¡¹ç›®æè¿°" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg input-focus" rows="3"></textarea>
                </div>
                <div id="saveError" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-center"></div>
            </div>
            
            <div class="p-4 border-t border-gray-200 flex gap-4">
                <button onclick="closeModal('saveModal')" class="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                    å–æ¶ˆ
                </button>
                <button id="saveAndNewBtn" class="flex-1 bg-white text-primary-red font-semibold py-2 px-4 rounded-lg border-2 border-primary-red hover:bg-red-50 transition">
                    ä¿å­˜å¹¶æ–°å»º
                </button>
                <button id="saveConfirmBtn" class="flex-1 bg-primary-red text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary-red-dark transition">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>
    
    <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto relative">
            <div class="sticky top-0 bg-primary-red text-white p-6 rounded-t-2xl z-10 flex justify-between items-center">
                <h2 class="text-2xl font-bold">æˆ‘çš„é¡¹ç›®</h2>
                <button id="historyModalClose" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <div id="projectListContainer" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
    
    <!-- å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½ -->
    <script>
        // å¯¼å‡ºæŒ‡å®šåŒºåŸŸä¸ºå›¾ç‰‡
        async function exportToImage(elementId, title) {
            const element = document.getElementById(elementId);
            if (!element) {
                alert('æœªæ‰¾åˆ°è¦å¯¼å‡ºçš„åŒºåŸŸ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ å¯¼å‡ºä¸­...';
            btn.disabled = true;
            
            try {
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©æŒ‰é’®çŠ¶æ€æ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // ä½¿ç”¨html2canvaså°†å…ƒç´ è½¬æ¢ä¸ºcanvas
                const canvas = await html2canvas(element, {
                    scale: 2,                    // æé«˜å¯¼å‡ºå›¾ç‰‡çš„æ¸…æ™°åº¦
                    useCORS: true,               // å…è®¸è·¨åŸŸå›¾ç‰‡
                    allowTaint: true,            // å…è®¸æ±¡æŸ“canvas
                    backgroundColor: '#ffffff', // èƒŒæ™¯è‰²
                    logging: false,              // å…³é—­æ—¥å¿—
                    width: element.scrollWidth,  // å…ƒç´ å®½åº¦
                    height: element.scrollHeight // å…ƒç´ é«˜åº¦
                });
                
                // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡æ•°æ®
                const imageData = canvas.toDataURL('image/png');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-');
                link.download = `${title}_${timestamp}.png`;
                link.href = imageData;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                btn.innerHTML = 'âœ… å·²å¯¼å‡º';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥:', error);
                alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯ä¿¡æ¯: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // æ›´æ–°ä½™æ–™åˆ—è¡¨æ˜¾ç¤º
        function updateScrapList() {
            const scrapListDiv = document.getElementById('scrapList');
            if (!scrapListDiv) return;
            
            // ä»ä¼˜åŒ–ç»“æœä¸­è·å–ä½™æ–™ä¿¡æ¯
            if (window.optimizationResult && window.optimizationResult.segments) {
                const scraps = [];
                window.optimizationResult.segments.forEach((seg, idx) => {
                    if (seg.scrapWidth && seg.scrapHeight && 
                        seg.scrapWidth >= 200 && seg.scrapHeight >= 200) {
                        const isUsable = seg.scrapWidth >= 200 && seg.scrapHeight >= 200;
                        scraps.push({
                            id: `ä½™æ–™${idx + 1}`,
                            width: seg.scrapWidth,
                            height: seg.scrapHeight,
                            area: (seg.scrapWidth * seg.scrapHeight / 1000000).toFixed(3),
                            usable: isUsable,
                            glassIds: seg.scrapGlassIds || [],
                            product: seg.product || 'é€šç”¨'
                        });
                    }
                });
                
                if (scraps.length > 0) {
                    scrapListDiv.innerHTML = scraps.map(scrap => `
                        <div class="border-2 rounded-xl p-4 ${scrap.usable ? 'border-green-400 bg-green-50' : 'border-gray-300 bg-gray-100'}">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold ${scrap.usable ? 'text-green-700' : 'text-gray-600'}">
                                    ${scrap.id} - ${scrap.product}
                                </h4>
                                <span class="px-2 py-1 rounded text-xs font-bold ${scrap.usable ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-600'}">
                                    ${scrap.usable ? 'å¯åˆ©ç”¨' : 'åºŸæ–™'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                <div class="bg-white rounded p-2 border">
                                    <div class="text-gray-500 text-xs">è§„æ ¼</div>
                                    <div class="font-semibold">${scrap.width}Ã—${scrap.height}mm</div>
                                </div>
                                <div class="bg-white rounded p-2 border">
                                    <div class="text-gray-500 text-xs">å¯åˆ©ç”¨é¢ç§¯</div>
                                    <div class="font-semibold">${scrap.area}mÂ²</div>
                                </div>
                                <div class="bg-white rounded p-2 border">
                                    <div class="text-gray-500 text-xs">å·²åˆ©ç”¨ç»ç’ƒ</div>
                                    <div class="font-semibold">${scrap.glassIds.length > 0 ? scrap.glassIds.join(', ') : 'æš‚æ— '}</div>
                                </div>
                                <div class="bg-white rounded p-2 border">
                                    <div class="text-gray-500 text-xs">åˆ©ç”¨å»ºè®®</div>
                                    <div class="font-semibold text-xs">${scrap.usable ? 'å¯ç”¨äºåŒäº§å“å°ç»ç’ƒ' : 'å°ºå¯¸è¿‡å°,å»ºè®®åºŸå¼ƒ'}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    return;
                }
            }
            
            scrapListDiv.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— ä½™æ–™æ•°æ®</div>';
        }
        
        // åœ¨displayResultså‡½æ•°ä¸­è°ƒç”¨updateScrapList
        const originalDisplayResults = window.displayResults;
        if (originalDisplayResults) {
            window.displayResults = function(result) {
                originalDisplayResults(result);
                setTimeout(updateScrapList, 100);
            };
        }
    </script>
